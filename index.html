<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ê¸´ê¸´ë°¤ - The Long, Long Night</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
:root{
--bg-primary:#0a0a12;--bg-secondary:#12121f;--bg-tertiary:#1a1a2e;
--text-primary:#e8e8f0;--text-secondary:#a0a0b8;--text-accent:#f0d080;
--ui-border:#2a2a4a;--ui-panel:rgba(10,10,18,0.92);
--hope-color:#f0d080;--danger-color:#c04040;
--skin-name:"ë°¤";
}
[data-skin="twilight"]{
--bg-primary:#1a0a2a;--bg-secondary:#2a1a3a;--bg-tertiary:#3a2a4a;
--text-primary:#e8d8f0;--text-secondary:#b8a0c8;--text-accent:#e0a0f0;
--ui-border:#4a3a5a;--ui-panel:rgba(26,10,42,0.92);
--hope-color:#e0a0f0;--skin-name:"í™©í˜¼";
}
[data-skin="winter"]{
--bg-primary:#0a1a2a;--bg-secondary:#0a2040;--bg-tertiary:#103050;
--text-primary:#d8e8f8;--text-secondary:#90b0d0;--text-accent:#80d0f0;
--ui-border:#2a4a6a;--ui-panel:rgba(10,26,42,0.92);
--hope-color:#80d0f0;--skin-name:"ê²¨ìš¸";
}
[data-skin="sakura"]{
--bg-primary:#2a1a1a;--bg-secondary:#3a2028;--bg-tertiary:#4a2830;
--text-primary:#f8e0e0;--text-secondary:#d0a0a8;--text-accent:#f0a0b0;
--ui-border:#5a3840;--ui-panel:rgba(42,26,26,0.92);
--hope-color:#f0a0b0;--skin-name:"ë²šê½ƒ";
}
[data-skin="oldbook"]{
--bg-primary:#1a1810;--bg-secondary:#2a2618;--bg-tertiary:#3a3420;
--text-primary:#e8e0d0;--text-secondary:#b8b098;--text-accent:#d0b060;
--ui-border:#4a4430;--ui-panel:rgba(26,24,16,0.92);
--hope-color:#d0b060;--skin-name:"ì˜¤ë˜ëœ ì±…";
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg-primary);color:var(--text-primary);font-family:'Noto Sans KR',sans-serif;overflow:hidden;width:100vw;height:100vh;touch-action:none;user-select:none;-webkit-user-select:none;}
#game{position:relative;width:100vw;height:100vh;overflow:hidden;}
#mobile-notice{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:var(--bg-primary);z-index:999;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px;}
#mobile-notice .mn-icon{font-size:48px;margin-bottom:20px;}
#mobile-notice .mn-title{font-family:'Noto Serif KR',serif;font-size:22px;color:var(--text-primary);margin-bottom:12px;}
#mobile-notice .mn-desc{font-size:14px;color:var(--text-secondary);line-height:1.6;}
@media(max-width:768px){#mobile-notice{display:flex;}#title-screen{display:none!important;}}
#scene{position:absolute;top:0;left:0;width:100%;height:100%;transition:opacity 0.5s;}
.scene-bg{position:absolute;top:0;left:0;width:100%;height:100%;}
/* HUD */
#hud{position:absolute;top:0;left:0;right:0;height:48px;display:flex;align-items:center;padding:0 16px;background:linear-gradient(180deg,rgba(0,0,0,0.6),transparent);z-index:50;pointer-events:none;}
#hud>*{pointer-events:auto;}
#chapter-label{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-secondary);margin-right:16px;}
#hope-bar-wrap{flex:1;max-width:200px;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin-right:8px;}
#hope-bar{height:100%;background:var(--hope-color);border-radius:4px;transition:width 0.8s ease;}
#hope-label{font-size:12px;color:var(--text-accent);margin-right:16px;min-width:30px;}
.hud-btn{background:none;border:1px solid var(--ui-border);color:var(--text-secondary);font-size:13px;padding:4px 10px;border-radius:4px;cursor:pointer;margin-left:6px;font-family:inherit;}
.hud-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);}
/* Dialogue */
#dialogue-box{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:min(90%,700px);background:var(--ui-panel);border:1px solid var(--ui-border);border-radius:12px;padding:20px 24px;z-index:60;display:none;backdrop-filter:blur(8px);}
#dialogue-speaker{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-accent);margin-bottom:8px;}
#dialogue-text{font-size:15px;line-height:1.7;color:var(--text-primary);min-height:48px;}
#dialogue-next{position:absolute;bottom:8px;right:16px;font-size:11px;color:var(--text-secondary);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
/* Choices */
#choices-box{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:min(90%,500px);z-index:65;display:none;flex-direction:column;gap:10px;}
.choice-btn{background:var(--ui-panel);border:1px solid var(--ui-border);color:var(--text-primary);font-size:15px;padding:14px 20px;border-radius:10px;cursor:pointer;font-family:inherit;text-align:left;transition:all 0.2s;backdrop-filter:blur(8px);}
.choice-btn:hover{background:var(--bg-tertiary);border-color:var(--text-accent);transform:translateX(4px);}
/* Inventory */
#inventory-panel{position:absolute;top:0;right:-320px;width:300px;height:100%;background:var(--ui-panel);border-left:1px solid var(--ui-border);z-index:80;transition:right 0.3s;padding:20px;overflow-y:auto;backdrop-filter:blur(8px);}
#inventory-panel.open{right:0;}
#inventory-panel h3{font-family:'Noto Serif KR',serif;color:var(--text-accent);margin-bottom:16px;font-size:18px;}
.inv-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--ui-border);border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);}
.inv-icon{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.inv-info{flex:1;}
.inv-name{font-size:13px;color:var(--text-primary);font-weight:700;}
.inv-desc{font-size:11px;color:var(--text-secondary);margin-top:2px;}
#inv-empty{color:var(--text-secondary);font-size:13px;font-style:italic;}
/* Easter egg panel */
#egg-panel{position:absolute;top:0;left:-320px;width:300px;height:100%;background:var(--ui-panel);border-right:1px solid var(--ui-border);z-index:80;transition:left 0.3s;padding:20px;overflow-y:auto;backdrop-filter:blur(8px);}
#egg-panel.open{left:0;}
#egg-panel h3{font-family:'Noto Serif KR',serif;color:var(--text-accent);margin-bottom:16px;font-size:18px;}
.egg-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--ui-border);border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);}
.egg-item.found{border-color:var(--text-accent);background:rgba(240,208,128,0.05);}
.egg-icon{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.egg-info{flex:1;}
.egg-name{font-size:13px;color:var(--text-primary);font-weight:700;}
.egg-hint{font-size:11px;color:var(--text-secondary);margin-top:2px;}
.egg-item:not(.found) .egg-icon{filter:grayscale(1) opacity(0.3);}
.egg-item:not(.found) .egg-name{color:var(--text-secondary);}
.egg-count{font-size:12px;color:var(--text-secondary);margin-bottom:12px;}
/* Skin panel */
#skin-panel{position:absolute;top:50px;right:10px;background:var(--ui-panel);border:1px solid var(--ui-border);border-radius:10px;padding:12px;z-index:90;display:none;backdrop-filter:blur(8px);}
.skin-option{display:block;width:100%;background:none;border:1px solid var(--ui-border);color:var(--text-primary);font-size:13px;padding:8px 14px;border-radius:6px;cursor:pointer;margin-bottom:4px;font-family:inherit;text-align:left;}
.skin-option:hover,.skin-option.active{background:var(--bg-tertiary);border-color:var(--text-accent);}
/* Multiplayer lobby */
#mp-lobby{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:210;display:none;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
#mp-lobby h3{font-family:'Noto Serif KR',serif;font-size:22px;color:var(--text-accent);margin-bottom:20px;}
.mp-btn{background:none;border:1px solid var(--ui-border);color:var(--text-primary);font-size:15px;padding:12px 32px;border-radius:10px;cursor:pointer;font-family:inherit;margin:6px;transition:all 0.2s;min-width:200px;}
.mp-btn:hover{border-color:var(--text-accent);background:rgba(240,208,128,0.08);}
#mp-room-code{font-family:'Noto Serif KR',serif;font-size:36px;color:var(--text-accent);letter-spacing:8px;margin:16px 0;}
#mp-input{background:var(--bg-tertiary);border:1px solid var(--ui-border);color:var(--text-primary);font-size:20px;padding:10px 16px;border-radius:8px;text-align:center;letter-spacing:6px;width:160px;font-family:inherit;outline:none;}
#mp-input:focus{border-color:var(--text-accent);}
#mp-status{font-size:13px;color:var(--text-secondary);margin-top:12px;}
#mp-back{font-size:12px;color:var(--text-secondary);cursor:pointer;margin-top:20px;border:none;background:none;font-family:inherit;}
#mp-back:hover{color:var(--text-primary);}
/* Multiplayer indicator */
#mp-indicator{position:absolute;top:52px;left:16px;font-size:11px;color:var(--text-secondary);z-index:55;display:none;}
/* Guest player */
.guest-sprite{width:56px;height:44px;position:relative;}
.guest-body{position:absolute;width:48px;height:30px;background:linear-gradient(135deg,#8a7a6a,#6a5a4a);border-radius:24px 20px 8px 8px;bottom:10px;left:4px;}
.guest-head{position:absolute;width:24px;height:20px;background:linear-gradient(135deg,#907a6a,#706050);border-radius:12px 14px 6px 10px;bottom:22px;left:38px;}
.guest-horn{position:absolute;width:6px;height:14px;background:linear-gradient(to top,#c0a060,#e0c880);border-radius:3px 3px 1px 1px;bottom:36px;left:48px;transform:rotate(-10deg);}
.guest-eye{position:absolute;width:4px;height:4px;background:#222;border-radius:50%;bottom:30px;left:50px;}
.guest-ear{position:absolute;width:8px;height:6px;background:#806a5a;border-radius:50% 50% 0 0;bottom:38px;left:40px;}
.guest-leg{position:absolute;width:8px;height:12px;background:#6a5a4a;border-radius:0 0 3px 3px;bottom:0;}
.guest-leg.fl{left:12px;}.guest-leg.fr{left:22px;}.guest-leg.bl{left:32px;}.guest-leg.br{left:40px;}
.guest-label{position:absolute;top:-16px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--hope-color);white-space:nowrap;}
.character.walking .guest-leg.fl,.character.walking .guest-leg.br{animation:legWalkA 0.35s infinite alternate;}
.character.walking .guest-leg.fr,.character.walking .guest-leg.bl{animation:legWalkB 0.35s infinite alternate;}
.character.face-left .guest-sprite{transform:scaleX(-1);}
/* Chat */
#chat-box{position:absolute;bottom:60px;left:10px;width:280px;z-index:75;display:none;pointer-events:none;}
#chat-box.open{pointer-events:auto;}
#chat-msgs{max-height:150px;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:3px;}
.chat-msg{font-size:12px;color:var(--text-primary);background:rgba(0,0,0,0.6);padding:4px 8px;border-radius:6px;backdrop-filter:blur(4px);animation:chatFadeIn 0.2s;word-break:break-word;pointer-events:none;}
.chat-msg .chat-name{color:var(--text-accent);font-weight:700;margin-right:4px;}
.chat-msg.system{color:var(--text-secondary);font-style:italic;}
@keyframes chatFadeIn{0%{opacity:0;transform:translateY(4px);}100%{opacity:1;transform:translateY(0);}}
#chat-input-wrap{display:none;margin-top:4px;}
#chat-input{width:100%;background:rgba(0,0,0,0.7);border:1px solid var(--ui-border);color:var(--text-primary);font-size:13px;padding:6px 10px;border-radius:6px;font-family:inherit;outline:none;backdrop-filter:blur(4px);}
#chat-input:focus{border-color:var(--text-accent);}
#chat-hint{font-size:10px;color:var(--text-secondary);opacity:0.6;margin-top:2px;text-align:right;pointer-events:none;}
/* Chapter overlay */
#chapter-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity 0.6s;}
#chapter-overlay.show{opacity:1;pointer-events:auto;}
#chapter-overlay .ch-num{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-secondary);letter-spacing:4px;margin-bottom:8px;}
#chapter-overlay .ch-title{font-family:'Noto Serif KR',serif;font-size:28px;color:var(--text-primary);margin-bottom:12px;}
#chapter-overlay .ch-sub{font-size:14px;color:var(--text-secondary);}
/* Cutscene */
#cutscene{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;z-index:95;opacity:0;pointer-events:none;transition:opacity 0.8s;}
#cutscene.show{opacity:1;pointer-events:auto;}
#cutscene-text{font-family:'Noto Serif KR',serif;font-size:20px;color:var(--text-primary);text-align:center;line-height:2;max-width:600px;padding:40px;}
/* Vignette */
#vignette{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:40;opacity:0;transition:opacity 1s;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,0.8) 100%);}
#vignette.show{opacity:1;}
/* Title screen */
#title-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#050510 0%,#0a0a1a 30%,#101028 55%,#1a1430 75%,#2a1828 90%,#1a1020 100%);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;}
#title-stars{position:absolute;top:0;left:0;width:100%;height:70%;pointer-events:none;}
#title-moon{position:absolute;top:12%;right:15%;width:60px;height:60px;background:radial-gradient(circle at 35% 35%,#f8f0d0,#e0d0a0,rgba(200,180,120,0.3));border-radius:50%;box-shadow:0 0 40px rgba(240,220,160,0.3),0 0 80px rgba(240,220,160,0.1);animation:moonGlow 4s ease-in-out infinite alternate;}
@keyframes moonGlow{0%{box-shadow:0 0 40px rgba(240,220,160,0.3),0 0 80px rgba(240,220,160,0.1);}100%{box-shadow:0 0 50px rgba(240,220,160,0.4),0 0 100px rgba(240,220,160,0.15);}}
#title-ground{position:absolute;bottom:0;left:0;width:100%;height:25%;background:linear-gradient(180deg,transparent 0%,rgba(20,16,12,0.6) 30%,#1a1410 60%,#141010 100%);pointer-events:none;}
#title-hills{position:absolute;bottom:8%;left:0;width:200%;height:120px;pointer-events:none;}
.title-hill{position:absolute;bottom:0;border-radius:50%;opacity:0.3;}
.title-hill:nth-child(1){left:-5%;width:40%;height:100px;background:#1a1820;}
.title-hill:nth-child(2){left:25%;width:50%;height:80px;background:#161520;}
.title-hill:nth-child(3){left:60%;width:45%;height:90px;background:#181622;}
#title-silhouettes{position:absolute;bottom:12%;left:50%;transform:translateX(-50%);display:flex;align-items:flex-end;gap:8px;pointer-events:none;opacity:0.7;animation:silFloat 3s ease-in-out infinite alternate;}
@keyframes silFloat{0%{transform:translateX(-50%) translateY(0);}100%{transform:translateX(-50%) translateY(-4px);}}
.sil-rhino{width:56px;height:44px;position:relative;}
.sil-rhino-body{position:absolute;width:48px;height:30px;background:#0a0a14;border-radius:24px 20px 8px 8px;bottom:10px;left:4px;}
.sil-rhino-head{position:absolute;width:24px;height:20px;background:#0a0a14;border-radius:12px 14px 6px 10px;bottom:22px;left:38px;}
.sil-rhino-horn{position:absolute;width:6px;height:14px;background:#0a0a14;border-radius:3px 3px 1px 1px;bottom:36px;left:48px;transform:rotate(-10deg);}
.sil-rhino-leg{position:absolute;width:8px;height:12px;background:#0a0a14;border-radius:0 0 3px 3px;bottom:0;}
.sil-rhino-leg:nth-child(4){left:12px;}.sil-rhino-leg:nth-child(5){left:22px;}.sil-rhino-leg:nth-child(6){left:32px;}.sil-rhino-leg:nth-child(7){left:40px;}
.sil-penguin{width:20px;height:26px;position:relative;}
.sil-penguin-body{position:absolute;width:16px;height:20px;background:#0a0a14;border-radius:8px 8px 5px 5px;bottom:4px;left:2px;}
.sil-penguin-head{position:absolute;width:12px;height:10px;background:#0a0a14;border-radius:50%;bottom:20px;left:4px;}
.sil-penguin-foot{position:absolute;width:7px;height:3px;background:#0a0a14;border-radius:0 0 4px 4px;bottom:0;}
.sil-penguin-foot:nth-child(3){left:1px;}.sil-penguin-foot:nth-child(4){left:10px;}
#title-content{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;margin-top:-60px;}
#title-content h1{font-family:'Noto Serif KR',serif;font-size:56px;color:#f0e8d8;margin-bottom:6px;letter-spacing:8px;text-shadow:0 0 30px rgba(240,220,160,0.3);animation:titleFade 2s ease-out forwards;}
#title-content .subtitle{font-size:15px;color:rgba(160,160,180,0.8);margin-bottom:10px;letter-spacing:3px;animation:titleFade 2s 0.3s ease-out both;}
#title-content .tagline{font-family:'Noto Serif KR',serif;font-size:13px;color:rgba(200,180,140,0.6);margin-bottom:50px;letter-spacing:1px;animation:titleFade 2s 0.6s ease-out both;}
@keyframes titleFade{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
#start-btn{background:none;border:1px solid rgba(240,208,128,0.4);color:var(--text-accent);font-size:16px;padding:14px 48px;border-radius:30px;cursor:pointer;font-family:'Noto Serif KR',serif;transition:all 0.4s;letter-spacing:2px;animation:titleFade 2s 1s ease-out both;position:relative;overflow:hidden;}
#start-btn:hover{background:rgba(240,208,128,0.08);border-color:rgba(240,208,128,0.7);box-shadow:0 0 20px rgba(240,208,128,0.15);transform:translateY(-1px);}
#title-particles{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;}
.title-particle{position:absolute;width:2px;height:2px;background:rgba(240,220,160,0.4);border-radius:50%;animation:particleFloat var(--dur,8s) linear infinite;}
@keyframes particleFloat{0%{transform:translateY(100vh) translateX(0);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translateY(-20px) translateX(var(--dx,20px));opacity:0;}}
/* Ending */
#ending-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px;}
#ending-screen h2{font-family:'Noto Serif KR',serif;font-size:32px;color:var(--text-accent);margin-bottom:16px;}
#ending-screen p{font-size:16px;color:var(--text-primary);line-height:1.8;max-width:500px;margin-bottom:8px;}
#ending-screen .end-items{font-size:13px;color:var(--text-secondary);margin:20px 0;}
#restart-btn{background:none;border:1px solid var(--text-accent);color:var(--text-accent);font-size:16px;padding:10px 32px;border-radius:8px;cursor:pointer;font-family:'Noto Serif KR',serif;margin-top:20px;transition:all 0.3s;}
#restart-btn:hover{background:rgba(240,208,128,0.1);}
/* Characters */
.character{position:absolute;bottom:0;transition:left 0.1s linear,bottom 0.1s;}
/* Noden - rhino */
.noden-sprite{width:56px;height:44px;position:relative;}
.noden-body{position:absolute;width:48px;height:30px;background:linear-gradient(135deg,#8a8a8a,#6a6a6a);border-radius:24px 20px 8px 8px;bottom:10px;left:4px;}
.noden-head{position:absolute;width:24px;height:20px;background:linear-gradient(135deg,#909090,#707070);border-radius:12px 14px 6px 10px;bottom:22px;left:38px;}
.noden-horn{position:absolute;width:6px;height:14px;background:linear-gradient(to top,#b0a080,#d0c8a0);border-radius:3px 3px 1px 1px;bottom:36px;left:48px;transform:rotate(-10deg);}
.noden-eye{position:absolute;width:4px;height:4px;background:#222;border-radius:50%;bottom:30px;left:50px;}
.noden-ear{position:absolute;width:8px;height:6px;background:#808080;border-radius:50% 50% 0 0;bottom:38px;left:40px;}
.noden-leg{position:absolute;width:8px;height:12px;background:#6a6a6a;border-radius:0 0 3px 3px;bottom:0;}
.noden-leg.fl{left:12px;}.noden-leg.fr{left:22px;}.noden-leg.bl{left:32px;}.noden-leg.br{left:40px;}
.noden-tail{position:absolute;width:3px;height:10px;background:#5a5a5a;border-radius:2px;bottom:18px;left:0;transform-origin:top center;}
/* Walking animation */
.character.walking .noden-leg.fl,.character.walking .noden-leg.br{animation:legWalkA 0.35s infinite alternate;}
.character.walking .noden-leg.fr,.character.walking .noden-leg.bl{animation:legWalkB 0.35s infinite alternate;}
.character.walking .noden-tail{animation:tailWag 0.4s infinite alternate;}
@keyframes legWalkA{0%{transform:rotate(-12deg);}100%{transform:rotate(12deg);}}
@keyframes legWalkB{0%{transform:rotate(12deg);}100%{transform:rotate(-12deg);}}
@keyframes tailWag{0%{transform:rotate(-15deg);}100%{transform:rotate(15deg);}}
.character.face-left .noden-sprite{transform:scaleX(-1);}
.character.jumping .noden-sprite{transform:scaleY(0.9) scaleX(1.05);}
.character.jumping.face-left .noden-sprite{transform:scaleY(0.9) scaleX(-1.05);}
/* Easter egg: Rainbow mode */
.rainbow-mode .noden-body{animation:rainbowShift 1s infinite!important;}
.rainbow-mode .noden-head{animation:rainbowShift 1s 0.1s infinite!important;}
@keyframes rainbowShift{0%{filter:hue-rotate(0deg);}100%{filter:hue-rotate(360deg);}}
.rainbow-mode .chiku-body,.rainbow-mode .baby-body{animation:rainbowShift 1.2s infinite!important;}
/* Easter egg: Shooting star */
.shooting-star{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;z-index:199;pointer-events:none;}
.shooting-star::after{content:'';position:absolute;top:0;right:0;width:40px;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,200,0.8));transform-origin:right center;transform:rotate(0deg);}
@keyframes shootingStar{0%{transform:translate(0,0);opacity:1;}100%{transform:translate(-300px,200px);opacity:0;}}
/* Easter egg: Sparkle burst */
.sparkle{position:absolute;pointer-events:none;font-size:14px;z-index:99;animation:sparklePop 0.8s forwards;}
@keyframes sparklePop{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--sx),var(--sy)) scale(0.3);}}
/* Easter egg: Angabu memorial */
.memorial-star{position:fixed;pointer-events:none;z-index:300;animation:memorialFloat 3s forwards;}
@keyframes memorialFloat{0%{opacity:0;transform:translateY(0);}20%{opacity:1;}80%{opacity:1;}100%{opacity:0;transform:translateY(-100px);}}
/* Chiku - penguin */
.chiku-sprite{width:32px;height:38px;position:relative;}
.chiku-body{position:absolute;width:26px;height:28px;background:linear-gradient(135deg,#1a1a2a,#0a0a1a);border-radius:13px 13px 8px 8px;bottom:6px;left:3px;}
.chiku-belly{position:absolute;width:16px;height:18px;background:linear-gradient(180deg,#f0f0f0,#e0e0e0);border-radius:8px;bottom:8px;left:8px;}
.chiku-beak{position:absolute;width:8px;height:5px;background:#e08020;border-radius:0 0 4px 4px;bottom:28px;left:14px;}
.chiku-eye{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;bottom:30px;}
.chiku-eye.l{left:10px;}.chiku-eye.r{left:19px;}
.chiku-foot{position:absolute;width:10px;height:4px;background:#d07020;border-radius:0 0 5px 5px;bottom:0;}
.chiku-foot.l{left:3px;}.chiku-foot.r{left:17px;}
.chiku-egg{position:absolute;width:10px;height:12px;background:linear-gradient(180deg,#f8f8f0,#e8e0d0);border-radius:50%;bottom:10px;left:16px;border:1px solid rgba(0,0,0,0.1);}
.character.walking .chiku-foot.l{animation:pengWalkA 0.3s infinite alternate;}
.character.walking .chiku-foot.r{animation:pengWalkB 0.3s infinite alternate;}
@keyframes pengWalkA{0%{transform:rotate(-8deg);}100%{transform:rotate(8deg);}}
@keyframes pengWalkB{0%{transform:rotate(8deg);}100%{transform:rotate(-8deg);}}
.character.face-left .chiku-sprite{transform:scaleX(-1);}
/* Baby penguin */
.baby-sprite{width:20px;height:24px;position:relative;}
.baby-body{position:absolute;width:16px;height:16px;background:#2a2a3a;border-radius:8px 8px 5px 5px;bottom:4px;left:2px;}
.baby-belly{position:absolute;width:10px;height:10px;background:#f0f0f0;border-radius:5px;bottom:5px;left:5px;}
.baby-fluff{position:absolute;width:20px;height:10px;background:radial-gradient(ellipse,rgba(180,180,200,0.4),transparent);border-radius:50%;bottom:12px;left:0;}
.baby-beak{position:absolute;width:5px;height:3px;background:#e08020;border-radius:0 0 3px 3px;bottom:16px;left:9px;}
.baby-eye{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;bottom:17px;}
.baby-eye.l{left:6px;}.baby-eye.r{left:12px;}
.baby-foot{position:absolute;width:7px;height:3px;background:#d07020;border-radius:0 0 4px 4px;bottom:0;}
.baby-foot.l{left:1px;}.baby-foot.r{left:11px;}
.character.walking .baby-foot.l{animation:pengWalkA 0.3s infinite alternate;}
.character.walking .baby-foot.r{animation:pengWalkB 0.3s infinite alternate;}
.character.face-left .baby-sprite{transform:scaleX(-1);}
/* NPC generic */
.npc-sprite{position:relative;pointer-events:none;}
.npc-label{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--text-accent);white-space:nowrap;pointer-events:none;}
.interact-hint{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--text-accent);white-space:nowrap;animation:blink 1s infinite;pointer-events:none;display:none;}
/* Scene elements */
.scene-element{position:absolute;pointer-events:none;}
.star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:twinkle var(--dur,3s) infinite alternate;}
@keyframes twinkle{0%{opacity:0.3;transform:scale(0.8);}100%{opacity:1;transform:scale(1.2);}}
.grass{position:absolute;bottom:0;width:6px;height:18px;background:linear-gradient(to top,#2a4a20,#3a6a30);border-radius:3px 3px 0 0;transform-origin:bottom center;animation:sway 2s infinite alternate ease-in-out;}
@keyframes sway{0%{transform:rotate(-5deg);}100%{transform:rotate(5deg);}}
.rain{position:absolute;width:1px;height:12px;background:linear-gradient(to bottom,transparent,rgba(150,180,220,0.6));animation:fall var(--dur,1s) linear infinite;top:var(--top,-20px);left:var(--left,50%);}
@keyframes fall{0%{transform:translateY(-20px);opacity:1;}100%{transform:translateY(100vh);opacity:0;}}
/* Ground */
.ground{position:absolute;bottom:0;left:0;width:100%;pointer-events:none;}
/* D-pad mobile */
#dpad{position:absolute;bottom:calc(20px + env(safe-area-inset-bottom,0px));left:20px;z-index:70;display:none;}
.dpad-btn{position:absolute;width:44px;height:44px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:rgba(255,255,255,0.6);-webkit-tap-highlight-color:transparent;}
.dpad-btn:active{background:rgba(255,255,255,0.25);}
.dpad-up{left:48px;top:0;}.dpad-down{left:48px;top:96px;}.dpad-left{left:0;top:48px;}.dpad-right{left:96px;top:48px;}
#mobile-actions{position:absolute;bottom:calc(20px + env(safe-area-inset-bottom,0px));right:20px;z-index:70;display:none;gap:10px;}
.mobile-btn{width:50px;height:50px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;color:rgba(255,255,255,0.7);-webkit-tap-highlight-color:transparent;}
.mobile-btn:active{background:rgba(255,255,255,0.25);}
/* Responsive */
@media(max-width:768px){
  #dpad{display:block;}
  #mobile-actions{display:flex;}
  #dialogue-box{bottom:160px;width:92%;}
  #choices-box{bottom:160px;}
  #hud{height:40px;}
  #chapter-overlay .ch-title{font-size:22px;}
}
/* Music toggle */
#music-btn{position:absolute;top:10px;left:10px;z-index:55;}
/* Minigame */
#mg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:150;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.mg-title{font-family:'Noto Serif KR',serif;font-size:18px;color:var(--text-accent);margin-bottom:4px;}
.mg-desc{font-size:12px;color:var(--text-secondary);margin-bottom:12px;}
.mg-area{position:relative;width:min(90%,480px);height:280px;border:1px solid var(--ui-border);border-radius:12px;overflow:hidden;background:rgba(8,8,16,0.9);cursor:pointer;}
.mg-hud{display:flex;justify-content:space-between;width:min(90%,480px);margin-top:8px;font-size:13px;}
.mg-hud>*:first-child{color:var(--text-secondary);}.mg-hud>*:last-child{color:var(--text-accent);}
.mg-result{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:155;opacity:0;transition:opacity 0.4s;}
.mg-result.show{opacity:1;}
.mg-result-text{font-family:'Noto Serif KR',serif;font-size:24px;color:var(--text-accent);}
.mg-item{position:absolute;font-size:22px;cursor:pointer;transition:transform 0.2s,opacity 0.3s;animation:twinkle 0.8s infinite alternate;z-index:2;}
.mg-item:hover{transform:scale(1.3);}
.mg-pop{transform:scale(1.8)!important;opacity:0!important;}
.mg-fade{opacity:0!important;}
.mg-ring{position:absolute;left:50%;top:50%;width:50px;height:50px;border:2px solid var(--text-accent);border-radius:50%;transform:translate(-50%,-50%);opacity:0.5;}
.mg-heart{position:absolute;font-size:24px;cursor:pointer;z-index:2;transition:opacity 0.2s;}
.mg-player{position:absolute;font-size:28px;transform:translateX(-50%);z-index:3;transition:left 0.15s;}
.mg-danger{position:absolute;font-size:22px;z-index:1;}
.mg-light{position:absolute;width:18px;height:18px;background:radial-gradient(circle,rgba(255,255,200,0.9),rgba(255,200,100,0.3),transparent);border-radius:50%;cursor:pointer;animation:twinkle 0.5s infinite alternate;z-index:2;}
.mg-bar-bg{position:absolute;bottom:40%;left:10%;width:80%;height:20px;background:rgba(255,255,255,0.1);border-radius:10px;overflow:hidden;}
.mg-bar-fill{height:100%;width:0%;background:var(--hope-color);border-radius:10px;transition:width 0.1s;}
.mg-mash-label{position:absolute;top:20%;width:100%;text-align:center;font-size:16px;color:var(--text-secondary);}
.mg-mash-icon{position:absolute;top:32%;left:50%;transform:translateX(-50%);font-size:48px;}
.mg-bounce{animation:mgBounce 0.15s;}
@keyframes mgBounce{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
.mg-mash-icon.mg-bounce{animation:mgBounceMash 0.15s;}
@keyframes mgBounceMash{0%,100%{transform:translateX(-50%) scale(1);}50%{transform:translateX(-50%) scale(1.2);}}
.mg-catcher{position:absolute;bottom:15px;font-size:28px;transform:translateX(-50%);z-index:3;transition:left 0.12s;}
.mg-drop{position:absolute;font-size:18px;z-index:1;}
.mg-star-num{position:absolute;width:32px;height:32px;border:1px solid var(--text-accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--text-accent);font-size:14px;cursor:pointer;transform:translate(-50%,-50%);z-index:2;transition:all 0.3s;}
.mg-star-num:hover{background:rgba(240,208,128,0.2);}
.mg-star-num.mg-done{background:var(--text-accent);color:#000;}
.mg-egg{position:absolute;top:25%;left:50%;transform:translateX(-50%);font-size:56px;}
.mg-egg.mg-bounce{animation:mgBounceMash 0.15s;}
.mg-temp-bg{position:absolute;bottom:15%;left:15%;width:70%;height:16px;background:rgba(255,255,255,0.1);border-radius:8px;overflow:hidden;}
.mg-temp-fill{height:100%;width:50%;border-radius:8px;transition:width 0.1s,background 0.3s;}
.mg-penguin{position:absolute;font-size:28px;z-index:3;transition:bottom 0.15s;}
.mg-wave-el{position:absolute;font-size:30px;z-index:1;}
</style>
</head>
<body>
<div id="game">
  <!-- Mobile Notice -->
  <div id="mobile-notice">
    <div class="mn-icon">&#128187;</div>
    <div class="mn-title">ì»´í“¨í„°ë¡œ í”Œë ˆì´í•´ì£¼ì„¸ìš”</div>
    <div class="mn-desc">ì´ ê²Œì„ì€ í‚¤ë³´ë“œ ì¡°ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>PC ë˜ëŠ” ë…¸íŠ¸ë¶ì—ì„œ ì ‘ì†í•´ì£¼ì„¸ìš”.</div>
  </div>
  <!-- Title -->
  <div id="title-screen">
    <div id="title-stars"></div>
    <div id="title-moon"></div>
    <div id="title-particles"></div>
    <div id="title-ground"></div>
    <div id="title-hills"><div class="title-hill"></div><div class="title-hill"></div><div class="title-hill"></div></div>
    <div id="title-silhouettes">
      <div class="sil-rhino">
        <div class="sil-rhino-body"></div>
        <div class="sil-rhino-head"></div>
        <div class="sil-rhino-horn"></div>
        <div class="sil-rhino-leg"></div><div class="sil-rhino-leg"></div><div class="sil-rhino-leg"></div><div class="sil-rhino-leg"></div>
      </div>
      <div class="sil-penguin">
        <div class="sil-penguin-body"></div>
        <div class="sil-penguin-head"></div>
        <div class="sil-penguin-foot"></div><div class="sil-penguin-foot"></div>
      </div>
    </div>
    <div id="title-content">
      <h1>ê¸´ê¸´ë°¤</h1>
      <div class="subtitle">The Long, Long Night</div>
      <div class="tagline">ì–´ë‘  ì†ì—ì„œë„, í•¨ê»˜ë¼ë©´ ê±¸ì„ ìˆ˜ ìˆë‹¤</div>
      <button id="start-btn">í˜¼ì ì—¬ì •ì„ ì‹œì‘í•˜ë‹¤</button>
      <button id="mp-btn" style="background:none;border:1px solid rgba(240,208,128,0.3);color:var(--text-secondary);font-size:13px;padding:10px 32px;border-radius:20px;cursor:pointer;font-family:'Noto Serif KR',serif;margin-top:12px;letter-spacing:1px;animation:titleFade 2s 1.2s ease-out both;">í•¨ê»˜ ì—¬ì •í•˜ê¸°</button>
    </div>
  </div>
  <!-- Multiplayer lobby -->
  <div id="mp-lobby">
    <h3>í•¨ê»˜ ì—¬ì •í•˜ê¸°</h3>
    <div id="mp-lobby-menu">
      <button class="mp-btn" id="mp-create">ë°© ë§Œë“¤ê¸°</button>
      <button class="mp-btn" id="mp-join-btn">ë°© ì°¸ê°€í•˜ê¸°</button>
    </div>
    <div id="mp-host-view" style="display:none;text-align:center;">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">ì¹œêµ¬ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</div>
      <div id="mp-room-code">----</div>
      <div id="mp-status">ëŒ€ê¸° ì¤‘...</div>
    </div>
    <div id="mp-join-view" style="display:none;text-align:center;">
      <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      <input id="mp-input" maxlength="4" placeholder="0000">
      <br><button class="mp-btn" id="mp-connect" style="margin-top:12px;">ì ‘ì†í•˜ê¸°</button>
      <div id="mp-join-status" style="font-size:13px;color:var(--text-secondary);margin-top:8px;"></div>
    </div>
    <button id="mp-back">â† ëŒì•„ê°€ê¸°</button>
  </div>
  <!-- Chat -->
  <div id="chat-box">
    <div id="chat-msgs"></div>
    <div id="chat-input-wrap"><input id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." maxlength="100"></div>
    <div id="chat-hint">Tí‚¤ë¡œ ì±„íŒ…</div>
  </div>
  <!-- Multiplayer indicator -->
  <div id="mp-indicator"></div>
  <!-- Scene container -->
  <div id="scene"></div>
  <!-- HUD -->
  <div id="hud" style="display:none;">
    <div id="chapter-label"></div>
    <div id="hope-bar-wrap"><div id="hope-bar" style="width:60%"></div></div>
    <div id="hope-label">60</div>
    <button class="hud-btn" id="music-btn" title="ìŒì•…">&#9835;</button>
    <button class="hud-btn" id="inv-btn" title="ì†Œì§€í’ˆ (I)">ì†Œì§€í’ˆ</button>
    <button class="hud-btn" id="skin-btn" title="í…Œë§ˆ">í…Œë§ˆ</button>
    <button class="hud-btn" id="egg-btn" title="ì´ìŠ¤í„°ì—ê·¸">ğŸ¥š</button>
  </div>
  <!-- Dialogue -->
  <div id="dialogue-box">
    <div id="dialogue-speaker"></div>
    <div id="dialogue-text"></div>
    <div id="dialogue-next">Space / í´ë¦­ &#9654;</div>
  </div>
  <!-- Choices -->
  <div id="choices-box"></div>
  <!-- Easter egg panel -->
  <div id="egg-panel">
    <h3>ì´ìŠ¤í„°ì—ê·¸</h3>
    <div id="egg-count" class="egg-count"></div>
    <div id="egg-list"></div>
  </div>
  <!-- Inventory -->
  <div id="inventory-panel">
    <h3>ì†Œì§€í’ˆ</h3>
    <div id="inv-list"><div id="inv-empty">ì•„ì§ ì•„ë¬´ê²ƒë„ ì—†ìŠµë‹ˆë‹¤...</div></div>
  </div>
  <!-- Skin panel -->
  <div id="skin-panel">
    <button class="skin-option active" data-skin="">ë°¤ (ê¸°ë³¸)</button>
    <button class="skin-option" data-skin="twilight">í™©í˜¼</button>
    <button class="skin-option" data-skin="winter">ê²¨ìš¸</button>
    <button class="skin-option" data-skin="sakura">ë²šê½ƒ</button>
    <button class="skin-option" data-skin="oldbook">ì˜¤ë˜ëœ ì±…</button>
  </div>
  <!-- Chapter overlay -->
  <div id="chapter-overlay">
    <div class="ch-num"></div>
    <div class="ch-title"></div>
    <div class="ch-sub"></div>
  </div>
  <!-- Cutscene -->
  <div id="cutscene"><div id="cutscene-text"></div></div>
  <!-- Vignette -->
  <div id="vignette"></div>
  <!-- Ending -->
  <div id="ending-screen">
    <h2 id="ending-title"></h2>
    <p id="ending-text"></p>
    <div id="ending-items" class="end-items"></div>
    <button id="restart-btn">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
  </div>
  <!-- Mobile controls -->
  <div id="dpad">
    <div class="dpad-btn dpad-up" data-dir="up">&#9650;</div>
    <div class="dpad-btn dpad-down" data-dir="down">&#9660;</div>
    <div class="dpad-btn dpad-left" data-dir="left">&#9664;</div>
    <div class="dpad-btn dpad-right" data-dir="right">&#9654;</div>
  </div>
  <div id="mobile-actions">
    <div class="mobile-btn" id="m-interact">Act</div>
    <div class="mobile-btn" id="m-inv">I</div>
  </div>
</div>
<script>
// ===== GAME ENGINE =====
const $ = id => document.getElementById(id);
const GS = {
  chapter: 0, hope: 60, items: [], flags: {},
  px: 200, py: 0, companion: null, babyPenguin: false,
  transitioning: false, dialogueActive: false, choiceActive: false, minigameActive: false,
  musicOn: true, sceneKey: '', facing: 'right',
  moving: { up:false, down:false, left:false, right:false },
  jumpY: 0, jumpVel: 0, isJumping: false
};

// ===== AUDIO ENGINE =====
let audioCtx, masterGain, musicGain, sfxGain, currentMusic = null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value=0.3; masterGain.connect(audioCtx.destination);
  musicGain = audioCtx.createGain(); musicGain.gain.value=0.5; musicGain.connect(masterGain);
  sfxGain = audioCtx.createGain(); sfxGain.gain.value=0.6; sfxGain.connect(masterGain);
}
function toggleMusic(){
  GS.musicOn=!GS.musicOn;
  if(musicGain) musicGain.gain.value=GS.musicOn?0.5:0;
  $('music-btn').style.opacity=GS.musicOn?1:0.4;
}
function playNote(freq, dur, type='sine', gain=0.15, dest=null){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.setValueAtTime(gain, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
  o.connect(g); g.connect(dest||musicGain);
  o.start(); o.stop(audioCtx.currentTime+dur);
}
function playSfx(type){
  if(!audioCtx)return;
  if(type==='item'){
    [523,659,784].forEach((f,i)=>setTimeout(()=>playNote(f,0.15,'triangle',0.2,sfxGain),i*80));
  } else if(type==='sad'){
    [440,392,349].forEach((f,i)=>setTimeout(()=>playNote(f,0.4,'sine',0.15,sfxGain),i*200));
  } else if(type==='hope'){
    [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playNote(f,0.2,'triangle',0.15,sfxGain),i*100));
  }
}
// Procedural music loops
const SCALES = {
  orphanage: [220,261,293,349,392,440,523], // Am warm
  savanna: [293,329,392,440,523,587,659], // D major bright
  zoo: [233,261,311,349,415,466,523], // Bb minor cold
  escape: [329,392,466,523,587,659,784], // E minor tense
  forest: [261,293,349,392,440,523,587], // C major gentle
  journey: [220,261,329,392,440,523,659], // Am pentatonic-ish
  farewell: [196,220,261,293,349,392,440], // G minor sad
  sea: [329,392,440,523,587,659,784] // E major bright
};
let musicInterval=null;
function startMusic(key){
  stopMusic();
  if(!audioCtx)return;
  const scale=SCALES[key]||SCALES.journey;
  let idx=0;
  const tempos={orphanage:600,savanna:450,zoo:700,escape:280,forest:550,journey:500,farewell:650,sea:400};
  const tempo=tempos[key]||500;
  const types={zoo:'square',escape:'sawtooth'};
  const type=types[key]||'sine';
  const gains={orphanage:0.08,farewell:0.07,sea:0.1};
  const gain=gains[key]||0.08;
  musicInterval=setInterval(()=>{
    if(!GS.musicOn)return;
    const note=scale[idx%scale.length];
    const octave=Math.random()>0.7?2:1;
    playNote(note*octave, tempo/1000*1.5, type, gain);
    if(Math.random()>0.5){
      const harm=scale[(idx+2)%scale.length];
      setTimeout(()=>playNote(harm*octave, tempo/1000, type, gain*0.5), tempo*0.25);
    }
    idx++;
  }, tempo);
}
function stopMusic(){ if(musicInterval){clearInterval(musicInterval);musicInterval=null;} }

// ===== SCENE SYSTEM =====
function buildScene(key){
  GS.sceneKey=key;
  const sc=$('scene');
  sc.innerHTML='';
  const def=SCENES[key];
  if(!def)return;
  // Background
  const bg=document.createElement('div');
  bg.className='scene-bg';
  bg.style.background=def.bg;
  sc.appendChild(bg);
  // Ground
  if(def.ground){
    const g=document.createElement('div');
    g.className='ground';
    g.style.height=def.ground.height||'80px';
    g.style.background=def.ground.bg;
    sc.appendChild(g);
  }
  // Stars
  if(def.stars){
    for(let i=0;i<def.stars;i++){
      const s=document.createElement('div');
      s.className='star';
      s.style.left=Math.random()*100+'%';
      s.style.top=Math.random()*50+'%';
      s.style.setProperty('--dur',(2+Math.random()*4)+'s');
      s.style.width=(1+Math.random()*2)+'px';
      s.style.height=s.style.width;
      sc.appendChild(s);
    }
  }
  // Rain
  if(def.rain){
    for(let i=0;i<60;i++){
      const r=document.createElement('div');
      r.className='rain';
      r.style.setProperty('--left',Math.random()*100+'%');
      r.style.setProperty('--dur',(0.5+Math.random()*0.5)+'s');
      r.style.animationDelay=Math.random()*2+'s';
      sc.appendChild(r);
    }
  }
  // Grass
  if(def.grassCount){
    for(let i=0;i<def.grassCount;i++){
      const g=document.createElement('div');
      g.className='grass';
      g.style.left=Math.random()*100+'%';
      g.style.height=(12+Math.random()*14)+'px';
      g.style.animationDelay=Math.random()*2+'s';
      if(def.grassColor)g.style.background=def.grassColor;
      sc.appendChild(g);
    }
  }
  // Decorations
  if(def.decorations){
    def.decorations.forEach(d=>{
      const el=document.createElement('div');
      el.className='scene-element';
      el.style.cssText=d.style;
      el.innerHTML=d.html||'';
      sc.appendChild(el);
    });
  }
  // NPCs
  if(def.npcs){
    def.npcs.forEach(npc=>{
      if(npc.condition && !npc.condition()) return;
      const el=document.createElement('div');
      el.className='character npc';
      el.dataset.id=npc.id;
      el.style.left=npc.x+'px';
      el.style.bottom=(def.ground?parseInt(def.ground.height)||80:80)+'px';
      el.innerHTML=`<div class="interact-hint">Space / í´ë¦­</div><div class="npc-label">${npc.name}</div>${npc.sprite}`;
      el.style.cursor='pointer';
      el.style.pointerEvents='auto';
      el.addEventListener('click',()=>interactWithNPC(npc));
      sc.appendChild(el);
    });
  }
  // Items on ground
  if(def.groundItems){
    def.groundItems.forEach(gi=>{
      if(gi.condition && !gi.condition()) return;
      if(GS.items.find(it=>it.id===gi.id)) return;
      const el=document.createElement('div');
      el.className='scene-element';
      el.dataset.itemId=gi.id;
      el.style.position='absolute';
      el.style.left=gi.x+'px';
      el.style.bottom=(def.ground?parseInt(def.ground.height)||80:80)+'px';
      el.style.fontSize='24px';
      el.style.cursor='pointer';
      el.style.pointerEvents='auto';
      el.style.animation='blink 1.5s infinite';
      el.textContent=gi.icon;
      el.addEventListener('click',()=>pickupItem(gi));
      sc.appendChild(el);
    });
  }
  // Player
  createPlayer(sc, def);
  // Companion
  if(GS.companion==='chiku') createCompanion(sc, def, 'chiku');
  if(GS.babyPenguin) createCompanion(sc, def, 'baby');
  // Music
  if(def.music) startMusic(def.music);
}

function createPlayer(sc, def){
  const el=document.createElement('div');
  el.id='player';
  el.className='character';
  const groundH=def.ground?parseInt(def.ground.height)||80:80;
  el.style.bottom=groundH+'px';
  el.style.left=GS.px+'px';
  el.innerHTML=`<div class="noden-sprite">
    <div class="noden-tail"></div>
    <div class="noden-body"></div>
    <div class="noden-head"></div>
    <div class="noden-horn"></div>
    <div class="noden-ear"></div>
    <div class="noden-eye"></div>
    <div class="noden-leg fl"></div>
    <div class="noden-leg fr"></div>
    <div class="noden-leg bl"></div>
    <div class="noden-leg br"></div>
  </div>`;
  sc.appendChild(el);
}

function createCompanion(sc, def, type){
  const el=document.createElement('div');
  el.id='companion';
  el.className='character';
  const groundH=def.ground?parseInt(def.ground.height)||80:80;
  el.style.bottom=groundH+'px';
  el.style.left=(GS.px-50)+'px';
  if(type==='chiku'){
    const hasEgg=!GS.flags.chikuNoEgg;
    el.innerHTML=`<div class="chiku-sprite">
      <div class="chiku-body"></div>
      <div class="chiku-belly"></div>
      ${hasEgg?'<div class="chiku-egg"></div>':''}
      <div class="chiku-beak"></div>
      <div class="chiku-eye l"></div>
      <div class="chiku-eye r"></div>
      <div class="chiku-foot l"></div>
      <div class="chiku-foot r"></div>
    </div>`;
  } else {
    el.innerHTML=`<div class="baby-sprite">
      <div class="baby-body"></div>
      <div class="baby-belly"></div>
      <div class="baby-fluff"></div>
      <div class="baby-beak"></div>
      <div class="baby-eye l"></div>
      <div class="baby-eye r"></div>
      <div class="baby-foot l"></div>
      <div class="baby-foot r"></div>
    </div>`;
  }
  sc.appendChild(el);
}

// ===== MOVEMENT =====
const SPEED=3;
const JUMP_FORCE=10;
const GRAVITY=0.5;
function jump(){
  if(GS.isJumping||GS.transitioning||GS.dialogueActive||GS.choiceActive||GS.minigameActive)return;
  GS.isJumping=true;
  GS.jumpVel=JUMP_FORCE;
  if(audioCtx) playNote(392,0.08,'triangle',0.06,sfxGain);
}
function gameLoop(){
  if(!GS.transitioning && !GS.dialogueActive && !GS.choiceActive && !GS.minigameActive){
    let dx=0;
    if(GS.moving.left) dx=-SPEED;
    if(GS.moving.right) dx=SPEED;
    // Jump physics
    if(GS.isJumping){
      GS.jumpY+=GS.jumpVel;
      GS.jumpVel-=GRAVITY;
      if(GS.jumpY<=0){
        GS.jumpY=0;
        GS.jumpVel=0;
        GS.isJumping=false;
      }
    }
    if(dx!==0){
      const def=SCENES[GS.sceneKey];
      const minX=def?.bounds?.left??20;
      const maxX=def?.bounds?.right??(window.innerWidth-60);
      GS.px=Math.max(minX, Math.min(maxX, GS.px+dx));
      GS.facing=dx>0?'right':'left';
      const p=$('player');
      if(p){
        p.style.left=GS.px+'px';
        p.classList.add('walking');
        p.classList.toggle('face-left', GS.facing==='left');
      }
      // Companion follow
      const comp=$('companion');
      if(comp){
        const cx=parseFloat(comp.style.left)||0;
        const targetX=GS.px-(GS.facing==='right'?50:-50);
        const cdx=(targetX-cx)*0.05;
        comp.style.left=(cx+cdx)+'px';
        if(Math.abs(cdx)>0.5){
          comp.classList.add('walking');
          comp.classList.toggle('face-left',cdx<0);
        } else {
          comp.classList.remove('walking');
        }
      }
      // Check exit
      checkExit();
      // Check NPC proximity
      checkNPCProximity();
    } else {
      const p=$('player');
      if(p) p.classList.remove('walking');
      const comp=$('companion');
      if(comp) comp.classList.remove('walking');
    }
    // Apply jump offset to player and companion
    const p=$('player');
    if(p){
      const def=SCENES[GS.sceneKey];
      const groundH=def?.ground?parseInt(def.ground.height)||80:80;
      p.style.bottom=(groundH+GS.jumpY)+'px';
      p.classList.toggle('jumping',GS.isJumping);
    }
    const comp=$('companion');
    if(comp&&GS.isJumping){
      const def=SCENES[GS.sceneKey];
      const groundH=def?.ground?parseInt(def.ground.height)||80:80;
      comp.style.bottom=(groundH+GS.jumpY*0.3)+'px';
    } else if(comp&&!GS.isJumping){
      const def=SCENES[GS.sceneKey];
      const groundH=def?.ground?parseInt(def.ground.height)||80:80;
      comp.style.bottom=groundH+'px';
    }
  }
  requestAnimationFrame(gameLoop);
}

function checkExit(){
  const def=SCENES[GS.sceneKey];
  if(!def||!def.exits||GS.transitioning)return;
  def.exits.forEach(ex=>{
    if(ex.condition && !ex.condition()) return;
    if(Math.abs(GS.px-ex.x)<30){
      if(ex.type==='scene') loadScene(ex.target, ex.playerX);
      else if(ex.type==='dialogue') startDialogue(ex.dialogue);
      else if(ex.type==='chapter') showChapter(ex.chapter, ex.target, ex.playerX);
    }
  });
}

function checkNPCProximity(){
  const npcs=document.querySelectorAll('.npc');
  npcs.forEach(n=>{
    const nx=parseFloat(n.style.left)||0;
    const hint=n.querySelector('.interact-hint');
    if(hint) hint.style.display=Math.abs(GS.px-nx)<60?'block':'none';
  });
}

// ===== DIALOGUE SYSTEM =====
let dialogueQueue=[], dlgIdx=0, typeTimer=null, fullText='';
function startDialogue(lines){
  if(GS.dialogueActive)return;
  dialogueQueue=typeof lines==='function'?lines():lines;
  dlgIdx=0;
  GS.dialogueActive=true;
  $('dialogue-box').style.display='block';
  showLine();
}
function showLine(){
  if(dlgIdx>=dialogueQueue.length){ endDialogue(); return; }
  const line=dialogueQueue[dlgIdx];
  // Mini-game
  if(line.minigame){
    try{
      $('dialogue-box').style.display='none';
      startMinigame(line.minigame, line.mgCfg||{}, (success)=>{
        try{ if(success && line.onSuccess) line.onSuccess(); }catch(e2){console.error('[MG] onSuccess error:',e2);}
        try{ if(!success && line.onFail) line.onFail(); }catch(e3){console.error('[MG] onFail error:',e3);}
        $('dialogue-box').style.display='block';
        dlgIdx++;
        showLine();
      });
    }catch(e){
      console.error('[MG] minigame error:',e);
      GS.minigameActive=false;
      $('dialogue-box').style.display='block';
      dlgIdx++;
      showLine();
    }
    return;
  }
  // Check for special actions
  if(line.action){
    line.action();
    dlgIdx++;
    showLine();
    return;
  }
  if(line.choice){
    endDialogue();
    showChoices(line.choice);
    return;
  }
  $('dialogue-speaker').textContent=line.speaker||'';
  fullText=typeof line.text==='function'?line.text():line.text;
  $('dialogue-text').textContent='';
  $('dialogue-next').style.display='none';
  let ci=0;
  clearInterval(typeTimer);
  typeTimer=setInterval(()=>{
    if(ci<fullText.length){
      $('dialogue-text').textContent+=fullText[ci]; ci++;
    } else {
      clearInterval(typeTimer);
      $('dialogue-next').style.display='block';
    }
  },30);
}
function advanceDialogue(){
  if(!GS.dialogueActive)return;
  if($('dialogue-text').textContent.length<fullText.length){
    clearInterval(typeTimer);
    $('dialogue-text').textContent=fullText;
    $('dialogue-next').style.display='block';
  } else {
    dlgIdx++;
    showLine();
  }
}
function endDialogue(){
  GS.dialogueActive=false;
  $('dialogue-box').style.display='none';
  clearInterval(typeTimer);
}

// ===== MINI-GAME SYSTEM =====
function startMinigame(mgType,mgCfg,onDone){
  console.log('[MG] start:', mgType);
  GS.minigameActive=true;
  const ov=document.createElement('div');ov.id='mg-overlay';
  ov.innerHTML='<div class="mg-title">'+((mgCfg&&mgCfg.title)||'')+'</div><div class="mg-desc">'+((mgCfg&&mgCfg.desc)||'')+'</div><div class="mg-area"></div><div class="mg-hud"><span></span><span></span></div>';
  $('game').appendChild(ov);
  const area=ov.querySelector('.mg-area'),tEl=ov.querySelector('.mg-hud>*:first-child'),sEl=ov.querySelector('.mg-hud>*:last-child');
  let _done=false;const _i=[],_t=[];
  const si=(fn,ms)=>{const id=setInterval(fn,ms);_i.push(id);return id;};
  const st=(fn,ms)=>{const id=setTimeout(fn,ms);_t.push(id);return id;};
  function mgEnd(success){
    if(_done)return;_done=true;_i.forEach(clearInterval);_t.forEach(clearTimeout);
    console.log('[MG] end:', mgType, success);
    const r=document.createElement('div');r.className='mg-result';
    r.innerHTML='<div class="mg-result-text">'+(success?'âœ¨':'ğŸ’¨')+'</div>';
    ov.appendChild(r);requestAnimationFrame(()=>r.classList.add('show'));
    if(success&&audioCtx)try{playNote(659,0.2,'triangle',0.1,sfxGain);}catch(e){}
    setTimeout(()=>{ov.remove();GS.minigameActive=false;onDone(success);},1000);
  }
  if(!MG[mgType]){console.error('[MG] Unknown type:',mgType);GS.minigameActive=false;onDone(false);return;}
  st(()=>{try{MG[mgType](area,tEl,sEl,mgCfg||{},mgEnd,si,st);}catch(e){console.error('[MG] game error:',e);mgEnd(false);}},600);
}
const MG={};

// 1. starCatch - ë³„ ì¡ê¸°
MG.starCatch=(a,tE,sE,c,end,si,st)=>{
  let s=0,g=c.goal||5,t=c.time||10;
  sE.textContent='â­ 0/'+g;tE.textContent=t+'ì´ˆ';
  function mk(){
    if(s>=g)return;
    const d=document.createElement('div');d.className='mg-item';d.textContent='â­';
    d.style.left=(10+Math.random()*76)+'%';d.style.top=(8+Math.random()*68)+'%';
    d.onclick=()=>{s++;sE.textContent='â­ '+s+'/'+g;d.classList.add('mg-pop');st(()=>d.remove(),200);playNote(440+s*60,.12,'triangle',.12,sfxGain);if(s>=g)end(true);else st(mk,300);};
    a.appendChild(d);st(()=>{if(d.parentNode){d.classList.add('mg-fade');st(()=>{d.remove();st(mk,100);},300);}},2200);
  }
  mk();st(mk,600);st(mk,1200);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(s>=g);},1000);
};

// 2. heartBeat - ë¦¬ë“¬ ë§ì¶”ê¸°
MG.heartBeat=(a,tE,sE,c,end,si,st)=>{
  let s=0,r=0,g=c.goal||3,tot=c.total||5;
  sE.textContent='ğŸ’› 0/'+g;
  const ring=document.createElement('div');ring.className='mg-ring';a.appendChild(ring);
  function beat(){
    if(r>=tot){st(()=>end(s>=g),300);return;}
    r++;tE.textContent=r+'/'+tot;
    const h=document.createElement('div');h.className='mg-heart';h.textContent='ğŸ’›';
    h.style.top='50%';h.style.transform='translateY(-50%)';
    let x=-30,hit=false;h.style.left=x+'px';a.appendChild(h);
    const mv=si(()=>{x+=3;h.style.left=x+'px';if(x>a.offsetWidth+30){clearInterval(mv);h.remove();st(beat,300);}},16);
    h.onclick=()=>{
      if(hit)return;hit=true;clearInterval(mv);
      const ctr=a.offsetWidth/2;
      if(Math.abs(x-ctr)<45){s++;sE.textContent='ğŸ’› '+s+'/'+g;h.classList.add('mg-pop');playNote(523,.12,'triangle',.12,sfxGain);}
      else{h.style.opacity='.3';}
      st(()=>{h.remove();st(beat,200);},250);
    };
  }
  st(beat,400);
};

// 3. dodge - í”¼í•˜ê¸°
MG.dodge=(a,tE,sE,c,end,si,st)=>{
  let t=c.time||8,hp=3,px=50;
  sE.textContent='â¤ï¸â¤ï¸â¤ï¸';tE.textContent=t+'ì´ˆ';
  const p=document.createElement('div');p.className='mg-player';p.textContent='ğŸ¦';
  p.style.left='50%';p.style.bottom='10px';a.appendChild(p);
  a.onclick=(e)=>{const r=a.getBoundingClientRect();px=((e.clientX-r.left)/r.width)*100;px=Math.max(5,Math.min(95,px));p.style.left=px+'%';};
  si(()=>{
    const d=document.createElement('div');d.className='mg-danger';d.textContent=c.icon||'âš¡';
    const dx=5+Math.random()*85;d.style.left=dx+'%';d.style.top='-30px';a.appendChild(d);
    let y=-30;
    const f=si(()=>{
      y+=3.5;d.style.top=y+'px';
      if(y>a.offsetHeight){clearInterval(f);d.remove();}
      else if(y>a.offsetHeight-55&&Math.abs(dx-px)<12){hp--;sE.textContent='â¤ï¸'.repeat(Math.max(0,hp));clearInterval(f);d.remove();if(hp<=0)end(false);}
    },25);
  },700);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(hp>0);},1000);
};

// 4. findLight - ë¹› ì°¾ê¸°
MG.findLight=(a,tE,sE,c,end,si,st)=>{
  let s=0,g=c.goal||3,t=c.time||12;
  sE.textContent='ğŸ’« 0/'+g;tE.textContent=t+'ì´ˆ';
  a.style.background='#030308';
  function mk(){
    if(s>=g)return;
    const d=document.createElement('div');d.className='mg-light';
    d.style.left=(8+Math.random()*78)+'%';d.style.top=(8+Math.random()*70)+'%';
    d.onclick=()=>{s++;sE.textContent='ğŸ’« '+s+'/'+g;d.remove();playNote(587,.15,'sine',.1,sfxGain);if(s>=g)end(true);else st(mk,400);};
    a.appendChild(d);st(()=>{if(d.parentNode){d.remove();st(mk,200);}},1600);
  }
  mk();st(mk,800);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(s>=g);},1000);
};

// 5. mash - ì—°íƒ€
MG.mash=(a,tE,sE,c,end,si,st)=>{
  let pw=0,t=c.time||8;tE.textContent=t+'ì´ˆ';
  a.innerHTML='<div class="mg-mash-label">'+(c.label||'ì—°íƒ€í•˜ì„¸ìš”!')+'</div><div class="mg-mash-icon">'+(c.icon||'ğŸ”¥')+'</div><div class="mg-bar-bg"><div class="mg-bar-fill"></div></div>';
  const fill=a.querySelector('.mg-bar-fill'),icon=a.querySelector('.mg-mash-icon');
  a.onclick=()=>{pw=Math.min(100,pw+3.5);fill.style.width=pw+'%';sE.textContent=Math.floor(pw)+'%';icon.classList.remove('mg-bounce');void icon.offsetWidth;icon.classList.add('mg-bounce');if(pw>=100)end(true);};
  si(()=>{pw=Math.max(0,pw-1.2);fill.style.width=pw+'%';sE.textContent=Math.floor(pw)+'%';},100);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(pw>=100);},1000);
};

// 6. rainCatch - ë¹—ë°©ìš¸ ë°›ê¸°
MG.rainCatch=(a,tE,sE,c,end,si,st)=>{
  let s=0,g=c.goal||8,t=c.time||12,px=50;
  sE.textContent='ğŸ’§ 0/'+g;tE.textContent=t+'ì´ˆ';
  const ct=document.createElement('div');ct.className='mg-catcher';ct.textContent='ğŸŒ¿';ct.style.left='50%';a.appendChild(ct);
  a.onclick=(e)=>{const r=a.getBoundingClientRect();px=((e.clientX-r.left)/r.width)*100;px=Math.max(5,Math.min(95,px));ct.style.left=px+'%';};
  si(()=>{
    const d=document.createElement('div');d.className='mg-drop';d.textContent='ğŸ’§';
    const dx=8+Math.random()*82;d.style.left=dx+'%';d.style.top='-20px';a.appendChild(d);
    let y=-20;
    const f=si(()=>{
      y+=2.5;d.style.top=y+'px';
      if(y>a.offsetHeight-50&&Math.abs(dx-px)<10){s++;sE.textContent='ğŸ’§ '+s+'/'+g;clearInterval(f);d.remove();playNote(440+s*30,.1,'sine',.1,sfxGain);if(s>=g)end(true);}
      if(y>a.offsetHeight){clearInterval(f);d.remove();}
    },25);
  },800);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(s>=g);},1000);
};

// 7. starConnect - ë³„ ì‡ê¸°
MG.starConnect=(a,tE,sE,c,end,si,st)=>{
  let next=1;const tot=c.total||5;sE.textContent='1/'+tot;tE.textContent='';
  const canvas=document.createElement('canvas');canvas.width=480;canvas.height=280;
  canvas.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;';
  a.appendChild(canvas);const cx=canvas.getContext('2d');cx.strokeStyle='rgba(240,208,128,0.6)';cx.lineWidth=2;
  const pos=[{x:20,y:25},{x:75,y:15},{x:85,y:55},{x:45,y:75},{x:12,y:58}];
  pos.forEach((p,i)=>{
    const s=document.createElement('div');s.className='mg-star-num';s.textContent=''+(i+1);
    s.style.left=p.x+'%';s.style.top=p.y+'%';s.dataset.idx=i+1;
    s.onclick=()=>{
      if(parseInt(s.dataset.idx)!==next)return;
      s.classList.add('mg-done');playNote(392+next*50,.12,'triangle',.1,sfxGain);
      if(next>1){const pv=pos[next-2];cx.beginPath();cx.moveTo(pv.x/100*480,pv.y/100*280);cx.lineTo(p.x/100*480,p.y/100*280);cx.stroke();}
      next++;sE.textContent=Math.min(next,tot)+'/'+tot;
      if(next>tot)st(()=>end(true),400);
    };
    a.appendChild(s);
  });
};

// 8. warmEgg - ì•Œ ë”°ëœ»í•˜ê²Œ
MG.warmEgg=(a,tE,sE,c,end,si,st)=>{
  let tmp=50,t=c.time||10;tE.textContent=t+'ì´ˆ';
  a.innerHTML='<div class="mg-egg">ğŸ¥š</div><div class="mg-temp-bg"><div class="mg-temp-fill" style="width:50%"></div></div>';
  const egg=a.querySelector('.mg-egg'),fill=a.querySelector('.mg-temp-fill');
  a.onclick=()=>{tmp=Math.min(100,tmp+7);egg.classList.remove('mg-bounce');void egg.offsetWidth;egg.classList.add('mg-bounce');};
  si(()=>{tmp=Math.max(0,tmp-1.8);fill.style.width=tmp+'%';fill.style.background=tmp>30?'var(--hope-color)':'var(--danger-color)';sE.textContent=tmp>50?'ë”°ëœ»í•´ìš” â˜€ï¸':'ì¶”ì›Œìš”... â„ï¸';if(tmp<=0)end(false);},100);
  si(()=>{t--;tE.textContent=t+'ì´ˆ';if(t<=0)end(tmp>20);},1000);
};

// 9. waveJump - íŒŒë„ ì í”„
MG.waveJump=(a,tE,sE,c,end,si,st)=>{
  let s=0,g=c.goal||5,jumping=false;
  sE.textContent='ğŸŒŠ 0/'+g;tE.textContent='';
  const pg=document.createElement('div');pg.className='mg-penguin';pg.textContent='ğŸ§';
  pg.style.cssText='position:absolute;bottom:30px;left:35%;';a.appendChild(pg);
  a.onclick=()=>{if(jumping)return;jumping=true;pg.style.bottom='100px';st(()=>{pg.style.bottom='30px';jumping=false;},500);};
  function wave(){
    if(s>=g)return;
    const w=document.createElement('div');w.className='mg-wave-el';w.textContent='ğŸŒŠ';
    let x=a.offsetWidth+30;w.style.cssText='position:absolute;bottom:15px;left:'+x+'px;font-size:30px;z-index:1;';a.appendChild(w);
    let checked=false;
    const mv=si(()=>{
      x-=4;w.style.left=x+'px';
      if(!checked&&x<a.offsetWidth*0.4&&x>a.offsetWidth*0.25){checked=true;if(jumping){s++;sE.textContent='ğŸŒŠ '+s+'/'+g;w.style.opacity='.3';playNote(523,.1,'sine',.08,sfxGain);if(s>=g)st(()=>end(true),300);}}
      if(x<-40){clearInterval(mv);w.remove();}
    },25);
    st(wave,1500+Math.random()*500);
  }
  st(wave,600);
};

// ===== HELPER FUNCTIONS =====
function setSadVignette(show){if(show)$('vignette').classList.add('show');else $('vignette').classList.remove('show');}
function activateCompanion(){GS.companion='chiku';buildScene(GS.sceneKey);}

// ===== CHOICES =====
function showChoices(choices){
  GS.choiceActive=true;
  const box=$('choices-box');
  box.innerHTML='';
  box.style.display='flex';
  choices.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='choice-btn';
    btn.textContent=c.text;
    btn.addEventListener('click',()=>{
      box.style.display='none';
      GS.choiceActive=false;
      if(c.action) c.action();
      if(c.flag) GS.flags[c.flag]=c.flagValue!==undefined?c.flagValue:true;
      if(c.hope) changeHope(c.hope);
      if(c.next) startDialogue(c.next);
      if(c.scene) loadScene(c.scene, c.playerX);
      if(c.chapter) showChapter(c.chapter, c.scene, c.playerX);
    });
    box.appendChild(btn);
  });
}

// ===== INVENTORY =====
function addItem(item){
  if(GS.items.find(i=>i.id===item.id))return;
  GS.items.push(item);
  playSfx('item');
  renderInventory();
  // Flash notification
  const notif=document.createElement('div');
  notif.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--ui-panel);border:1px solid var(--text-accent);color:var(--text-accent);padding:8px 20px;border-radius:8px;font-size:13px;z-index:100;animation:fadeInOut 2s forwards;';
  notif.textContent=`${item.icon} ${item.name} íšë“!`;
  document.body.appendChild(notif);
  setTimeout(()=>notif.remove(),2000);
}
function renderInventory(){
  const list=$('inv-list');
  if(GS.items.length===0){ list.innerHTML='<div id="inv-empty">ì•„ì§ ì•„ë¬´ê²ƒë„ ì—†ìŠµë‹ˆë‹¤...</div>'; return; }
  list.innerHTML='';
  GS.items.forEach(it=>{
    const d=document.createElement('div');
    d.className='inv-item';
    d.innerHTML=`<div class="inv-icon">${it.icon}</div><div class="inv-info"><div class="inv-name">${it.name}</div><div class="inv-desc">${it.desc}</div></div>`;
    list.appendChild(d);
  });
}
function pickupItem(gi){
  addItem({id:gi.id, name:gi.name, icon:gi.icon, desc:gi.desc});
  const el=document.querySelector(`[data-item-id="${gi.id}"]`);
  if(el) el.remove();
  if(gi.dialogue) startDialogue(gi.dialogue);
}
function toggleInventory(){
  $('inventory-panel').classList.toggle('open');
}

// ===== HOPE =====
function changeHope(delta){
  GS.hope=Math.max(0,Math.min(100,GS.hope+delta));
  $('hope-bar').style.width=GS.hope+'%';
  $('hope-label').textContent=GS.hope;
  if(delta>0) playSfx('hope');
  if(delta<0) playSfx('sad');
}

// ===== SCENE TRANSITIONS =====
function loadScene(key, playerX){
  if(GS.transitioning)return;
  GS.transitioning=true;
  GS.moving={up:false,down:false,left:false,right:false};
  $('scene').style.opacity=0;
  setTimeout(()=>{
    if(playerX!==undefined) GS.px=playerX;
    buildScene(key);
    updateHUD();
    $('scene').style.opacity=1;
    setTimeout(()=>{GS.transitioning=false;},300);
  },500);
}
function showChapter(ch, target, playerX){
  if(GS.transitioning)return;
  GS.transitioning=true;
  GS.moving={up:false,down:false,left:false,right:false};
  GS.chapter=ch;
  const info=CHAPTER_INFO[ch];
  const ov=$('chapter-overlay');
  ov.querySelector('.ch-num').textContent=`ì œ ${ch}ì¥`;
  ov.querySelector('.ch-title').textContent=info?.title||'';
  ov.querySelector('.ch-sub').textContent=info?.sub||'';
  ov.classList.add('show');
  setTimeout(()=>{
    ov.classList.remove('show');
    if(playerX!==undefined) GS.px=playerX;
    buildScene(target);
    updateHUD();
    $('scene').style.opacity=1;
    setTimeout(()=>{GS.transitioning=false;},500);
  },2500);
}
function showCutscene(lines, callback){
  GS.transitioning=true;
  const cs=$('cutscene');
  const ct=$('cutscene-text');
  cs.classList.add('show');
  $('vignette').classList.add('show');
  let idx=0;
  function showNext(){
    if(idx>=lines.length){
      cs.classList.remove('show');
      $('vignette').classList.remove('show');
      GS.transitioning=false;
      if(callback) callback();
      return;
    }
    ct.style.opacity=0;
    setTimeout(()=>{
      ct.textContent=lines[idx];
      ct.style.opacity=1;
      ct.style.transition='opacity 0.8s';
      idx++;
      setTimeout(showNext, 2500);
    },500);
  }
  showNext();
}
function updateHUD(){
  const info=CHAPTER_INFO[GS.chapter];
  $('chapter-label').textContent=info?`${info.title}`:'';
}

// ===== NPC INTERACT =====
function interactWithNPC(npc){
  if(Math.abs(GS.px-(npc.x||0))>80)return;
  if(npc.dialogue){
    const d=typeof npc.dialogue==='function'?npc.dialogue():npc.dialogue;
    startDialogue(d);
  }
}

// ===== SKINS =====
function applySkin(name){
  document.documentElement.dataset.skin=name||'';
  localStorage.setItem('ggg-skin',name||'');
  document.querySelectorAll('.skin-option').forEach(b=>{
    b.classList.toggle('active',b.dataset.skin===name);
  });
}

// ===== ENDING =====
function showEnding(type){
  stopMusic();
  GS.transitioning=true;
  const endings={
    hope:{
      title:'í¬ë§ì˜ ë¹›',
      text:'ìƒˆë¼ í­ê·„ì€ ì²˜ìŒìœ¼ë¡œ ë„“ì€ ë°”ë‹¤ë¥¼ ë³´ì•˜ìŠµë‹ˆë‹¤.\n\nì‘ì€ ë‚ ê°œë¥¼ í„ëŸ­ì´ë©° íŒŒë„ ì†ìœ¼ë¡œ ë“¤ì–´ê°€ëŠ” ëª¨ìŠµì„ ë°”ë¼ë³´ë©°,\në…¸ë“ ì€ ì˜¤ëœ ì„¸ì›” ë™ì•ˆ ê°€ìŠ´ì— í’ˆì–´ì™”ë˜ ë¬´ê±°ìš´ ì§ì´\nì¡°ê¸ˆì”© ë‚´ë ¤ë†“ì•„ì§€ëŠ” ê²ƒì„ ëŠê¼ˆìŠµë‹ˆë‹¤.\n\nê¸´ê¸´ë°¤ì´ ëë‚˜ê³ , ë§ˆì¹¨ë‚´ ì•„ì¹¨ì´ ì™”ìŠµë‹ˆë‹¤.'
    },
    together:{
      title:'í•¨ê»˜í•˜ëŠ” ì•„ì¹¨',
      text:'ë…¸ë“ ê³¼ ì‘ì€ í­ê·„ì€ ë°”ë‹·ê°€ì— ë‚˜ë€íˆ ì„°ìŠµë‹ˆë‹¤.\n\ní˜¼ìì˜€ë˜ ì‹œê°„, í•¨ê»˜í–ˆë˜ ì‹œê°„,\nê·¸ë¦¬ê³  ì•ìœ¼ë¡œ í•¨ê»˜í•  ì‹œê°„.\n\níŒŒë„ ì†Œë¦¬ê°€ ë‘ ì¹œêµ¬ì˜ ìƒˆë¡œìš´ ì‹œì‘ì„ ì¶•í•˜í•˜ë“¯\në¶€ë“œëŸ½ê²Œ ìš¸ë ¤ í¼ì¡ŒìŠµë‹ˆë‹¤.\n\nì´ì œ ê¸´ê¸´ë°¤ì€ ëë‚¬ê³ , ë”°ëœ»í•œ ì•„ì¹¨ì´ ì‹œì‘ë©ë‹ˆë‹¤.'
    },
    memory:{
      title:'ê¸°ì–µì˜ ë³„',
      text:'ë…¸ë“ ì€ í’ˆ ì•ˆì˜ ì¡°ì•½ëŒì„ ë§Œì ¸ë³´ì•˜ìŠµë‹ˆë‹¤.\nì½”ë¼ë¦¬ ì•„ì¤Œë§ˆì˜ ë”°ëœ»í•œ ëª©ì†Œë¦¬,\ní•¨ê»˜ ë‹¬ë ¸ë˜ ì´ˆì›ì˜ ë°”ëŒ,\nì•™ê°€ë¶€ê°€ ì§€ì¼œì¤€ ê·¸ ë°¤,\nì¹˜ì¿ ì˜ ì‘ì€ ìˆ¨ì†Œë¦¬...\n\nëª¨ë“  ë§Œë‚¨ì´ ë³„ì´ ë˜ì–´ ë°¤í•˜ëŠ˜ì„ ê°€ë“ ì±„ì› ìŠµë‹ˆë‹¤.\nê·¸ë¦¬ê³  ê·¸ ë³„ë¹› ì•„ë˜, ì‘ì€ í­ê·„ì´ ì²« íŒŒë„ë¥¼ ë§Œë‚¬ìŠµë‹ˆë‹¤.\n\nê¸´ê¸´ë°¤ì˜ ë³„ë“¤ì€ ì˜ì›íˆ ë¹›ë‚˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.'
    }
  };
  const e=endings[type]||endings.hope;
  $('ending-title').textContent=e.title;
  $('ending-text').textContent=e.text;
  $('ending-items').textContent=GS.items.length>0?'ìˆ˜ì§‘í•œ ê¸°ì–µ: '+GS.items.map(i=>i.icon+' '+i.name).join(', '):'';
  $('ending-screen').style.display='flex';
  // Ending music
  if(audioCtx){
    setTimeout(()=>{
      [329,392,523,659,784].forEach((f,i)=>setTimeout(()=>playNote(f,1.5,'sine',0.1,sfxGain),i*300));
    },500);
  }
}

function restartGame(){
  GS.chapter=0; GS.hope=60; GS.items=[]; GS.flags={};
  GS.px=200; GS.companion=null; GS.babyPenguin=false;
  GS.transitioning=false; GS.dialogueActive=false; GS.choiceActive=false;
  GS.facing='right'; GS.moving={up:false,down:false,left:false,right:false};
  $('ending-screen').style.display='none';
  $('dialogue-box').style.display='none';
  $('choices-box').style.display='none';
  $('vignette').classList.remove('show');
  $('cutscene').classList.remove('show');
  $('inventory-panel').classList.remove('open');
  $('hope-bar').style.width='60%';
  $('hope-label').textContent='60';
  renderInventory();
  stopMusic();
  showChapter(1,'ch1_orphanage',200);
}

// ===== CHAPTER INFO =====
const CHAPTER_INFO={
  1:{title:'ì½”ë¼ë¦¬ ê³ ì•„ì›',sub:'í˜¼ìê°€ ëœ ì•„ì´'},
  2:{title:'ì‚¬ë°”ë‚˜ì˜ ê°€ì¡±',sub:'ë„“ì€ ì´ˆì› ìœ„ì˜ ê¿ˆ'},
  3:{title:'ë™ë¬¼ì›',sub:'ì² ì°½ ë„ˆë¨¸ì˜ í•˜ëŠ˜'},
  4:{title:'íƒˆì¶œ',sub:'ë¬´ë„ˆì§€ëŠ” ë²½'},
  5:{title:'ì¹˜ì¿ ì™€ì˜ íƒí—˜',sub:'ë¹„ ì˜¤ëŠ” ë°¤ì˜ ì‘ì€ ì˜¨ê¸°'},
  6:{title:'ê¸´ê¸´ë°¤ì˜ ì—¬ì •',sub:'ë³„ë¹› ì•„ë˜ ê±·ëŠ” ê¸¸'},
  7:{title:'ì´ë³„',sub:'ê°€ì¥ ì–´ë‘ìš´ ìƒˆë²½'},
  8:{title:'ë°”ë‹¤ë¡œ',sub:'ì²« ë²ˆì§¸ ì•„ì¹¨'}
};

// ===== SCENE DEFINITIONS =====
const SCENES={
  // --- CHAPTER 1: Orphanage ---
  ch1_orphanage:{
    bg:'linear-gradient(180deg,#0a0a18 0%,#1a1020 40%,#3a2810 70%,#5a4020 100%)',
    ground:{height:'90px',bg:'linear-gradient(180deg,#4a3020,#3a2418)'},
    stars:40,
    grassCount:20,
    grassColor:'linear-gradient(to top,#3a3020,#5a4a30)',
    music:'orphanage',
    bounds:{left:20,right:900},
    decorations:[
      {style:'left:100px;bottom:90px;width:80px;height:60px;background:linear-gradient(135deg,#4a3a28,#3a2a1a);border-radius:8px 8px 0 0;opacity:0.6;',html:'<div style="position:absolute;top:10px;left:15px;width:12px;height:15px;background:rgba(255,200,100,0.3);border-radius:2px;"></div>'},
      {style:'left:400px;bottom:90px;width:120px;height:50px;background:linear-gradient(135deg,#5a4a30,#4a3a20);border-radius:6px;opacity:0.5;'},
      {style:'left:600px;bottom:90px;font-size:40px;pointer-events:none;opacity:0.3;',html:'&#127795;'}
    ],
    npcs:[
      {id:'elephant',name:'ì½”ë¼ë¦¬ ì•„ì¤Œë§ˆ',x:350,
       sprite:'<div style="width:60px;height:50px;position:relative;pointer-events:none;"><div style="position:absolute;width:50px;height:35px;background:linear-gradient(135deg,#8a8a80,#6a6a60);border-radius:25px 20px 8px 8px;bottom:10px;left:5px;"></div><div style="position:absolute;width:18px;height:25px;background:#7a7a70;border-radius:0 0 8px 8px;bottom:10px;left:35px;transform:rotate(10deg);"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:10px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:22px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:32px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:42px;"></div><div style="position:absolute;width:3px;height:3px;background:#222;border-radius:50%;bottom:36px;left:44px;"></div></div>',
       dialogue:()=>[
         {speaker:'ì½”ë¼ë¦¬ ì•„ì¤Œë§ˆ',text:'ë…¸ë“ ì•„, ì•„ì§ ì•ˆ ì¤ë‹ˆ? ë³„ì´ ì°¸ ë°ì€ ë°¤ì´êµ¬ë‚˜.'},
         {minigame:'starCatch',mgCfg:{title:'ë°¤í•˜ëŠ˜ì˜ ë³„',desc:'ë°˜ì§ì´ëŠ” ë³„ì„ ì°¾ì•„ í´ë¦­í•˜ì„¸ìš”!',goal:5,time:10},onSuccess:()=>changeHope(3)},
         {speaker:'ë…¸ë“ ',text:'ì•„ì¤Œë§ˆ... ë‚˜ëŠ” ì™œ ë‹¤ë¥¸ ì• ë“¤ì´ë‘ ë‹¤ë¥´ê²Œ ìƒê²¼ì–´ìš”?'},
         {speaker:'ì½”ë¼ë¦¬ ì•„ì¤Œë§ˆ',text:'ë‹¤ë¥´ë‹¤ê³ ? í•˜í•˜, ë„¤ê°€ íŠ¹ë³„í•œ ê±°ë€ë‹¤. ë„ˆì˜ ì—„ë§ˆë„ ì•„ì£¼ ë©‹ì§„ ì½”ë¿”ì†Œì˜€ì–´.'},
         {speaker:'ì½”ë¼ë¦¬ ì•„ì¤Œë§ˆ',text:'ë„¤ ì—„ë§ˆê°€ ë‚¨ê¸´ ê²Œ í•˜ë‚˜ ìˆë‹¨ë‹¤. ì´ ì‘ì€ ì¡°ì•½ëŒ... í•­ìƒ ê°€ì§€ê³  ë‹¤ë…€ë ´.'},
         {action:()=>addItem({id:'pebble',name:'ì—„ë§ˆì˜ ì¡°ì•½ëŒ',icon:'ğŸª¨',desc:'ì—„ë§ˆì˜ ê¸°ì–µì´ ë‹´ê¸´ ì‘ê³  ë§¤ë„ëŸ¬ìš´ ì¡°ì•½ëŒ'})},
         {speaker:'ì½”ë¼ë¦¬ ì•„ì¤Œë§ˆ',text:'ì„¸ìƒì€ ë„“ê³ , ë•Œë¡œëŠ” ë¬´ì„­ê¸°ë„ í•˜ì§€ë§Œ... ë„ˆë¼ë©´ ê´œì°®ì„ ê±°ì•¼.'},
         {speaker:'ë…¸ë“ ',text:'...ê³ ë§ˆì›Œìš”, ì•„ì¤Œë§ˆ.'},
         {action:()=>changeHope(5)}
       ]
      }
    ],
    exits:[
      {x:880,type:'dialogue',dialogue:[
        {speaker:'ë…¸ë“ ',text:'(ê³ ì•„ì›ì˜ ëì´ë‹¤. ì € ë„ˆë¨¸ì—ëŠ” ë„“ì€ ì„¸ìƒì´ ìˆê² ì§€...)'},
        {minigame:'mash',mgCfg:{title:'ìš©ê¸°ë¥¼ ë‚´ì„œ!',desc:'ì—°íƒ€í•´ì„œ ìš©ê¸°ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!',icon:'ğŸ’ª',label:'ìš©ê¸°ë¥¼ ë‚´ì!',time:6},onSuccess:()=>changeHope(3)},
        {choice:[
          {text:'ì„¸ìƒì„ ë³´ëŸ¬ ë– ë‚˜ë³¼ê¹Œ',flag:'leftEarly',hope:5,chapter:2,scene:'ch2_savanna',playerX:80},
          {text:'ì¡°ê¸ˆ ë” ì—¬ê¸° ìˆì„ê¹Œ',next:[
            {speaker:'ë…¸ë“ ',text:'(ì•„ì§ì€... ì¡°ê¸ˆ ë” ì´ê³³ì— ìˆê³  ì‹¶ë‹¤.)'},
            {action:()=>{GS.px=700;GS.transitioning=false;const p=$('player');if(p)p.style.left='700px';}}
          ]}
        ]}
      ]}
    ]
  },

  // --- CHAPTER 2: Savanna ---
  ch2_savanna:{
    bg:'linear-gradient(180deg,#080818 0%,#0a0a20 30%,#1a1828 60%,#2a2820 100%)',
    ground:{height:'80px',bg:'linear-gradient(180deg,#3a4a20,#2a3a18)'},
    stars:60,
    grassCount:35,
    music:'savanna',
    bounds:{left:20,right:1000},
    decorations:[
      {style:'left:200px;bottom:80px;width:4px;height:100px;background:#4a3a20;',html:'<div style="position:absolute;top:-20px;left:-20px;width:44px;height:30px;background:radial-gradient(ellipse,#3a5a20,transparent);border-radius:50%;"></div>'},
      {style:'left:700px;bottom:80px;width:4px;height:80px;background:#4a3a20;',html:'<div style="position:absolute;top:-15px;left:-15px;width:34px;height:25px;background:radial-gradient(ellipse,#3a5a20,transparent);border-radius:50%;"></div>'}
    ],
    npcs:[
      {id:'rhino_family',name:'ì½”ë¿”ì†Œ ê°€ì¡±',x:500,
       sprite:'<div style="width:80px;height:40px;position:relative;pointer-events:none;"><div style="position:absolute;width:40px;height:26px;background:linear-gradient(135deg,#7a7a7a,#5a5a5a);border-radius:18px 15px 6px 6px;bottom:8px;left:0;"></div><div style="position:absolute;width:35px;height:22px;background:linear-gradient(135deg,#8a8a8a,#6a6a6a);border-radius:15px 12px 5px 5px;bottom:8px;left:40px;"></div><div style="position:absolute;width:5px;height:10px;background:#c0b090;border-radius:3px;bottom:28px;left:60px;"></div></div>',
       dialogue:()=>{
         if(GS.flags.metFamily) return [
           {speaker:'ì½”ë¿”ì†Œ ê°€ì¡±',text:'ë…¸ë“ , í•¨ê»˜ë¼ì„œ ì¢‹êµ¬ë‚˜. ì˜¤ëŠ˜ ë°¤ ë³„ì´ ì°¸ ë§ë‹¤.'},
           {minigame:'starCatch',mgCfg:{title:'ë°¤í•˜ëŠ˜ì˜ ë³„',desc:'ê°€ì¡±ê³¼ í•¨ê»˜ ë³„ì„ ì°¾ì•„ë³´ì„¸ìš”!',goal:4,time:8},onSuccess:()=>changeHope(2)},
           {speaker:'ë…¸ë“ ',text:'ë„¤... ê°€ì¡±ì´ ìˆë‹¤ëŠ” ê²Œ ì´ëŸ° ê±°êµ°ìš”.'}
         ];
         GS.flags.metFamily=true;
         return [
           {speaker:'???',text:'ì–´ë¼? ë„ˆ... í˜¹ì‹œ ì½”ë¿”ì†Œë‹ˆ?'},
           {speaker:'ë…¸ë“ ',text:'ë„¤! ì €... ì½”ë¿”ì†Œì˜ˆìš”. ì²˜ìŒ ë§Œë‚˜ìš”, ê°™ì€ ì½”ë¿”ì†Œë¥¼.'},
           {speaker:'ì½”ë¿”ì†Œ',text:'ì„¸ìƒì—, ì´ë ‡ê²Œ ì–´ë¦° ì½”ë¿”ì†Œê°€ í˜¼ì ëŒì•„ë‹¤ë‹ˆë‹¤ë‹ˆ. ìš°ë¦¬ ê°€ì¡±ê³¼ í•¨ê»˜í•˜ì§€ ì•Šì„ë˜?'},
           {speaker:'ë…¸ë“ ',text:'ì •ë§ìš”? ì •ë§... ê°™ì´ ìˆì–´ë„ ë¼ìš”?'},
           {speaker:'ì½”ë¿”ì†Œ',text:'ë¬¼ë¡ ì´ì§€. ì—¬ê¸°ê°€ ë„¤ ìë¦¬ì•¼, ë…¸ë“ .'},
           {minigame:'heartBeat',mgCfg:{title:'ë‘ê·¼ë‘ê·¼',desc:'ğŸ’›ì´ ì› ì•ˆì— ì˜¬ ë•Œ í´ë¦­í•˜ì„¸ìš”!',goal:3,total:5},onSuccess:()=>changeHope(3)},
           {action:()=>changeHope(15)},
           {speaker:'',text:'(ë…¸ë“ ì€ ìƒì „ ì²˜ìŒìœ¼ë¡œ ê°€ì¡±ì´ë¼ëŠ” ê±¸ ì•Œê²Œ ë˜ì—ˆë‹¤.)'}
         ];
       }
      }
    ],
    groundItems:[
      {id:'horn_piece',name:'ê°€ì¡±ì˜ ë¿”ì¡°ê°',icon:'ğŸ¦',desc:'ë¶€ì„œì§„ ë¿”ì˜ ì‘ì€ ì¡°ê°. ê°€ì¡±ì˜ ê¸°ì–µ.',x:620,
       condition:()=>GS.flags.poachersAppeared,
       dialogue:[{speaker:'ë…¸ë“ ',text:'(ì´ê±´... ì´ê±´ ê°€ì¡±ì˜...)'},
         {action:()=>changeHope(-10)}]
      }
    ],
    exits:[
      {x:950,type:'dialogue',
       condition:()=>GS.flags.metFamily,
       dialogue:[
         {speaker:'',text:'(í–‰ë³µí•œ ì‹œê°„ì´ íë¥´ê³  ìˆì—ˆë‹¤. ê·¸ëŸ¬ë‚˜...)'},
         {action:()=>{
           GS.flags.poachersAppeared=true;
           $('vignette').classList.add('show');
           playSfx('sad');
         }},
         {speaker:'',text:'ì–´ë‘  ì†ì—ì„œ ë‚ ì¹´ë¡œìš´ ì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.'},
         {speaker:'',text:'ë°€ë µê¾¼ë“¤ì´ì—ˆë‹¤.'},
         {minigame:'dodge',mgCfg:{title:'ë„ë§ì³!',desc:'í´ë¦­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìœ„í—˜ì„ í”¼í•˜ì„¸ìš”!',icon:'âš¡',time:7},onSuccess:()=>changeHope(3)},
         {speaker:'',text:'ë…¸ë“ ì€ ë„ë§ì³¤ë‹¤. ë’¤ë¥¼ ëŒì•„ë³¼ ìˆ˜ ì—†ì—ˆë‹¤.'},
         {speaker:'',text:'...'},
         {speaker:'',text:'ê°€ì¡±ì€, ë” ì´ìƒ ì—†ì—ˆë‹¤.'},
         {action:()=>{
           changeHope(-20);
           $('vignette').classList.remove('show');
         }},
         {speaker:'ë…¸ë“ ',text:'(ì™œ... ì™œ ë‚˜ë§Œ ì‚´ì•„ë‚¨ì€ ê±¸ê¹Œ...)'},
         {choice:[
           {text:'ì•ìœ¼ë¡œ ë‚˜ì•„ê°„ë‹¤',chapter:3,scene:'ch3_zoo',playerX:100},
           {text:'(ë§ì—†ì´ ê±·ëŠ”ë‹¤)',hope:-5,chapter:3,scene:'ch3_zoo',playerX:100}
         ]}
       ]
      }
    ]
  },

  // --- CHAPTER 3: Zoo ---
  ch3_zoo:{
    bg:'linear-gradient(180deg,#0a0a10 0%,#10101a 50%,#1a1a24 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#3a3a3a,#2a2a2a)'},
    music:'zoo',
    bounds:{left:30,right:850},
    decorations:[
      // Cage bars
      ...[0,1,2,3,4,5,6,7,8,9,10,11,12].map(i=>({
        style:`left:${60+i*70}px;bottom:70px;width:4px;height:200px;background:linear-gradient(180deg,#5a5a5a,#3a3a3a);border-radius:2px;opacity:0.5;`
      })),
      {style:'left:0;bottom:260px;width:100%;height:4px;background:#4a4a4a;opacity:0.5;'},
      {style:'left:50%;bottom:280px;font-size:12px;color:#5a5a5a;transform:translateX(-50%);white-space:nowrap;',html:'[ ì‹œë¦½ë™ë¬¼ì› - í°ë°”ìœ„ì½”ë¿”ì†Œ ]'}
    ],
    npcs:[
      {id:'angabu',name:'ì•™ê°€ë¶€',x:550,
       sprite:'<div style="width:40px;height:35px;position:relative;pointer-events:none;"><div style="position:absolute;width:32px;height:24px;background:linear-gradient(135deg,#c08040,#a06830);border-radius:12px;bottom:8px;left:4px;"></div><div style="position:absolute;width:14px;height:12px;background:#b07030;border-radius:7px;bottom:24px;left:20px;"></div><div style="position:absolute;width:3px;height:3px;background:#222;border-radius:50%;bottom:28px;left:28px;"></div><div style="position:absolute;width:6px;height:8px;background:#a06830;border-radius:0 0 3px 3px;bottom:0;left:10px;"></div><div style="position:absolute;width:6px;height:8px;background:#a06830;border-radius:0 0 3px 3px;bottom:0;left:22px;"></div></div>',
       dialogue:()=>{
         if(GS.flags.metAngabu) return [
           {speaker:'ì•™ê°€ë¶€',text:'ë…¸ë“ , ì˜¤ëŠ˜ë„ í•˜ëŠ˜ì„ ë´¤ì–´? ì € í‹ˆ ì‚¬ì´ë¡œ ë³´ì´ëŠ” ë³„ ë§ì´ì•¼.'},
           {minigame:'starCatch',mgCfg:{title:'í‹ˆìƒˆì˜ ë³„',desc:'ë³´ì´ëŠ” ë³„ì„ í´ë¦­í•˜ì„¸ìš”!',goal:3,time:8},onSuccess:()=>changeHope(2)},
           {speaker:'ë…¸ë“ ',text:'ì‘... ì‘ì€ ë³„ì¸ë°, ë³¼ ë•Œë§ˆë‹¤ ì¡°ê¸ˆ ìœ„ì•ˆì´ ë¼.'},
           {speaker:'ì•™ê°€ë¶€',text:'ìš°ë¦¬ë„ ì–¸ì  ê°€ ì € ë³„ ì•„ë˜ ì„œê²Œ ë  ê±°ì•¼. ë¯¿ì–´.'},
           {minigame:'heartBeat',mgCfg:{title:'í¬ë§ì˜ ë°•ë™',desc:'ğŸ’›ì´ ì› ì•ˆì— ì˜¬ ë•Œ í´ë¦­í•˜ì„¸ìš”!',goal:2,total:3},onSuccess:()=>changeHope(2)}
         ];
         GS.flags.metAngabu=true;
         return [
           {speaker:'???',text:'ì´ë´, ìƒˆë¡œ ì˜¨ ê±°ì•¼? ë‚˜ëŠ” ì•™ê°€ë¶€. ì—¬ê¸° ì‚° ì§€ ì¢€ ëì§€.'},
           {speaker:'ë…¸ë“ ',text:'...ë‚˜ëŠ” ë…¸ë“ ì´ì•¼.'},
           {speaker:'ì•™ê°€ë¶€',text:'ê·¸ë ‡ê²Œ ìŠ¬í”ˆ ëˆˆì„ í•˜ê³  ìˆêµ¬ë‚˜. ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆì–´?'},
           {speaker:'ë…¸ë“ ',text:'ê°€ì¡±ì„... ìƒì—ˆì–´.'},
           {speaker:'ì•™ê°€ë¶€',text:'...ë‚˜ë„ ê·¸ë˜. ì—¬ê¸° ìˆëŠ” ê±´ ë‹¤ ê·¸ëŸ° ì‚¬ì—°ì´ ìˆì–´.'},
           {speaker:'ì•™ê°€ë¶€',text:'í•˜ì§€ë§Œ ë§ì´ì•¼, ë‚˜ëŠ” í¬ê¸°í•˜ì§€ ì•Šì•„. ì–¸ì  ê°€ ì—¬ê¸°ì„œ ë‚˜ê°ˆ ê±°ì•¼.'},
           {minigame:'findLight',mgCfg:{title:'ì² ì°½ ë„ˆë¨¸ì˜ ë³„',desc:'ì–´ë‘  ì† ë¹›ì„ ì°¾ì•„ í´ë¦­í•˜ì„¸ìš”',goal:3,time:10},onSuccess:()=>changeHope(3)},
           {speaker:'ì•™ê°€ë¶€',text:'ì´ê±° ë°›ì•„. ë‚´ê°€ ì•„ë¼ëŠ” ê±´ë°... ë„ˆí•œí…Œ ì¤„ê²Œ.'},
           {action:()=>addItem({id:'angabu_gift',name:'ì•™ê°€ë¶€ì˜ ì„ ë¬¼',icon:'ğŸŒ°',desc:'ì•™ê°€ë¶€ê°€ ì†Œì¤‘íˆ ê°„ì§í•˜ë˜ ì‘ì€ ë„í† ë¦¬'})},
           {speaker:'ë…¸ë“ ',text:'...ê³ ë§ˆì›Œ, ì•™ê°€ë¶€.'},
           {action:()=>changeHope(10)}
         ];
       }
      }
    ],
    exits:[
      {x:830,type:'dialogue',
       condition:()=>GS.flags.metAngabu&&!GS.flags.angabuDied,
       dialogue:[
         {speaker:'',text:'(ì–´ëŠ ë‚  ë°¤, ë™ë¬¼ì›ì— ë‚¯ì„  ì‚¬ëŒë“¤ì´ ë“¤ì–´ì™”ë‹¤.)'},
         {speaker:'',text:'(ê·¸ë“¤ì˜ ëˆˆì€ ì–´ë‘  ì†ì—ì„œë„ ì°¨ê°‘ê²Œ ë¹›ë‚¬ë‹¤. ë¿”ì„ ë…¸ë¦¬ëŠ” ì‚¬ëƒ¥ê¾¼ë“¤ì´ì—ˆë‹¤.)'},
         {speaker:'ì•™ê°€ë¶€',text:'ë…¸ë“ , ìˆ¨ì–´! ì € ì‚¬ëŒë“¤ì€ ìœ„í—˜í•´!'},
         {minigame:'dodge',mgCfg:{title:'ìˆ¨ì–´!',desc:'í´ë¦­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìœ„í—˜ì„ í”¼í•˜ì„¸ìš”!',icon:'ğŸ”¦',time:5},onSuccess:()=>changeHope(2)},
         {speaker:'ë…¸ë“ ',text:'ì•™ê°€ë¶€, ë„ˆë„ ë¹¨ë¦¬!'},
         {speaker:'ì•™ê°€ë¶€',text:'ë‚˜ëŠ” ê´œì°®ì•„. ë‚˜ëŠ” ë¿”ì´ ì—†ìœ¼ë‹ˆê¹Œ. ë¹¨ë¦¬ ìˆ¨ì–´, ë…¸ë“ !'},
         {speaker:'',text:'(ì•™ê°€ë¶€ëŠ” ë…¸ë“ ì„ ê°ì¶”ë ¤ê³  ì‚¬ëƒ¥ê¾¼ë“¤ ì•ì„ ê°€ë¡œë§‰ì•˜ë‹¤.)'},
         {speaker:'',text:'(ì´ì†Œë¦¬ê°€ ë°¤ì„ ì°¢ì—ˆë‹¤.)'},
         {action:()=>{playSfx('sad');setSadVignette(true);}},
         {speaker:'ë…¸ë“ ',text:'ì•™ê°€ë¶€...!! ì•ˆ ë¼!!'},
         {speaker:'',text:'(ì•™ê°€ë¶€ëŠ” ì“°ëŸ¬ì§€ë©´ì„œë„ ë…¸ë“ ì„ í–¥í•´ ê³ ê°œë¥¼ ëŒë ¸ë‹¤.)'},
         {speaker:'ì•™ê°€ë¶€',text:'...ë„ë§ê°€, ë…¸ë“ . ì‚´ì•„ì•¼ í•´.'},
         {speaker:'ì•™ê°€ë¶€',text:'ì € ë³„... ê¸°ì–µí•˜ì§€? ê±°ê¸°ì„œ... ë³¼ê²Œ.'},
         {speaker:'',text:'(ì•™ê°€ë¶€ì˜ ëˆˆì´ ì²œì²œíˆ ê°ê²¼ë‹¤.)'},
         {action:()=>{GS.flags.angabuDied=true;changeHope(-20);}},
         {speaker:'ë…¸ë“ ',text:'ì•™ê°€ë¶€... ì•™ê°€ë¶€...!'},
         {speaker:'',text:'(ë…¸ë“ ì€ ì´ë¥¼ ì•…ë¬¼ì—ˆë‹¤. ë˜ ìƒì—ˆë‹¤. ë˜.)'},
         {speaker:'',text:'(í•˜ì§€ë§Œ ì•™ê°€ë¶€ì˜ ë§ˆì§€ë§‰ ë§ì´ ê·“ê°€ì— ë§´ëŒì•˜ë‹¤. "ì‚´ì•„ì•¼ í•´.")'},
         {speaker:'ë…¸ë“ ',text:'...ì‚´ì•„ì•¼ í•´. ì‚´ ê±°ì•¼.'},
         {action:()=>setSadVignette(false)}
       ]
      },
      {x:830,type:'chapter',chapter:4,target:'ch4_escape',playerX:80,
       condition:()=>GS.flags.angabuDied}
    ]
  },

  // --- CHAPTER 4: Escape ---
  ch4_escape:{
    bg:'linear-gradient(180deg,#1a0808 0%,#2a1010 40%,#3a1808 70%,#4a2010 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#3a2a20,#2a1a10)'},
    music:'escape',
    bounds:{left:20,right:900},
    decorations:[
      // Fire/smoke effects
      ...[0,1,2,3,4].map(i=>({
        style:`left:${100+i*180}px;bottom:70px;width:40px;height:60px;background:radial-gradient(ellipse at bottom,rgba(200,80,20,0.4),transparent);border-radius:50%;animation:sway ${1+Math.random()}s infinite alternate;`
      })),
      // Broken bars
      ...[0,1,2].map(i=>({
        style:`left:${200+i*120}px;bottom:70px;width:4px;height:80px;background:#4a4a4a;transform:rotate(${-15+i*12}deg);opacity:0.4;`
      })),
      {style:'left:50%;top:30px;font-size:14px;color:#c04030;transform:translateX(-50%);white-space:nowrap;animation:blink 0.5s infinite;',html:'í­ë°œìŒê³¼ ë¹„ëª…ì´ ìš¸ë ¤ í¼ì§„ë‹¤'}
    ],
    npcs:[
      {id:'chiku_escape',name:'ì¹˜ì¿ ',x:500,
       condition:()=>!GS.flags.metChiku,
       sprite:'<div style="width:18px;height:22px;position:relative;pointer-events:none;"><div style="position:absolute;bottom:0;left:3px;width:12px;height:16px;background:radial-gradient(ellipse,#1a1a2a,#0a0a15);border-radius:40% 40% 35% 35%;"></div><div style="position:absolute;bottom:1px;left:5px;width:8px;height:10px;background:radial-gradient(ellipse,#f0f0e8,#d8d8d0);border-radius:40% 40% 35% 35%;"></div><div style="position:absolute;top:0;left:3px;width:10px;height:10px;background:radial-gradient(ellipse,#1a1a2a,#0a0a15);border-radius:50%;"></div><div style="position:absolute;top:3px;right:4px;width:2px;height:2px;background:#fff;border-radius:50%;"></div><div style="position:absolute;top:5px;right:1px;width:4px;height:2px;background:#d4a040;clip-path:polygon(0 0,100% 50%,0 100%);"></div><div style="position:absolute;bottom:2px;left:-6px;width:8px;height:10px;background:radial-gradient(ellipse,#f5f0e0,#e0d8c0);border-radius:45% 45% 50% 50%;box-shadow:0 0 4px rgba(255,250,220,.2);"></div></div>',
       dialogue:()=>[
         {speaker:'',text:'(ì—°ê¸°ì™€ ë¹„ëª… ì†ì—ì„œ, ì‘ì€ ê·¸ë¦¼ìê°€ ë–¨ê³  ìˆì—ˆë‹¤.)'},
         {speaker:'',text:'(ì•Œ í•˜ë‚˜ë¥¼ ê¼­ ì•ˆì€ ì±„, ê°ˆ ê³³ì„ ìƒì€ ì‘ì€ í­ê·„.)'},
         {minigame:'dodge',mgCfg:{title:'ì—°ê¸°ë¥¼ í”¼í•´!',desc:'í´ë¦­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìœ„í—˜ì„ í”¼í•˜ì„¸ìš”',icon:'ğŸ’¨',time:6},onSuccess:()=>changeHope(3)},
         {speaker:'ë…¸ë“ ',text:'...ê±°ê¸° ê´œì°®ì•„? ìœ„í—˜í•´, ë¹¨ë¦¬ ë‚˜ê°€ì•¼ í•´!'},
         {speaker:'???',text:'...ì•Œì´... ì•Œì„ ì§€ì¼œì•¼ í•´... ì´ ì•„ì´ë¥¼...'},
         {speaker:'ë…¸ë“ ',text:'ì•Œ? ë„¤ ì•„ì´ì•¼?'},
         {speaker:'???',text:'ë‚˜ëŠ” ì¹˜ì¿ ... ì´ê±´ ë‚´ ì•„ì´ì˜ ì•Œì´ì•¼. ì œë°œ... ë„ì™€ì¤˜.'},
         {choice:[
           {text:'ì¹˜ì¿ ì™€ ì•Œì„ ì§€í‚¤ë©° í•¨ê»˜ ë‹¬ë¦°ë‹¤',flag:'metChiku',hope:10,next:[
             {speaker:'ë…¸ë“ ',text:'ë‚´ ë’¤ì— ë¶™ì–´. ë‚´ê°€ ê¸¸ì„ ì—´ê²Œ.'},
             {minigame:'mash',mgCfg:{title:'ë¶ˆê¸¸ íƒˆì¶œ!',desc:'ì—°íƒ€í•´ì„œ ì¶œêµ¬ë¥¼ í–¥í•´ ëŒì§„í•˜ì„¸ìš”!',icon:'ğŸ”¥',label:'ëš«ê³  ë‚˜ê°€ì!',time:7},onSuccess:()=>changeHope(5)},
             {speaker:'ì¹˜ì¿ ',text:'...ê³ ë§ˆì›Œ.'},
             {speaker:'',text:'(ë…¸ë“ ì€ ì»¤ë‹¤ë€ ëª¸ìœ¼ë¡œ ì—°ê¸°ì™€ ë¶ˆì„ í—¤ì¹˜ë©° ë‹¬ë ¸ë‹¤.\nì‘ì€ ì¹˜ì¿ ëŠ” ì•Œì„ ì•ˆê³  ë…¸ë“ ì˜ ê·¸ë¦¼ì ì†ì—ì„œ ë”°ë¼ì™”ë‹¤.)'},
             {speaker:'ì¹˜ì¿ ',text:'ì´ìª½ì— ë¹›ì´ ë³´ì—¬! ì¶œêµ¬ì•¼!'},
             {action:()=>{activateCompanion();playSfx('hope');}},
             {speaker:'',text:'(ì¹˜ì¿ ê°€ ë™ë°˜ìë¡œ í•¨ê»˜í•˜ê²Œ ë˜ì—ˆë‹¤.)'}
           ]},
           {text:'ì•Œì„ ëŒ€ì‹  ë“¤ì–´ì¤€ë‹¤',flag:'metChiku',hope:15,next:[
             {speaker:'ë…¸ë“ ',text:'ë‚´ê°€ ì•Œì„ ë“¤ê²Œ. ë„Œ ë‚´ ë’¤ì—ì„œ ë”°ë¼ì™€.'},
             {minigame:'mash',mgCfg:{title:'ë¶ˆê¸¸ íƒˆì¶œ!',desc:'ì—°íƒ€í•´ì„œ ì¶œêµ¬ë¥¼ í–¥í•´ ëŒì§„í•˜ì„¸ìš”!',icon:'ğŸ”¥',label:'ëš«ê³  ë‚˜ê°€ì!',time:7},onSuccess:()=>changeHope(5)},
             {speaker:'ì¹˜ì¿ ',text:'...ì •ë§? ì¡°ì‹¬í•´ì„œ... ë”°ëœ»í•˜ê²Œ í•´ì¤˜ì•¼ í•´.'},
             {speaker:'',text:'(ë…¸ë“ ì€ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì•Œì„ ë¿” ì‚¬ì´ì— ì˜¬ë ¤ë†“ì•˜ë‹¤.)'},
             {speaker:'ì¹˜ì¿ ',text:'...ì»¤ë‹¤ë€ ì½”ë¿”ì†Œê°€ í­ê·„ ì•Œì„ í’ˆë‹¤ë‹ˆ. ì´ìƒí•œ ë°¤ì´ì•¼.'},
             {speaker:'ë…¸ë“ ',text:'ì§€ê¸ˆì€ ì´ìƒí•œ ê²Œ ë‹¹ì—°í•œ ë°¤ì´ë‹ˆê¹Œ.'},
             {action:()=>{activateCompanion();playSfx('hope');}},
             {speaker:'',text:'(ì¹˜ì¿ ê°€ ë™ë°˜ìë¡œ í•¨ê»˜í•˜ê²Œ ë˜ì—ˆë‹¤.)'}
           ]}
         ]}
       ]
      }
    ],
    exits:[
      {x:880,type:'chapter',chapter:5,target:'ch5_forest',playerX:80,
       condition:()=>GS.flags.metChiku}
    ]
  },

  // --- CHAPTER 5: Forest - Resting with Chiku ---
  ch5_forest:{
    bg:'linear-gradient(180deg,#080810 0%,#101018 40%,#181820 70%,#1a1a22 100%)',
    ground:{height:'80px',bg:'linear-gradient(180deg,#1a2a18,#142014)'},
    rain:true,
    grassCount:25,
    grassColor:'linear-gradient(to top,#1a2a18,#2a3a22)',
    music:'forest',
    bounds:{left:20,right:900},
    decorations:[
      // Dark trees
      ...[0,1,2,3].map(i=>({
        style:`left:${80+i*220}px;bottom:80px;width:8px;height:140px;background:#1a1a14;`,
        html:`<div style="position:absolute;top:-30px;left:-30px;width:68px;height:50px;background:radial-gradient(ellipse,#1a2a14,transparent);border-radius:50%;"></div>`
      }))
    ],
    npcs:[
      {id:'chiku_rest',name:'ì¹˜ì¿ ',x:450,
       condition:()=>!GS.flags.forestTalk,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'',text:'(ë¹„ê°€ ë‚´ë¦¬ëŠ” ìˆ²ì—ì„œ ë‘˜ì€ ì ì‹œ ì‰¬ê¸°ë¡œ í–ˆë‹¤.)'},
         {minigame:'rainCatch',mgCfg:{title:'ë¹—ë°©ìš¸ ëª¨ìœ¼ê¸°',desc:'ë–¨ì–´ì§€ëŠ” ë¹—ë°©ìš¸ì„ í´ë¦­ìœ¼ë¡œ ëª¨ì•„ë³´ì„¸ìš”',goal:6,time:12},onSuccess:()=>changeHope(3)},
         {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ ... ì•„ê¹ŒëŠ” ì •ë§ ë¬´ì„œì› ì–´. ê³ ë§ˆì›Œ, ì§€ì¼œì¤˜ì„œ.'},
         {speaker:'ë…¸ë“ ',text:'...ë‚˜ë„ ë¬´ì„œì› ì–´. í•˜ì§€ë§Œ í˜¼ìê°€ ì•„ë‹ˆì–´ì„œ ë‹¬ë¦´ ìˆ˜ ìˆì—ˆì–´.'},
         {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ ì€ ì™œ ê·¸ê³³ì— ìˆì—ˆì–´? ë™ë¬¼ì›ì—.'},
         {speaker:'ë…¸ë“ ',text:'ê°€ì¡±ì„ ìƒê³ ... ì¡í˜€ì™”ì–´. ê±°ê¸°ì„œ ì•™ê°€ë¶€ë¼ëŠ” ì¹œêµ¬ë¥¼ ë§Œë‚¬ëŠ”ë°...'},
         {speaker:'ë…¸ë“ ',text:'ê·¸ ì¹œêµ¬ë„... ë‚˜ë¥¼ ì§€í‚¤ë ¤ë‹¤ ì‚¬ëƒ¥ê¾¼ì—ê²Œ...'},
         {speaker:'ì¹˜ì¿ ',text:'...'},
         {speaker:'ë…¸ë“ ',text:'ìê¾¸ ìƒê¸°ë§Œ í•´. ì†Œì¤‘í•œ ê²ƒë“¤ì„.'},
         {speaker:'ì¹˜ì¿ ',text:'ë‚˜ë„ ê·¸ë˜. ì´ ì•Œì˜ ì•„ë¹ ë„... ì´ë¯¸ ì—†ì–´.'},
         {speaker:'ì¹˜ì¿ ',text:'í•˜ì§€ë§Œ ì´ ì•„ì´ë§Œì€ ì§€í‚¤ê³  ì‹¶ì–´. ë°”ë‹¤ì—ì„œ í‚¤ì›Œì•¼ í•´. í­ê·„ì€ ë°”ë‹¤ì—ì„œ ì‚´ì•„ì•¼ í•˜ë‹ˆê¹Œ.'},
         {speaker:'ë…¸ë“ ',text:'ë°”ë‹¤... ë‚˜ë„ ë°”ë‹¤ë¥¼ ë³´ê³  ì‹¶ì–´. í•œ ë²ˆë„ ë³¸ ì  ì—†ê±°ë“ .'},
         {speaker:'ì¹˜ì¿ ',text:'ê·¸ëŸ¼... ê°™ì´ ê°€ì, ë°”ë‹¤ê¹Œì§€.'},
         {speaker:'ë…¸ë“ ',text:'...ê·¸ë˜. ê°™ì´ ê°€ì, ì¹˜ì¿ .'},
         {action:()=>{GS.flags.forestTalk=true;changeHope(10);}}
       ]
      },
      {id:'chiku_after2',name:'ì¹˜ì¿ ',x:450,
       condition:()=>GS.flags.forestTalk,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ì¹˜ì¿ ',text:'ë¹„ê°€ ì¢€ ì•½í•´ì§„ ê²ƒ ê°™ì•„. ìŠ¬ìŠ¬ ê°ˆê¹Œ?'},
         {minigame:'findLight',mgCfg:{title:'ê¸¸ ì°¾ê¸°',desc:'ì–´ë‘  ì† ë¹›ì„ ì°¾ì•„ í´ë¦­í•˜ì„¸ìš”',goal:3,time:10},onSuccess:()=>changeHope(2)},
         {speaker:'ë…¸ë“ ',text:'ì‘. ë™ìª½ìœ¼ë¡œ ê°€ë©´ ë°”ë‹¤ê°€ ìˆì„ ê±°ì•¼.'},
         {speaker:'ì¹˜ì¿ ',text:'ì•Œë„ ë”°ëœ»í•´. ì´ ì•„ì´ë„ ì¤€ë¹„ëœ ê²ƒ ê°™ì•„.'},
         {action:()=>changeHope(5)}
       ]
      }
    ],
    exits:[
      {x:880,type:'chapter',chapter:6,target:'ch6_journey',playerX:80,
       condition:()=>GS.flags.forestTalk}
    ]
  },

  // --- CHAPTER 6: Journey ---
  ch6_journey:{
    bg:'linear-gradient(180deg,#060610 0%,#08081a 50%,#0a0a1e 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#2a2828,#1a1818)'},
    stars:80,
    grassCount:15,
    music:'journey',
    bounds:{left:20,right:1200},
    decorations:[
      {style:'left:50%;top:20%;width:60px;height:60px;background:radial-gradient(circle,rgba(255,255,200,0.15),transparent);border-radius:50%;'},
    ],
    npcs:[
      {id:'owl',name:'ëŠ™ì€ ë¶€ì—‰ì´',x:450,
       sprite:'<div style="width:28px;height:32px;position:relative;pointer-events:none;"><div style="position:absolute;width:24px;height:22px;background:linear-gradient(135deg,#5a4a30,#4a3a20);border-radius:12px;bottom:6px;left:2px;"></div><div style="position:absolute;width:16px;height:10px;background:#6a5a38;border-radius:50% 50% 0 0;bottom:22px;left:6px;"></div><div style="position:absolute;width:5px;height:5px;background:#ff0;border-radius:50%;bottom:22px;left:8px;"></div><div style="position:absolute;width:5px;height:5px;background:#ff0;border-radius:50%;bottom:22px;left:16px;"></div><div style="position:absolute;width:4px;height:3px;background:#c08020;border-radius:0 0 2px 2px;bottom:20px;left:12px;"></div></div>',
       dialogue:()=>[
         {speaker:'ëŠ™ì€ ë¶€ì—‰ì´',text:'í˜¸ì˜¤... ì´ ë°¤ì— ì—¬í–‰ìë¼ë‹ˆ. ì–´ë””ë¡œ ê°€ëŠ” ê²Œëƒ?'},
         {speaker:'ë…¸ë“ ',text:'ë°”ë‹¤ë¥¼ ì°¾ê³  ìˆì–´ìš”.'},
         {speaker:'ëŠ™ì€ ë¶€ì—‰ì´',text:'ë°”ë‹¤ë¼... ì—¬ê¸°ì„œ ê½¤ ë©€ì§€. ë‘ ê°ˆë˜ ê¸¸ì´ ìˆë‹¨ë‹¤.'},
         {speaker:'ëŠ™ì€ ë¶€ì—‰ì´',text:'ì‚°ê¸¸ì€ í—˜í•˜ì§€ë§Œ ê°€ê¹Œì›Œ. ê°•ë³€ê¸¸ì€ í¸í•˜ì§€ë§Œ ëŒì•„ê°€ì•¼ í•˜ì§€.'},
         {minigame:'starConnect',mgCfg:{title:'ë³„ìë¦¬ ì‡ê¸°',desc:'ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ ë³„ì„ ì´ì–´ë³´ì„¸ìš”',total:5},onSuccess:()=>changeHope(3)},
         {choice:[
           {text:'ì‚°ê¸¸ë¡œ ê°„ë‹¤',flag:'mountainPath',hope:5,next:[
             {speaker:'ëŠ™ì€ ë¶€ì—‰ì´',text:'ìš©ê°í•œ ì„ íƒì´êµ¬ë‚˜. ì‚°ì—ì„œëŠ” ë³„ì´ ë” ê°€ê¹Œì´ ë³´ì¸ë‹¨ë‹¤.'},
             {action:()=>addItem({id:'star_piece',name:'í¬ë§ì˜ ë³„ ì¡°ê°',icon:'â­',desc:'ë¶€ì—‰ì´ê°€ ì•Œë ¤ì¤€ ì‚° ì •ìƒì—ì„œ ì£¼ìš´ ë¹›ë‚˜ëŠ” ëŒ'})}
           ]},
           {text:'ê°•ë³€ê¸¸ë¡œ ê°„ë‹¤',flag:'riverPath',hope:0,next:[
             {speaker:'ëŠ™ì€ ë¶€ì—‰ì´',text:'í˜„ëª…í•œ ì„ íƒì´ì•¼. ê°•ë¬¼ ì†Œë¦¬ê°€ ì¢‹ì€ ì¹œêµ¬ê°€ ë˜ì–´ì¤„ ê²Œë‹¤.'},
             {action:()=>addItem({id:'star_piece',name:'í¬ë§ì˜ ë³„ ì¡°ê°',icon:'â­',desc:'ê°•ë¬¼ì— ë¹„ì¹œ ë³„ë¹›ì´ êµ³ì–´ì§„ ì•„ë¦„ë‹¤ìš´ ëŒ'})}
           ]}
         ]}
       ]
      },
      {id:'chiku_journey',name:'ì¹˜ì¿ ',x:200,
       condition:()=>GS.flags.mountainPath||GS.flags.riverPath,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ , ë³„ì´ ì •ë§ ë§ë‹¤...'},
         {speaker:'ë…¸ë“ ',text:'ì‘. ì´ë ‡ê²Œ ë§ì€ ë³„ì€ ì²˜ìŒ ë´.'},
         {speaker:'ì¹˜ì¿ ',text:'ìš°ë¦¬ê°€ ê±¸ì–´ì˜¨ ê¸¸ë§Œí¼ ë³„ì´ ìˆëŠ” ê²ƒ ê°™ì•„.'},
         {minigame:'starCatch',mgCfg:{title:'ë³„ë¹› ì—¬ì •',desc:'ë³„ë¹›ì„ ëª¨ì•„ë³´ì„¸ìš”!',goal:4,time:8},onSuccess:()=>changeHope(3)},
         {speaker:'ë…¸ë“ ',text:'...ì¹˜ì¿ , ì•Œì€ ê´œì°®ì•„?'},
         {speaker:'ì¹˜ì¿ ',text:'ì‘, ë”°ëœ»í•´. ì´ ì•„ì´ë„ ë³„ì„ ë³´ê³  ìˆì„ê¹Œ?'},
         {speaker:'ë…¸ë“ ',text:'ë¶„ëª… ë³´ê³  ìˆì„ ê±°ì•¼.'},
         {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ ... ê³ ë§ˆì›Œ. í˜¼ìì˜€ìœ¼ë©´ ì—¬ê¸°ê¹Œì§€ ëª» ì™”ì„ ê±°ì•¼.'},
         {speaker:'ë…¸ë“ ',text:'ë‚˜ë„ ê·¸ë˜, ì¹˜ì¿ .'},
         {action:()=>changeHope(10)}
       ]
      }
    ],
    exits:[
      {x:1150,type:'chapter',chapter:7,target:'ch7_farewell',playerX:80,
       condition:()=>GS.flags.mountainPath||GS.flags.riverPath}
    ]
  },

  // --- CHAPTER 7: Farewell ---
  ch7_farewell:{
    bg:'linear-gradient(180deg,#050508 0%,#080810 40%,#0a0a14 70%,#141420 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#2a2828,#1a1818)'},
    stars:50,
    music:'farewell',
    bounds:{left:20,right:800},
    decorations:[
      // Faint dawn on horizon
      {style:'left:0;bottom:70px;width:100%;height:40px;background:linear-gradient(180deg,transparent,rgba(60,40,60,0.15));pointer-events:none;'}
    ],
    npcs:[
      {id:'chiku_weak',name:'ì¹˜ì¿ ',x:400,
       sprite:'<div class="chiku-sprite" style="opacity:0.85;"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>{
         if(GS.flags.chikuFarewell) return [
           {speaker:'',text:'(ì¹˜ì¿ ëŠ” ì¡°ìš©íˆ ì ë“¤ì–´ ìˆë‹¤. ì•Œì´ ì¡°ê¸ˆì”© ì›€ì§ì´ê³  ìˆë‹¤.)'},
           {minigame:'warmEgg',mgCfg:{title:'ì•Œ ëŒë³´ê¸°',desc:'í´ë¦­í•´ì„œ ì•Œì˜ ì˜¨ë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”',time:6},onSuccess:()=>changeHope(2)}
         ];
         GS.flags.chikuFarewell=true;
         return [
           {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ ... ì ê¹ ì‰¬ì–´ë„ ë ê¹Œ. ì¢€... í˜ë“¤ì–´.'},
           {speaker:'ë…¸ë“ ',text:'ì¹˜ì¿ ? ê´œì°®ì•„? ì–´ë”” ì•„íŒŒ?'},
           {speaker:'ì¹˜ì¿ ',text:'ì•„ë‹ˆì•¼... ê·¸ëƒ¥ ì¢€ í”¼ê³¤í•œ ê²ƒë¿ì´ì•¼.'},
           {speaker:'',text:'(ì¹˜ì¿ ì˜ ìˆ¨ì†Œë¦¬ê°€ ì ì  ê°€ëŠ˜ì–´ì¡Œë‹¤.)'},
           {action:()=>{$('vignette').classList.add('show');playSfx('sad');}},
           {speaker:'ì¹˜ì¿ ',text:'ë…¸ë“ , ë‚´ ë¶€íƒ í•˜ë‚˜ë§Œ ë“¤ì–´ì¤„ë˜?'},
           {speaker:'ë…¸ë“ ',text:'ë­ë“ ì§€. ë­ë“ ì§€ ë“¤ì–´ì¤„ê²Œ.'},
           {speaker:'ì¹˜ì¿ ',text:'ì´ ì•„ì´ë¥¼... ë°”ë‹¤ì— ë°ë ¤ë‹¤ì¤˜. í­ê·„ì€ ë°”ë‹¤ì—ì„œ ì‚´ì•„ì•¼ í•˜ë‹ˆê¹Œ.'},
           {speaker:'ë…¸ë“ ',text:'ë¬´ìŠ¨ ì†Œë¦¬ì•¼! ê°™ì´ ê°€ìê³  í–ˆì–ì•„! ê°™ì´!'},
           {speaker:'ì¹˜ì¿ ',text:'...ë‚˜ëŠ” ì¶©ë¶„íˆ í–‰ë³µí–ˆì–´, ë…¸ë“ . ì •ë§ì´ì•¼.'},
           {speaker:'ì¹˜ì¿ ',text:'í˜¼ìì˜€ë˜ ë°¤ë“¤ì´ ë„ˆë¥¼ ë§Œë‚˜ê³  ë‚˜ì„œ... ë”°ëœ»í–ˆì–´.'},
           {speaker:'ì¹˜ì¿ ',text:'ì´ ì•„ì´ì—ê²Œ... ë°”ë‹¤ë¥¼ ë³´ì—¬ì¤˜.'},
           {speaker:'ë…¸ë“ ',text:'ì¹˜ì¿ ... ì¹˜ì¿ ...!'},
           {speaker:'',text:'(ì¹˜ì¿ ëŠ” ë¯¸ì†Œë¥¼ ì§€ìœ¼ë©° ì¡°ìš©íˆ ëˆˆì„ ê°ì•˜ë‹¤.)'},
           {action:()=>{changeHope(-15);}},
           {speaker:'',text:'...'},
           {speaker:'',text:'ê·¸ë¦¬ê³ , ì•Œì´ ì›€ì§ì´ê¸° ì‹œì‘í–ˆë‹¤.'},
           {speaker:'',text:'í†¡. í†¡í†¡.'},
           {minigame:'warmEgg',mgCfg:{title:'ì•Œì„ ë”°ëœ»í•˜ê²Œ',desc:'í´ë¦­í•´ì„œ ì•Œì˜ ì˜¨ë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”!',time:8},onSuccess:()=>changeHope(5)},
           {speaker:'',text:'ì‘ê³  ë³´ì†¡ë³´ì†¡í•œ ìƒˆë¼ í­ê·„ì´ ì„¸ìƒì— ë‚˜ì™”ë‹¤.'},
           {action:()=>{
             GS.companion=null;
             GS.babyPenguin=true;
             GS.flags.chikuNoEgg=true;
             changeHope(20);
             playSfx('hope');
             $('vignette').classList.remove('show');
             buildScene('ch7_farewell');
           }},
           {speaker:'',text:'(ìƒˆë¼ í­ê·„ì´ ë…¸ë“ ì„ ì˜¬ë ¤ë‹¤ë³´ë©° ì†Œë¦¬ë¥¼ ëƒˆë‹¤.)'},
           {speaker:'ìƒˆë¼ í­ê·„',text:'ì‚ì•½...'},
           {speaker:'ë…¸ë“ ',text:'...ì•ˆë…•. ì•ˆë…•, ì‘ì€ ì•„ì´. ë‚´ê°€ ë„ ë°”ë‹¤ë¡œ ë°ë ¤ê°ˆê²Œ. ì•½ì†í• ê²Œ.'}
         ];
       }
      }
    ],
    exits:[
      {x:780,type:'chapter',chapter:8,target:'ch8_sea',playerX:80,
       condition:()=>GS.flags.chikuFarewell}
    ]
  },

  // --- CHAPTER 8: To the Sea ---
  ch8_sea:{
    bg:'linear-gradient(180deg,#1a2040 0%,#2a3060 20%,#4a5080 40%,#8090b0 60%,#c0b0a0 80%,#e0c890 100%)',
    ground:{height:'60px',bg:'linear-gradient(180deg,#c0b090,#a09070)'},
    music:'sea',
    bounds:{left:20,right:900},
    decorations:[
      // Sun
      {style:'right:100px;top:60px;width:80px;height:80px;background:radial-gradient(circle,rgba(255,220,150,0.8),rgba(255,180,100,0.3),transparent);border-radius:50%;'},
      // Waves
      ...[0,1,2,3,4,5].map(i=>({
        style:`left:${i*180}px;bottom:55px;width:160px;height:12px;background:rgba(80,120,180,0.3);border-radius:50%;animation:sway ${2+i*0.3}s infinite alternate;`
      })),
      // Sea
      {style:'left:0;bottom:0;width:100%;height:58px;background:linear-gradient(180deg,rgba(60,100,160,0.5),rgba(40,80,140,0.6));'}
    ],
    npcs:[
      {id:'baby_sea',name:'ìƒˆë¼ í­ê·„',x:500,
       condition:()=>!GS.flags.finalChoice,
       sprite:'<div class="baby-sprite"><div class="baby-body"></div><div class="baby-belly"></div><div class="baby-fluff"></div><div class="baby-beak"></div><div class="baby-eye l"></div><div class="baby-eye r"></div><div class="baby-foot l"></div><div class="baby-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ìƒˆë¼ í­ê·„',text:'ì‚ì•½ì‚ì•½!'},
         {speaker:'',text:'(ìƒˆë¼ í­ê·„ì´ ì²˜ìŒìœ¼ë¡œ ë°”ë‹¤ë¥¼ ë³´ì•˜ë‹¤. ì‘ì€ ë‚ ê°œë¥¼ íŒŒë‹¥ê±°ë ¸ë‹¤.)'},
         {minigame:'waveJump',mgCfg:{title:'ì²« íŒŒë„',desc:'í´ë¦­ìœ¼ë¡œ ì í”„í•˜ì—¬ íŒŒë„ë¥¼ ë„˜ìœ¼ì„¸ìš”!',goal:4},onSuccess:()=>changeHope(3)},
         {speaker:'ë…¸ë“ ',text:'ë´... ì´ê²Œ ë°”ë‹¤ì•¼. ì¹˜ì¿ ê°€ ë„ˆì—ê²Œ ë³´ì—¬ì£¼ê³  ì‹¶ì—ˆë˜ ê²ƒ.'},
         {speaker:'ìƒˆë¼ í­ê·„',text:'ì‚ì•½...?'},
         {speaker:'ë…¸ë“ ',text:'ë„ˆì˜ ì—„ë§ˆëŠ” ì•„ì£¼ ìš©ê°í•œ í­ê·„ì´ì—ˆì–´. ë„ˆë¥¼ ì •ë§ ì‚¬ë‘í–ˆì–´.'},
         {speaker:'',text:'(ë°”ë‹¤ ìœ„ë¡œ ì•„ì¹¨ í•´ê°€ ë– ì˜¤ë¥´ê³  ìˆì—ˆë‹¤.)'},
         {speaker:'ë…¸ë“ ',text: ()=>{
           const itemCount=GS.items.length;
           if(itemCount>=4) return '(í’ˆ ì•ˆì˜ ì¡°ì•½ëŒì„ ë§Œì ¸ë³¸ë‹¤. ëª¨ë“  ë§Œë‚¨ì´ ë– ì˜¤ë¥¸ë‹¤...)';
           return '(ê¸´ê¸´ë°¤ì´ ëë‚˜ê³  ìˆë‹¤. ì´ì œ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ.)';
         }},
         {choice:[
           {text:'ì‘ì€ í­ê·„ì„ ë°”ë‹¤ë¡œ ë³´ë‚´ì¤€ë‹¤',flag:'finalChoice',flagValue:'release',action:()=>{
             GS.flags.finalChoice='release';
             const endType=GS.items.length>=4?'memory':'hope';
             showCutscene([
               'ì‘ì€ í­ê·„ì´ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ íŒŒë„ì— ë°œì„ ë‹´ê°”ë‹¤.',
               'ì²˜ìŒì—ëŠ” ë¬´ì„œì› ì§€ë§Œ, ê³§ ë¬¼ì‚´ì„ íƒ€ê¸° ì‹œì‘í–ˆë‹¤.',
               'ëŒì•„ë³´ëŠ” ì‘ì€ ëˆˆë™ìì— ë°”ë‹¤ê°€ ê°€ë“ ë‹´ê²¨ ìˆì—ˆë‹¤.',
               'ë…¸ë“ ì€ ì›ƒì—ˆë‹¤. ì˜¤ëœë§Œì—, ì§„ì‹¬ìœ¼ë¡œ.',
               'ê¸´ê¸´ë°¤ì´ ëë‚˜ê³  ì•„ì¹¨ì´ ì™”ë‹¤.'
             ],()=>showEnding(endType));
           }},
           {text:'í•¨ê»˜ ë°”ë‹·ê°€ì— ë‚¨ëŠ”ë‹¤',flag:'finalChoice',flagValue:'stay',action:()=>{
             GS.flags.finalChoice='stay';
             showCutscene([
               'ë…¸ë“ ì€ ë°”ë‹·ê°€ì— ìë¦¬ë¥¼ ì¡ì•˜ë‹¤.',
               'ì‘ì€ í­ê·„ì€ ë§¤ì¼ ë°”ë‹¤ì—ì„œ ë†€ë‹¤ê°€ ë…¸ë“ ì—ê²Œ ëŒì•„ì™”ë‹¤.',
               'í˜¼ìê°€ ì•„ë‹Œ ì•„ì¹¨ì€ ì´ë ‡ê²Œë‚˜ ë”°ëœ»í–ˆë‹¤.',
               'íŒŒë„ ì†Œë¦¬ê°€ ë‘ ì¹œêµ¬ì˜ ë…¸ë˜ê°€ ë˜ì—ˆë‹¤.',
               'ê¸´ê¸´ë°¤ì´ ëë‚˜ê³ , ë”°ëœ»í•œ ì•„ì¹¨ì´ ì‹œì‘ë˜ì—ˆë‹¤.'
             ],()=>showEnding('together'));
           }}
         ]}
       ]
      }
    ],
    exits:[]
  }
};

// ===== INPUT =====
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') GS.moving.left=true;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') GS.moving.right=true;
  if(e.key==='ArrowUp'||e.key==='w'||e.key==='W'){ e.preventDefault(); jump(); }
  if(e.key===' '||e.key==='Enter'){
    e.preventDefault();
    if(GS.minigameActive) return;
    if(GS.dialogueActive) advanceDialogue();
    else {
      // Try interact with nearest NPC
      const npcs=document.querySelectorAll('.npc');
      let closest=null, minDist=80;
      npcs.forEach(n=>{
        const d=Math.abs(GS.px-parseFloat(n.style.left));
        if(d<minDist){minDist=d;closest=n;}
      });
      if(closest) closest.click();
    }
  }
  if(e.key==='i'||e.key==='I') toggleInventory();
});
document.addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') GS.moving.left=false;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') GS.moving.right=false;
});

// Dialogue box click
$('dialogue-box').addEventListener('click',e=>{
  e.stopPropagation();
  if(GS.minigameActive) return;
  if(GS.dialogueActive) advanceDialogue();
});

// Mobile controls
document.querySelectorAll('.dpad-btn').forEach(btn=>{
  const dir=btn.dataset.dir;
  if(dir==='up'){
    btn.addEventListener('touchstart',e=>{e.preventDefault();jump();});
    btn.addEventListener('mousedown',()=>jump());
  } else {
    btn.addEventListener('touchstart',e=>{e.preventDefault();GS.moving[dir]=true;});
    btn.addEventListener('touchend',e=>{e.preventDefault();GS.moving[dir]=false;});
    btn.addEventListener('mousedown',()=>GS.moving[dir]=true);
    btn.addEventListener('mouseup',()=>GS.moving[dir]=false);
  }
});
$('m-interact').addEventListener('click',()=>{
  if(GS.dialogueActive){ advanceDialogue(); return; }
  const npcs=document.querySelectorAll('.npc');
  let closest=null, minDist=80;
  npcs.forEach(n=>{
    const d=Math.abs(GS.px-parseFloat(n.style.left));
    if(d<minDist){minDist=d;closest=n;}
  });
  if(closest) closest.click();
});
$('m-inv').addEventListener('click',toggleInventory);

// HUD buttons
$('music-btn').addEventListener('click',()=>{initAudio();toggleMusic();});
$('inv-btn').addEventListener('click',toggleInventory);
$('skin-btn').addEventListener('click',()=>{
  const p=$('skin-panel');
  p.style.display=p.style.display==='block'?'none':'block';
});
document.querySelectorAll('.skin-option').forEach(b=>{
  b.addEventListener('click',()=>applySkin(b.dataset.skin));
});
$('restart-btn').addEventListener('click',restartGame);

// Start
$('start-btn').addEventListener('click',()=>{
  initAudio();
  $('title-screen').style.display='none';
  $('hud').style.display='flex';
  showChapter(1,'ch1_orphanage',200);
  gameLoop();
});

// Load saved skin
const savedSkin=localStorage.getItem('ggg-skin');
if(savedSkin) applySkin(savedSkin);

// Title screen stars & particles
(function(){
  const starBox=$('title-stars');
  if(!starBox)return;
  for(let i=0;i<80;i++){
    const s=document.createElement('div');s.className='star';
    s.style.left=Math.random()*100+'%';s.style.top=Math.random()*100+'%';
    s.style.setProperty('--dur',(2+Math.random()*5)+'s');
    s.style.width=(1+Math.random()*2.5)+'px';s.style.height=s.style.width;
    s.style.animationDelay=Math.random()*3+'s';
    starBox.appendChild(s);
  }
  const partBox=$('title-particles');
  if(!partBox)return;
  for(let i=0;i<15;i++){
    const p=document.createElement('div');p.className='title-particle';
    p.style.left=Math.random()*100+'%';
    p.style.setProperty('--dur',(6+Math.random()*8)+'s');
    p.style.setProperty('--dx',(Math.random()*40-20)+'px');
    p.style.animationDelay=Math.random()*8+'s';
    p.style.width=(1+Math.random()*2)+'px';p.style.height=p.style.width;
    partBox.appendChild(p);
  }
})();

// Fade in/out animation for notifications
const style=document.createElement('style');
style.textContent='@keyframes fadeInOut{0%{opacity:0;transform:translateX(-50%) translateY(-10px);}15%{opacity:1;transform:translateX(-50%) translateY(0);}85%{opacity:1;}100%{opacity:0;}}';
document.head.appendChild(style);

// ===== EASTER EGGS =====

// Easter egg tracker
const EGGS_DEF=[
  {id:'konami',icon:'ğŸŒˆ',name:'ë¬´ì§€ê°œ ë…¸ë“ ',hint:'ë¹„ë°€ ì»¤ë§¨ë“œë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”'},
  {id:'moon',icon:'ğŸŒ™',name:'ë‹¬ì˜ ì†Œì›',hint:'íƒ€ì´í‹€ í™”ë©´ì—ì„œ ë‹¬ì„ ì°¾ì•„ë³´ì„¸ìš”'},
  {id:'jumpburst',icon:'âœ¨',name:'ë³„ë¹› í­ë°œ',hint:'ì‹ ë‚˜ê²Œ ë›°ì–´ë³´ì„¸ìš”!'},
  {id:'angabu',icon:'â­',name:'ì•™ê°€ë¶€ì˜ ë³„',hint:'ì†Œì¤‘í•œ ì´ë¦„ì„ ë¶ˆëŸ¬ë³´ì„¸ìš”'},
  {id:'chiku',icon:'ğŸ§',name:'ì¹˜ì¿ ì˜ ë¹„',hint:'ê·¸ë¦¬ìš´ ì´ë¦„ì„ ë¶ˆëŸ¬ë³´ì„¸ìš”'},
  {id:'noden',icon:'ğŸ¦',name:'ë…¸ë“ ì˜ ë°œêµ¬ë¦„',hint:'ìì‹ ì˜ ì´ë¦„ì„ ë¶ˆëŸ¬ë³´ì„¸ìš”'}
];
let eggsFound=JSON.parse(localStorage.getItem('ggg-eggs')||'[]');
function unlockEgg(id){
  if(eggsFound.includes(id))return;
  eggsFound.push(id);
  localStorage.setItem('ggg-eggs',JSON.stringify(eggsFound));
  renderEggs();
}
function renderEggs(){
  const list=$('egg-list');
  if(!list)return;
  const found=eggsFound.length, total=EGGS_DEF.length;
  $('egg-count').textContent=found+' / '+total+' ë°œê²¬';
  list.innerHTML='';
  EGGS_DEF.forEach(eg=>{
    const f=eggsFound.includes(eg.id);
    const d=document.createElement('div');
    d.className='egg-item'+(f?' found':'');
    d.innerHTML='<div class="egg-icon">'+eg.icon+'</div><div class="egg-info"><div class="egg-name">'+(f?eg.name:'???')+'</div><div class="egg-hint">'+(f?'ë°œê²¬!':eg.hint)+'</div></div>';
    list.appendChild(d);
  });
}
function toggleEggPanel(){
  $('egg-panel').classList.toggle('open');
  renderEggs();
}
$('egg-btn').addEventListener('click',toggleEggPanel);
renderEggs();

// 1. Konami Code â†’ Rainbow Noden! (e.key + e.code ëª¨ë‘ ì§€ì›)
const KONAMI_KEY=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
const KONAMI_CODE=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','KeyB','KeyA'];
let konamiIdx=0, rainbowActive=false;
document.addEventListener('keydown',e=>{
  const keyMatch=e.key===KONAMI_KEY[konamiIdx]||(e.key.toLowerCase()===KONAMI_KEY[konamiIdx]);
  const codeMatch=e.code===KONAMI_CODE[konamiIdx];
  if(keyMatch||codeMatch){
    konamiIdx++;
    if(konamiIdx>=KONAMI_KEY.length){
      konamiIdx=0;
      rainbowActive=!rainbowActive;
      $('game').classList.toggle('rainbow-mode',rainbowActive);
      unlockEgg('konami');
      const msg=rainbowActive?'ë¬´ì§€ê°œ ë…¸ë“  í™œì„±í™”!':'ë¬´ì§€ê°œ ëª¨ë“œ í•´ì œ';
      easterEggNotif('ğŸŒˆ '+msg);
      if(rainbowActive&&audioCtx){
        [523,587,659,698,784,880,988,1047].forEach((f,i)=>setTimeout(()=>playNote(f,0.15,'triangle',0.1,sfxGain),i*60));
      }
    }
  } else { konamiIdx=0; }
});

// 2. Title screen moon click â†’ Shooting star
(function(){
  const moon=$('title-moon');
  if(!moon) return;
  let moonClicks=0;
  moon.style.cursor='pointer';
  moon.style.pointerEvents='auto';
  moon.addEventListener('click',()=>{
    moonClicks++;
    // Shooting star
    const star=document.createElement('div');
    star.className='shooting-star';
    star.style.left=(15+Math.random()*60)+'%';
    star.style.top=(5+Math.random()*30)+'%';
    star.style.animation='shootingStar 0.8s linear forwards';
    $('title-screen').appendChild(star);
    setTimeout(()=>star.remove(),900);
    if(moonClicks===5){
      unlockEgg('moon');
      easterEggNotif('ğŸŒ™ ë‹¬ì´ ë‹¹ì‹ ì˜ ì†Œì›ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤');
      moonClicks=0;
    }
  });
})();

// 3. Jump 7 times quickly â†’ Sparkle burst
let jumpCount=0, jumpTimer=null;
const _origJump=jump;
jump=function(){
  _origJump();
  if(!GS.isJumping) return;
  jumpCount++;
  clearTimeout(jumpTimer);
  jumpTimer=setTimeout(()=>{jumpCount=0;},4000);
  if(jumpCount>=7){
    jumpCount=0;
    // Sparkle burst around player
    const emojis=['âœ¨','â­','ğŸ’«','ğŸŒŸ','âœ¨','â­'];
    for(let i=0;i<8;i++){
      const s=document.createElement('div');
      s.className='sparkle';
      s.textContent=emojis[i%emojis.length];
      const angle=(i/8)*Math.PI*2;
      s.style.setProperty('--sx',(Math.cos(angle)*60)+'px');
      s.style.setProperty('--sy',(Math.sin(angle)*60-30)+'px');
      s.style.left=GS.px+'px';
      const def=SCENES[GS.sceneKey];
      const groundH=def?.ground?parseInt(def.ground.height)||80:80;
      s.style.bottom=(groundH+30)+'px';
      s.style.position='absolute';
      $('scene').appendChild(s);
      setTimeout(()=>s.remove(),900);
    }
    unlockEgg('jumpburst');
    easterEggNotif('âœ¨ ë…¸ë“ ì´ ê¸°ë»í•˜ê³  ìˆì–´ìš”!');
    if(audioCtx){
      [784,880,988,1047,1175].forEach((f,i)=>setTimeout(()=>playNote(f,0.1,'triangle',0.08,sfxGain),i*50));
    }
  }
};

// 4,5,6. í•œêµ­ì–´ ì´ë¦„ ì´ìŠ¤í„°ì—ê·¸ (ì˜ì–´/í•œêµ­ì–´ í‚¤ë³´ë“œ ëª¨ë‘ ì§€ì›)
// í•œêµ­ì–´ ë‘ë²Œì‹: ì•™ê°€ë¶€=dkdrkqn, ì¹˜ì¿ =clzn, ë…¸ë“ =shems
let secretBuf='', codeBuf='';
function codeToChar(code){ return code.startsWith('Key')?code[3].toLowerCase():''; }

function triggerAngabu(){
  unlockEgg('angabu');
  easterEggNotif('â­ ì•™ê°€ë¶€ê°€ ë³„ì´ ë˜ì–´ ì§€ì¼œë³´ê³  ìˆì–´ìš”');
  for(let i=0;i<12;i++){
    const s=document.createElement('div');
    s.className='memorial-star';
    s.textContent='â­';
    s.style.left=(10+Math.random()*80)+'%';
    s.style.top=(40+Math.random()*40)+'%';
    s.style.fontSize=(12+Math.random()*16)+'px';
    s.style.animationDelay=(Math.random()*1.5)+'s';
    document.body.appendChild(s);
    setTimeout(()=>s.remove(),5000);
  }
  if(audioCtx){
    [392,440,523,587,659,523,440,392].forEach((f,i)=>setTimeout(()=>playNote(f,0.6,'sine',0.07,sfxGain),i*250));
  }
}
function triggerChiku(){
  unlockEgg('chiku');
  easterEggNotif('ğŸ§ ì¹˜ì¿ ê°€ ê³ ë§ˆì›Œí•˜ê³  ìˆì–´ìš”');
  for(let i=0;i<15;i++){
    const p=document.createElement('div');
    p.style.cssText='position:fixed;font-size:20px;pointer-events:none;z-index:300;top:-30px;left:'+(Math.random()*100)+'%;animation:fall '+(1.5+Math.random())+'s linear forwards;';
    p.textContent='ğŸ§';
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),3000);
  }
  if(audioCtx){
    [523,587,659,784].forEach((f,i)=>setTimeout(()=>playNote(f,0.2,'sine',0.08,sfxGain),i*120));
  }
}
function triggerNoden(){
  unlockEgg('noden');
  easterEggNotif('ğŸ¦ ì¿µ! ë…¸ë“ ì´ í˜ì°¨ê²Œ ë°œì„ êµ´ë €ì–´ìš”!');
  document.body.style.animation='none';
  document.body.offsetWidth;
  document.body.style.animation='screenShake 0.4s';
  if(audioCtx){
    playNote(80,0.5,'square',0.15,sfxGain);
    setTimeout(()=>playNote(60,0.6,'square',0.12,sfxGain),200);
  }
}

document.addEventListener('keydown',e=>{
  // English buffer (ì˜ì–´ ëª¨ë“œ)
  if(e.key.length===1) secretBuf+=e.key.toLowerCase();
  if(secretBuf.length>30) secretBuf=secretBuf.slice(-30);
  // Physical key buffer (í•œêµ­ì–´ ëª¨ë“œ - ë‘ë²Œì‹ ë¬¼ë¦¬ í‚¤)
  const ch=codeToChar(e.code);
  if(ch) codeBuf+=ch;
  if(codeBuf.length>30) codeBuf=codeBuf.slice(-30);

  // ì•™ê°€ë¶€: ì˜ì–´ "angabu" ë˜ëŠ” í•œêµ­ì–´ ë¬¼ë¦¬í‚¤ "dkdrkqn"
  if(secretBuf.endsWith('angabu')||codeBuf.endsWith('dkdrkqn')){
    secretBuf='';codeBuf='';triggerAngabu();
  }
  // ì¹˜ì¿ : ì˜ì–´ "chiku" ë˜ëŠ” í•œêµ­ì–´ ë¬¼ë¦¬í‚¤ "clzn"
  if(secretBuf.endsWith('chiku')||codeBuf.endsWith('clzn')){
    secretBuf='';codeBuf='';triggerChiku();
  }
  // ë…¸ë“ : ì˜ì–´ "noden" ë˜ëŠ” í•œêµ­ì–´ ë¬¼ë¦¬í‚¤ "shems"
  if(secretBuf.endsWith('noden')||codeBuf.endsWith('shems')){
    secretBuf='';codeBuf='';triggerNoden();
  }
});

// Screen shake for noden easter egg
const shakeStyle=document.createElement('style');
shakeStyle.textContent='@keyframes screenShake{0%,100%{transform:translate(0,0);}10%{transform:translate(-4px,2px);}20%{transform:translate(4px,-2px);}30%{transform:translate(-3px,3px);}40%{transform:translate(3px,-1px);}50%{transform:translate(-2px,2px);}60%{transform:translate(2px,-2px);}70%{transform:translate(-1px,1px);}80%{transform:translate(1px,-1px);}}';
document.head.appendChild(shakeStyle);

// Easter egg notification helper
function easterEggNotif(msg){
  const n=document.createElement('div');
  n.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);border:1px solid var(--text-accent);color:var(--text-accent);padding:12px 28px;border-radius:12px;font-size:15px;z-index:500;animation:fadeInOut 2.5s forwards;pointer-events:none;font-family:"Noto Serif KR",serif;text-align:center;white-space:nowrap;backdrop-filter:blur(4px);';
  n.textContent=msg;
  document.body.appendChild(n);
  setTimeout(()=>n.remove(),2600);
}

// ===== MULTIPLAYER (ë‹¤ì¤‘ ì ‘ì†) =====
const GUEST_COLORS=['#6a5a4a','#4a5a6a','#5a6a4a','#6a4a5a','#4a6a6a','#6a6a4a','#5a4a6a','#6a5a5a'];
const MP={
  peer:null, conns:[], isHost:false, isMP:false, roomCode:'', myId:'',
  players:{}, gameStarted:false
};

function mpGenCode(){ return String(Math.floor(1000+Math.random()*9000)); }

// Lobby UI
$('mp-btn').addEventListener('click',()=>{
  $('mp-lobby').style.display='flex';
  $('mp-lobby-menu').style.display='block';
  $('mp-host-view').style.display='none';
  $('mp-join-view').style.display='none';
});
$('mp-back').addEventListener('click',()=>{
  $('mp-lobby').style.display='none';
  if(MP.peer){MP.peer.destroy();MP.peer=null;}
});
$('mp-create').addEventListener('click',mpCreateRoom);
$('mp-join-btn').addEventListener('click',()=>{
  $('mp-lobby-menu').style.display='none';
  $('mp-join-view').style.display='block';
  $('mp-input').focus();
});
$('mp-connect').addEventListener('click',mpJoinRoom);
$('mp-input').addEventListener('keydown',e=>{if(e.key==='Enter')mpJoinRoom();});

function mpCreateRoom(){
  $('mp-lobby-menu').style.display='none';
  $('mp-host-view').style.display='block';
  MP.roomCode=mpGenCode();
  $('mp-room-code').textContent=MP.roomCode;
  $('mp-status').textContent='ì ‘ì† ëŒ€ê¸° ì¤‘...';
  MP.isHost=true;
  MP.myId='host';
  MP.peer=new Peer('ggg-'+MP.roomCode);
  MP.peer.on('open',()=>{
    $('mp-status').textContent='ë°©ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ì¹œêµ¬ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
  });
  MP.peer.on('connection',conn=>{
    const pid='p'+Date.now().toString(36);
    conn._pid=pid;
    MP.conns.push(conn);
    const count=MP.conns.length;
    $('mp-status').textContent=count+'ëª… ì ‘ì† ì¤‘';
    conn.on('open',()=>{
      conn.send({t:'welcome',pid:pid,color:GUEST_COLORS[(count-1)%GUEST_COLORS.length]});
      // Sync current state only if scene is already loaded
      if(GS.sceneKey){
        conn.send({t:'sync',ch:GS.chapter,key:GS.sceneKey,px:GS.px,hope:GS.hope,
          items:GS.items.map(i=>({id:i.id,name:i.name,icon:i.icon,desc:i.desc}))});
      }
    });
    conn.on('data',d=>{d._from=pid;mpOnHostData(d);});
    conn.on('close',()=>{
      MP.conns=MP.conns.filter(c=>c._pid!==pid);
      delete MP.players[pid];
      mpBroadcast({t:'leave',pid:pid});
      removeGuestEl(pid);
      $('mp-status').textContent=MP.conns.length+'ëª… ì ‘ì† ì¤‘';
    });
    if(!MP.gameStarted) mpStartGame();
  });
  MP.peer.on('error',e=>{
    $('mp-status').textContent='ì˜¤ë¥˜: '+e.type;
  });
}

function mpJoinRoom(){
  const code=$('mp-input').value.trim();
  if(code.length!==4){$('mp-join-status').textContent='4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”';return;}
  $('mp-join-status').textContent='ì ‘ì† ì¤‘...';
  MP.isHost=false;
  MP.roomCode=code;
  MP.peer=new Peer();
  MP.peer.on('open',()=>{
    const conn=MP.peer.connect('ggg-'+code);
    MP.conns=[conn];
    conn.on('open',()=>{
      $('mp-join-status').textContent='ì ‘ì† ì„±ê³µ!';
      mpStartGame();
      conn.on('data',d=>mpOnGuestData(d));
      conn.on('close',()=>{
        MP.isMP=false;MP.conns=[];
        $('mp-indicator').textContent='ì—°ê²° ëŠê¹€';
        removeAllGuests();
      });
    });
    conn.on('error',()=>{
      $('mp-join-status').textContent='ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    });
  });
  MP.peer.on('error',e=>{
    $('mp-join-status').textContent='ì˜¤ë¥˜: '+e.type;
  });
}

function mpStartGame(){
  if(MP.gameStarted)return;
  MP.gameStarted=true;
  MP.isMP=true;
  $('mp-lobby').style.display='none';
  $('title-screen').style.display='none';
  $('hud').style.display='flex';
  $('mp-indicator').style.display='block';
  $('mp-indicator').textContent=(MP.isHost?'í˜¸ìŠ¤íŠ¸':'ê²ŒìŠ¤íŠ¸')+' (ë°©: '+MP.roomCode+')';
  initAudio();
  showChapter(1,'ch1_orphanage',200);
  gameLoop();
  setInterval(mpSendPos,50);
}

// Host: broadcast to all guests
function mpBroadcast(data){
  MP.conns.forEach(c=>{if(c.open)c.send(data);});
}
// Guest: send to host
function mpSendToHost(data){
  if(MP.conns[0]&&MP.conns[0].open) MP.conns[0].send(data);
}

function mpSendPos(){
  if(!MP.isMP)return;
  const posData={t:'pos',pid:MP.myId,x:GS.px,f:GS.facing,w:!!$('player')?.classList.contains('walking'),j:GS.jumpY};
  if(MP.isHost) mpBroadcast(posData);
  else mpSendToHost(posData);
}

// Host receives data from a guest
function mpOnHostData(d){
  if(d.t==='pos'){
    MP.players[d._from]={x:d.x,f:d.f,w:d.w,j:d.j};
    updateGuestEl(d._from);
    // Relay to all other guests
    mpBroadcast({t:'pos',pid:d._from,x:d.x,f:d.f,w:d.w,j:d.j});
  }
}

// Guest receives data from host
function mpOnGuestData(d){
  if(d.t==='welcome'){
    MP.myId=d.pid;
    MP.myColor=d.color;
  }
  if(d.t==='pos'&&d.pid!==MP.myId){
    MP.players[d.pid]={x:d.x,f:d.f,w:d.w,j:d.j};
    updateGuestEl(d.pid);
  }
  if(d.t==='pos'&&!d.pid){
    // Host position
    MP.players['host']={x:d.x,f:d.f,w:d.w,j:d.j};
    updateGuestEl('host');
  }
  if(d.t==='leave'){
    delete MP.players[d.pid];
    removeGuestEl(d.pid);
  }
  if(d.t==='sync'){
    GS.transitioning=false;
    GS.chapter=d.ch;
    GS.hope=d.hope;
    $('hope-bar').style.width=d.hope+'%';
    $('hope-label').textContent=d.hope;
    if(d.items) d.items.forEach(item=>addItem(item));
    buildScene(d.key);
    GS.px=d.px;
    const p=$('player');if(p)p.style.left=d.px+'px';
    updateHUD();
    $('scene').style.opacity=1;
    $('chapter-overlay').classList.remove('show');
  }
  if(d.t==='dialogue') startDialogue(d.lines);
  if(d.t==='scene' && d.key) loadScene(d.key,d.px);
  if(d.t==='chapter' && d.target) showChapter(d.ch,d.target,d.px);
  if(d.t==='hope'){
    GS.hope=d.v;
    $('hope-bar').style.width=GS.hope+'%';
    $('hope-label').textContent=GS.hope;
  }
  if(d.t==='item') addItem(d.item);
}

function createGuestEl(pid){
  const sc=$('scene');
  if(!sc||document.getElementById('gp-'+pid))return;
  const el=document.createElement('div');
  el.id='gp-'+pid;
  el.className='character';
  const def=SCENES[GS.sceneKey];
  const groundH=def?.ground?parseInt(def.ground.height)||80:80;
  el.style.bottom=groundH+'px';
  el.style.left='200px';
  const idx=Object.keys(MP.players).indexOf(pid);
  const col=GUEST_COLORS[Math.abs(idx)%GUEST_COLORS.length];
  el.innerHTML='<div class="guest-label">ì—¬í–‰ì</div><div class="guest-sprite"><div class="guest-body" style="background:linear-gradient(135deg,'+col+',#444)"></div><div class="guest-head" style="background:linear-gradient(135deg,'+col+',#555)"></div><div class="guest-horn"></div><div class="guest-ear" style="background:'+col+'"></div><div class="guest-eye"></div><div class="noden-leg fl" style="background:'+col+'"></div><div class="noden-leg fr" style="background:'+col+'"></div><div class="noden-leg bl" style="background:'+col+'"></div><div class="noden-leg br" style="background:'+col+'"></div></div>';
  sc.appendChild(el);
}

function updateGuestEl(pid){
  let g=document.getElementById('gp-'+pid);
  if(!g) createGuestEl(pid);
  g=document.getElementById('gp-'+pid);
  if(!g)return;
  const p=MP.players[pid];
  if(!p)return;
  g.style.left=p.x+'px';
  g.classList.toggle('walking',p.w);
  g.classList.toggle('face-left',p.f==='left');
  const def=SCENES[GS.sceneKey];
  const groundH=def?.ground?parseInt(def.ground.height)||80:80;
  g.style.bottom=(groundH+(p.j||0))+'px';
}

function removeGuestEl(pid){
  const g=document.getElementById('gp-'+pid);
  if(g)g.remove();
}

function removeAllGuests(){
  Object.keys(MP.players).forEach(pid=>removeGuestEl(pid));
  MP.players={};
}

// Override buildScene to recreate all guests
const _origBuildScene=buildScene;
buildScene=function(key){
  _origBuildScene(key);
  if(MP.isMP) Object.keys(MP.players).forEach(pid=>createGuestEl(pid));
};

// Host syncs dialogue, scene, chapter, hope, items to all guests
const _origStartDialogue=startDialogue;
startDialogue=function(lines){
  _origStartDialogue(lines);
  if(MP.isMP&&MP.isHost){
    try{
      const safe=dialogueQueue.map(l=>{
        if(typeof l.text==='function') return{speaker:l.speaker||'',text:l.text()};
        if(l.speaker!==undefined) return{speaker:l.speaker||'',text:l.text||''};
        return null;
      }).filter(Boolean);
      mpBroadcast({t:'dialogue',lines:safe});
    }catch(e){}
  }
};

const _origLoadScene=loadScene;
loadScene=function(key,px){
  _origLoadScene(key,px);
  if(MP.isMP&&MP.isHost) mpBroadcast({t:'scene',key:key,px:px});
};

const _origShowChapter=showChapter;
showChapter=function(ch,target,px){
  _origShowChapter(ch,target,px);
  if(MP.isMP&&MP.isHost) mpBroadcast({t:'chapter',ch:ch,target:target,px:px});
};

const _origChangeHope=changeHope;
changeHope=function(delta){
  _origChangeHope(delta);
  if(MP.isMP&&MP.isHost) mpBroadcast({t:'hope',v:GS.hope});
};

const _origAddItem=addItem;
addItem=function(item){
  _origAddItem(item);
  if(MP.isMP&&MP.isHost) mpBroadcast({t:'item',item:{id:item.id,name:item.name,icon:item.icon,desc:item.desc}});
};

// ===== CHAT =====
let chatOpen=false, chatTyping=false;
const CHAT_NAMES=['ë…¸ë“ ','ì¹˜ì¿ ','ì•™ê°€ë¶€','ë¶€ì—‰ì´','ì½”ë¼ë¦¬','í­ê·„','ë¬¼ë²”','ìˆ˜ë‹¬'];
let myNick=CHAT_NAMES[Math.floor(Math.random()*CHAT_NAMES.length)];

function chatToggle(){
  if(!MP.isMP)return;
  chatOpen=!chatOpen;
  $('chat-box').classList.toggle('open',chatOpen);
  $('chat-input-wrap').style.display=chatOpen?'block':'none';
  $('chat-hint').style.display=chatOpen?'none':'block';
  if(chatOpen){
    chatTyping=true;
    $('chat-input').focus();
  } else {
    chatTyping=false;
    $('chat-input').blur();
  }
}

function chatAddMsg(name,text,isSystem){
  const msgs=$('chat-msgs');
  const el=document.createElement('div');
  el.className='chat-msg'+(isSystem?' system':'');
  if(isSystem){
    el.textContent=text;
  } else {
    el.innerHTML='<span class="chat-name">'+name+'</span>'+text.replace(/</g,'&lt;');
  }
  msgs.appendChild(el);
  msgs.scrollTop=msgs.scrollHeight;
  // Auto remove after 15s if chat not open
  setTimeout(()=>{if(el.parentNode)el.style.opacity='0.3';},12000);
  setTimeout(()=>{if(el.parentNode)el.remove();},20000);
}

function chatSend(){
  const input=$('chat-input');
  const text=input.value.trim();
  if(!text)return;
  input.value='';
  chatAddMsg(myNick,text);
  const data={t:'chat',name:myNick,text:text};
  if(MP.isHost) mpBroadcast(data);
  else mpSendToHost(data);
}

// Show chat box when MP starts
const _origMpStartGame=mpStartGame;
mpStartGame=function(){
  _origMpStartGame();
  $('chat-box').style.display='block';
  chatAddMsg('','í•¨ê»˜ ì—¬ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤! (Tí‚¤ë¡œ ì±„íŒ…)',true);
};

// Handle chat in multiplayer data
const _origOnHostData=mpOnHostData;
mpOnHostData=function(d){
  _origOnHostData(d);
  if(d.t==='chat'){
    chatAddMsg(d.name,d.text);
    mpBroadcast({t:'chat',name:d.name,text:d.text,_from:d._from});
  }
  if(d.t==='nick'){
    chatAddMsg('',d.name+'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤',true);
    mpBroadcast({t:'sys',text:d.name+'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤'});
  }
};

const _origOnGuestData=mpOnGuestData;
mpOnGuestData=function(d){
  _origOnGuestData(d);
  if(d.t==='chat'&&d.name!==myNick) chatAddMsg(d.name,d.text);
  if(d.t==='sys') chatAddMsg('',d.text,true);
};

// Chat input handling
$('chat-input').addEventListener('keydown',e=>{
  e.stopPropagation();
  if(e.key==='Enter'){
    chatSend();
    chatToggle();
  }
  if(e.key==='Escape') chatToggle();
});
$('chat-input').addEventListener('keyup',e=>e.stopPropagation());

// T/ã……/Enter key opens chat (override in main keydown)
document.addEventListener('keydown',e=>{
  if(e.key==='t'||e.key==='T'||e.key==='ã……'||(!chatTyping&&e.key==='Enter')){
    if(!chatTyping&&MP.isMP&&!GS.dialogueActive&&!GS.choiceActive&&!GS.minigameActive){
      e.preventDefault();
      chatToggle();
    }
  }
});

// Send nick on join
const _origMpJoinRoom=mpJoinRoom;
mpJoinRoom=function(){
  const _origConn=MP.conns;
  _origMpJoinRoom();
  // After connection, send nickname
  const checkSend=setInterval(()=>{
    if(MP.conns[0]&&MP.conns[0].open){
      MP.conns[0].send({t:'nick',name:myNick});
      clearInterval(checkSend);
    }
  },200);
};
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
