<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Í∏¥Í∏¥Î∞§ - The Long, Long Night</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
--bg-primary:#0a0a12;--bg-secondary:#12121f;--bg-tertiary:#1a1a2e;
--text-primary:#e8e8f0;--text-secondary:#a0a0b8;--text-accent:#f0d080;
--ui-border:#2a2a4a;--ui-panel:rgba(10,10,18,0.92);
--hope-color:#f0d080;--danger-color:#c04040;
--skin-name:"Î∞§";
}
[data-skin="twilight"]{
--bg-primary:#1a0a2a;--bg-secondary:#2a1a3a;--bg-tertiary:#3a2a4a;
--text-primary:#e8d8f0;--text-secondary:#b8a0c8;--text-accent:#e0a0f0;
--ui-border:#4a3a5a;--ui-panel:rgba(26,10,42,0.92);
--hope-color:#e0a0f0;--skin-name:"Ìô©Ìòº";
}
[data-skin="winter"]{
--bg-primary:#0a1a2a;--bg-secondary:#0a2040;--bg-tertiary:#103050;
--text-primary:#d8e8f8;--text-secondary:#90b0d0;--text-accent:#80d0f0;
--ui-border:#2a4a6a;--ui-panel:rgba(10,26,42,0.92);
--hope-color:#80d0f0;--skin-name:"Í≤®Ïö∏";
}
[data-skin="sakura"]{
--bg-primary:#2a1a1a;--bg-secondary:#3a2028;--bg-tertiary:#4a2830;
--text-primary:#f8e0e0;--text-secondary:#d0a0a8;--text-accent:#f0a0b0;
--ui-border:#5a3840;--ui-panel:rgba(42,26,26,0.92);
--hope-color:#f0a0b0;--skin-name:"Î≤öÍΩÉ";
}
[data-skin="oldbook"]{
--bg-primary:#1a1810;--bg-secondary:#2a2618;--bg-tertiary:#3a3420;
--text-primary:#e8e0d0;--text-secondary:#b8b098;--text-accent:#d0b060;
--ui-border:#4a4430;--ui-panel:rgba(26,24,16,0.92);
--hope-color:#d0b060;--skin-name:"Ïò§ÎûòÎêú Ï±Ö";
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg-primary);color:var(--text-primary);font-family:'Noto Sans KR',sans-serif;overflow:hidden;width:100vw;height:100vh;touch-action:none;user-select:none;-webkit-user-select:none;}
#game{position:relative;width:100vw;height:100vh;overflow:hidden;}
#scene{position:absolute;top:0;left:0;width:100%;height:100%;transition:opacity 0.5s;}
.scene-bg{position:absolute;top:0;left:0;width:100%;height:100%;}
/* HUD */
#hud{position:absolute;top:0;left:0;right:0;height:48px;display:flex;align-items:center;padding:0 16px;background:linear-gradient(180deg,rgba(0,0,0,0.6),transparent);z-index:50;pointer-events:none;}
#hud>*{pointer-events:auto;}
#chapter-label{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-secondary);margin-right:16px;}
#hope-bar-wrap{flex:1;max-width:200px;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin-right:8px;}
#hope-bar{height:100%;background:var(--hope-color);border-radius:4px;transition:width 0.8s ease;}
#hope-label{font-size:12px;color:var(--text-accent);margin-right:16px;min-width:30px;}
.hud-btn{background:none;border:1px solid var(--ui-border);color:var(--text-secondary);font-size:13px;padding:4px 10px;border-radius:4px;cursor:pointer;margin-left:6px;font-family:inherit;}
.hud-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);}
/* Dialogue */
#dialogue-box{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:min(90%,700px);background:var(--ui-panel);border:1px solid var(--ui-border);border-radius:12px;padding:20px 24px;z-index:60;display:none;backdrop-filter:blur(8px);}
#dialogue-speaker{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-accent);margin-bottom:8px;}
#dialogue-text{font-size:15px;line-height:1.7;color:var(--text-primary);min-height:48px;}
#dialogue-next{position:absolute;bottom:8px;right:16px;font-size:11px;color:var(--text-secondary);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
/* Choices */
#choices-box{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);width:min(90%,500px);z-index:65;display:none;flex-direction:column;gap:10px;}
.choice-btn{background:var(--ui-panel);border:1px solid var(--ui-border);color:var(--text-primary);font-size:15px;padding:14px 20px;border-radius:10px;cursor:pointer;font-family:inherit;text-align:left;transition:all 0.2s;backdrop-filter:blur(8px);}
.choice-btn:hover{background:var(--bg-tertiary);border-color:var(--text-accent);transform:translateX(4px);}
/* Inventory */
#inventory-panel{position:absolute;top:0;right:-320px;width:300px;height:100%;background:var(--ui-panel);border-left:1px solid var(--ui-border);z-index:80;transition:right 0.3s;padding:20px;overflow-y:auto;backdrop-filter:blur(8px);}
#inventory-panel.open{right:0;}
#inventory-panel h3{font-family:'Noto Serif KR',serif;color:var(--text-accent);margin-bottom:16px;font-size:18px;}
.inv-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--ui-border);border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);}
.inv-icon{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.inv-info{flex:1;}
.inv-name{font-size:13px;color:var(--text-primary);font-weight:700;}
.inv-desc{font-size:11px;color:var(--text-secondary);margin-top:2px;}
#inv-empty{color:var(--text-secondary);font-size:13px;font-style:italic;}
/* Skin panel */
#skin-panel{position:absolute;top:50px;right:10px;background:var(--ui-panel);border:1px solid var(--ui-border);border-radius:10px;padding:12px;z-index:90;display:none;backdrop-filter:blur(8px);}
.skin-option{display:block;width:100%;background:none;border:1px solid var(--ui-border);color:var(--text-primary);font-size:13px;padding:8px 14px;border-radius:6px;cursor:pointer;margin-bottom:4px;font-family:inherit;text-align:left;}
.skin-option:hover,.skin-option.active{background:var(--bg-tertiary);border-color:var(--text-accent);}
/* Chapter overlay */
#chapter-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity 0.6s;}
#chapter-overlay.show{opacity:1;pointer-events:auto;}
#chapter-overlay .ch-num{font-family:'Noto Serif KR',serif;font-size:14px;color:var(--text-secondary);letter-spacing:4px;margin-bottom:8px;}
#chapter-overlay .ch-title{font-family:'Noto Serif KR',serif;font-size:28px;color:var(--text-primary);margin-bottom:12px;}
#chapter-overlay .ch-sub{font-size:14px;color:var(--text-secondary);}
/* Cutscene */
#cutscene{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;z-index:95;opacity:0;pointer-events:none;transition:opacity 0.8s;}
#cutscene.show{opacity:1;pointer-events:auto;}
#cutscene-text{font-family:'Noto Serif KR',serif;font-size:20px;color:var(--text-primary);text-align:center;line-height:2;max-width:600px;padding:40px;}
/* Vignette */
#vignette{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:40;opacity:0;transition:opacity 1s;background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,0.8) 100%);}
#vignette.show{opacity:1;}
/* Title screen */
#title-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#0a0a12;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;}
#title-screen h1{font-family:'Noto Serif KR',serif;font-size:48px;color:var(--text-primary);margin-bottom:8px;}
#title-screen .subtitle{font-size:16px;color:var(--text-secondary);margin-bottom:40px;}
#start-btn{background:none;border:1px solid var(--text-accent);color:var(--text-accent);font-size:18px;padding:12px 40px;border-radius:8px;cursor:pointer;font-family:'Noto Serif KR',serif;transition:all 0.3s;}
#start-btn:hover{background:rgba(240,208,128,0.1);}
/* Ending */
#ending-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px;}
#ending-screen h2{font-family:'Noto Serif KR',serif;font-size:32px;color:var(--text-accent);margin-bottom:16px;}
#ending-screen p{font-size:16px;color:var(--text-primary);line-height:1.8;max-width:500px;margin-bottom:8px;}
#ending-screen .end-items{font-size:13px;color:var(--text-secondary);margin:20px 0;}
#restart-btn{background:none;border:1px solid var(--text-accent);color:var(--text-accent);font-size:16px;padding:10px 32px;border-radius:8px;cursor:pointer;font-family:'Noto Serif KR',serif;margin-top:20px;transition:all 0.3s;}
#restart-btn:hover{background:rgba(240,208,128,0.1);}
/* Characters */
.character{position:absolute;bottom:0;transition:left 0.1s linear,bottom 0.1s;}
/* Noden - rhino */
.noden-sprite{width:56px;height:44px;position:relative;}
.noden-body{position:absolute;width:48px;height:30px;background:linear-gradient(135deg,#8a8a8a,#6a6a6a);border-radius:24px 20px 8px 8px;bottom:10px;left:4px;}
.noden-head{position:absolute;width:24px;height:20px;background:linear-gradient(135deg,#909090,#707070);border-radius:12px 14px 6px 10px;bottom:22px;left:38px;}
.noden-horn{position:absolute;width:6px;height:14px;background:linear-gradient(to top,#b0a080,#d0c8a0);border-radius:3px 3px 1px 1px;bottom:36px;left:48px;transform:rotate(-10deg);}
.noden-eye{position:absolute;width:4px;height:4px;background:#222;border-radius:50%;bottom:30px;left:50px;}
.noden-ear{position:absolute;width:8px;height:6px;background:#808080;border-radius:50% 50% 0 0;bottom:38px;left:40px;}
.noden-leg{position:absolute;width:8px;height:12px;background:#6a6a6a;border-radius:0 0 3px 3px;bottom:0;}
.noden-leg.fl{left:12px;}.noden-leg.fr{left:22px;}.noden-leg.bl{left:32px;}.noden-leg.br{left:40px;}
.noden-tail{position:absolute;width:3px;height:10px;background:#5a5a5a;border-radius:2px;bottom:18px;left:0;transform-origin:top center;}
/* Walking animation */
.character.walking .noden-leg.fl,.character.walking .noden-leg.br{animation:legWalkA 0.35s infinite alternate;}
.character.walking .noden-leg.fr,.character.walking .noden-leg.bl{animation:legWalkB 0.35s infinite alternate;}
.character.walking .noden-tail{animation:tailWag 0.4s infinite alternate;}
@keyframes legWalkA{0%{transform:rotate(-12deg);}100%{transform:rotate(12deg);}}
@keyframes legWalkB{0%{transform:rotate(12deg);}100%{transform:rotate(-12deg);}}
@keyframes tailWag{0%{transform:rotate(-15deg);}100%{transform:rotate(15deg);}}
.character.face-left .noden-sprite{transform:scaleX(-1);}
/* Chiku - penguin */
.chiku-sprite{width:32px;height:38px;position:relative;}
.chiku-body{position:absolute;width:26px;height:28px;background:linear-gradient(135deg,#1a1a2a,#0a0a1a);border-radius:13px 13px 8px 8px;bottom:6px;left:3px;}
.chiku-belly{position:absolute;width:16px;height:18px;background:linear-gradient(180deg,#f0f0f0,#e0e0e0);border-radius:8px;bottom:8px;left:8px;}
.chiku-beak{position:absolute;width:8px;height:5px;background:#e08020;border-radius:0 0 4px 4px;bottom:28px;left:14px;}
.chiku-eye{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;bottom:30px;}
.chiku-eye.l{left:10px;}.chiku-eye.r{left:19px;}
.chiku-foot{position:absolute;width:10px;height:4px;background:#d07020;border-radius:0 0 5px 5px;bottom:0;}
.chiku-foot.l{left:3px;}.chiku-foot.r{left:17px;}
.chiku-egg{position:absolute;width:10px;height:12px;background:linear-gradient(180deg,#f8f8f0,#e8e0d0);border-radius:50%;bottom:10px;left:16px;border:1px solid rgba(0,0,0,0.1);}
.character.walking .chiku-foot.l{animation:pengWalkA 0.3s infinite alternate;}
.character.walking .chiku-foot.r{animation:pengWalkB 0.3s infinite alternate;}
@keyframes pengWalkA{0%{transform:rotate(-8deg);}100%{transform:rotate(8deg);}}
@keyframes pengWalkB{0%{transform:rotate(8deg);}100%{transform:rotate(-8deg);}}
.character.face-left .chiku-sprite{transform:scaleX(-1);}
/* Baby penguin */
.baby-sprite{width:20px;height:24px;position:relative;}
.baby-body{position:absolute;width:16px;height:16px;background:#2a2a3a;border-radius:8px 8px 5px 5px;bottom:4px;left:2px;}
.baby-belly{position:absolute;width:10px;height:10px;background:#f0f0f0;border-radius:5px;bottom:5px;left:5px;}
.baby-fluff{position:absolute;width:20px;height:10px;background:radial-gradient(ellipse,rgba(180,180,200,0.4),transparent);border-radius:50%;bottom:12px;left:0;}
.baby-beak{position:absolute;width:5px;height:3px;background:#e08020;border-radius:0 0 3px 3px;bottom:16px;left:9px;}
.baby-eye{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;bottom:17px;}
.baby-eye.l{left:6px;}.baby-eye.r{left:12px;}
.baby-foot{position:absolute;width:7px;height:3px;background:#d07020;border-radius:0 0 4px 4px;bottom:0;}
.baby-foot.l{left:1px;}.baby-foot.r{left:11px;}
.character.walking .baby-foot.l{animation:pengWalkA 0.3s infinite alternate;}
.character.walking .baby-foot.r{animation:pengWalkB 0.3s infinite alternate;}
.character.face-left .baby-sprite{transform:scaleX(-1);}
/* NPC generic */
.npc-sprite{position:relative;pointer-events:none;}
.npc-label{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--text-accent);white-space:nowrap;pointer-events:none;}
.interact-hint{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--text-accent);white-space:nowrap;animation:blink 1s infinite;pointer-events:none;display:none;}
/* Scene elements */
.scene-element{position:absolute;pointer-events:none;}
.star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:twinkle var(--dur,3s) infinite alternate;}
@keyframes twinkle{0%{opacity:0.3;transform:scale(0.8);}100%{opacity:1;transform:scale(1.2);}}
.grass{position:absolute;bottom:0;width:6px;height:18px;background:linear-gradient(to top,#2a4a20,#3a6a30);border-radius:3px 3px 0 0;transform-origin:bottom center;animation:sway 2s infinite alternate ease-in-out;}
@keyframes sway{0%{transform:rotate(-5deg);}100%{transform:rotate(5deg);}}
.rain{position:absolute;width:1px;height:12px;background:linear-gradient(to bottom,transparent,rgba(150,180,220,0.6));animation:fall var(--dur,1s) linear infinite;top:var(--top,-20px);left:var(--left,50%);}
@keyframes fall{0%{transform:translateY(-20px);opacity:1;}100%{transform:translateY(100vh);opacity:0;}}
/* Ground */
.ground{position:absolute;bottom:0;left:0;width:100%;pointer-events:none;}
/* D-pad mobile */
#dpad{position:absolute;bottom:20px;left:20px;z-index:70;display:none;}
.dpad-btn{position:absolute;width:44px;height:44px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:rgba(255,255,255,0.6);-webkit-tap-highlight-color:transparent;}
.dpad-btn:active{background:rgba(255,255,255,0.25);}
.dpad-up{left:48px;top:0;}.dpad-down{left:48px;top:96px;}.dpad-left{left:0;top:48px;}.dpad-right{left:96px;top:48px;}
#mobile-actions{position:absolute;bottom:20px;right:20px;z-index:70;display:none;gap:10px;}
.mobile-btn{width:50px;height:50px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;color:rgba(255,255,255,0.7);-webkit-tap-highlight-color:transparent;}
.mobile-btn:active{background:rgba(255,255,255,0.25);}
/* Responsive */
@media(max-width:768px){
  #dpad{display:block;}
  #mobile-actions{display:flex;}
  #dialogue-box{bottom:160px;width:92%;}
  #choices-box{bottom:160px;}
  #hud{height:40px;}
  #chapter-overlay .ch-title{font-size:22px;}
}
/* Music toggle */
#music-btn{position:absolute;top:10px;left:10px;z-index:55;}
</style>
</head>
<body>
<div id="game">
  <!-- Title -->
  <div id="title-screen">
    <h1>Í∏¥Í∏¥Î∞§</h1>
    <div class="subtitle">The Long, Long Night</div>
    <button id="start-btn">Ïó¨Ï†ïÏùÑ ÏãúÏûëÌïòÎã§</button>
  </div>
  <!-- Scene container -->
  <div id="scene"></div>
  <!-- HUD -->
  <div id="hud" style="display:none;">
    <div id="chapter-label"></div>
    <div id="hope-bar-wrap"><div id="hope-bar" style="width:60%"></div></div>
    <div id="hope-label">60</div>
    <button class="hud-btn" id="music-btn" title="ÏùåÏïÖ">&#9835;</button>
    <button class="hud-btn" id="inv-btn" title="ÏÜåÏßÄÌíà (I)">ÏÜåÏßÄÌíà</button>
    <button class="hud-btn" id="skin-btn" title="ÌÖåÎßà">ÌÖåÎßà</button>
  </div>
  <!-- Dialogue -->
  <div id="dialogue-box">
    <div id="dialogue-speaker"></div>
    <div id="dialogue-text"></div>
    <div id="dialogue-next">Space / ÌÅ¥Î¶≠ &#9654;</div>
  </div>
  <!-- Choices -->
  <div id="choices-box"></div>
  <!-- Inventory -->
  <div id="inventory-panel">
    <h3>ÏÜåÏßÄÌíà</h3>
    <div id="inv-list"><div id="inv-empty">ÏïÑÏßÅ ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏäµÎãàÎã§...</div></div>
  </div>
  <!-- Skin panel -->
  <div id="skin-panel">
    <button class="skin-option active" data-skin="">Î∞§ (Í∏∞Î≥∏)</button>
    <button class="skin-option" data-skin="twilight">Ìô©Ìòº</button>
    <button class="skin-option" data-skin="winter">Í≤®Ïö∏</button>
    <button class="skin-option" data-skin="sakura">Î≤öÍΩÉ</button>
    <button class="skin-option" data-skin="oldbook">Ïò§ÎûòÎêú Ï±Ö</button>
  </div>
  <!-- Chapter overlay -->
  <div id="chapter-overlay">
    <div class="ch-num"></div>
    <div class="ch-title"></div>
    <div class="ch-sub"></div>
  </div>
  <!-- Cutscene -->
  <div id="cutscene"><div id="cutscene-text"></div></div>
  <!-- Vignette -->
  <div id="vignette"></div>
  <!-- Ending -->
  <div id="ending-screen">
    <h2 id="ending-title"></h2>
    <p id="ending-text"></p>
    <div id="ending-items" class="end-items"></div>
    <button id="restart-btn">Îã§Ïãú ÏãúÏûëÌïòÍ∏∞</button>
  </div>
  <!-- Mobile controls -->
  <div id="dpad">
    <div class="dpad-btn dpad-up" data-dir="up">&#9650;</div>
    <div class="dpad-btn dpad-down" data-dir="down">&#9660;</div>
    <div class="dpad-btn dpad-left" data-dir="left">&#9664;</div>
    <div class="dpad-btn dpad-right" data-dir="right">&#9654;</div>
  </div>
  <div id="mobile-actions">
    <div class="mobile-btn" id="m-interact">Act</div>
    <div class="mobile-btn" id="m-inv">I</div>
  </div>
</div>
<script>
// ===== GAME ENGINE =====
const $ = id => document.getElementById(id);
const GS = {
  chapter: 0, hope: 60, items: [], flags: {},
  px: 200, py: 0, companion: null, babyPenguin: false,
  transitioning: false, dialogueActive: false, choiceActive: false,
  musicOn: true, sceneKey: '', facing: 'right',
  moving: { up:false, down:false, left:false, right:false }
};

// ===== AUDIO ENGINE =====
let audioCtx, masterGain, musicGain, sfxGain, currentMusic = null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value=0.3; masterGain.connect(audioCtx.destination);
  musicGain = audioCtx.createGain(); musicGain.gain.value=0.5; musicGain.connect(masterGain);
  sfxGain = audioCtx.createGain(); sfxGain.gain.value=0.6; sfxGain.connect(masterGain);
}
function toggleMusic(){
  GS.musicOn=!GS.musicOn;
  if(musicGain) musicGain.gain.value=GS.musicOn?0.5:0;
  $('music-btn').style.opacity=GS.musicOn?1:0.4;
}
function playNote(freq, dur, type='sine', gain=0.15, dest=null){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.setValueAtTime(gain, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+dur);
  o.connect(g); g.connect(dest||musicGain);
  o.start(); o.stop(audioCtx.currentTime+dur);
}
function playSfx(type){
  if(!audioCtx)return;
  if(type==='item'){
    [523,659,784].forEach((f,i)=>setTimeout(()=>playNote(f,0.15,'triangle',0.2,sfxGain),i*80));
  } else if(type==='sad'){
    [440,392,349].forEach((f,i)=>setTimeout(()=>playNote(f,0.4,'sine',0.15,sfxGain),i*200));
  } else if(type==='hope'){
    [523,659,784,1047].forEach((f,i)=>setTimeout(()=>playNote(f,0.2,'triangle',0.15,sfxGain),i*100));
  }
}
// Procedural music loops
const SCALES = {
  orphanage: [220,261,293,349,392,440,523], // Am warm
  savanna: [293,329,392,440,523,587,659], // D major bright
  zoo: [233,261,311,349,415,466,523], // Bb minor cold
  escape: [329,392,466,523,587,659,784], // E minor tense
  forest: [261,293,349,392,440,523,587], // C major gentle
  journey: [220,261,329,392,440,523,659], // Am pentatonic-ish
  farewell: [196,220,261,293,349,392,440], // G minor sad
  sea: [329,392,440,523,587,659,784] // E major bright
};
let musicInterval=null;
function startMusic(key){
  stopMusic();
  if(!audioCtx)return;
  const scale=SCALES[key]||SCALES.journey;
  let idx=0;
  const tempos={orphanage:600,savanna:450,zoo:700,escape:280,forest:550,journey:500,farewell:650,sea:400};
  const tempo=tempos[key]||500;
  const types={zoo:'square',escape:'sawtooth'};
  const type=types[key]||'sine';
  const gains={orphanage:0.08,farewell:0.07,sea:0.1};
  const gain=gains[key]||0.08;
  musicInterval=setInterval(()=>{
    if(!GS.musicOn)return;
    const note=scale[idx%scale.length];
    const octave=Math.random()>0.7?2:1;
    playNote(note*octave, tempo/1000*1.5, type, gain);
    if(Math.random()>0.5){
      const harm=scale[(idx+2)%scale.length];
      setTimeout(()=>playNote(harm*octave, tempo/1000, type, gain*0.5), tempo*0.25);
    }
    idx++;
  }, tempo);
}
function stopMusic(){ if(musicInterval){clearInterval(musicInterval);musicInterval=null;} }

// ===== SCENE SYSTEM =====
function buildScene(key){
  GS.sceneKey=key;
  const sc=$('scene');
  sc.innerHTML='';
  const def=SCENES[key];
  if(!def)return;
  // Background
  const bg=document.createElement('div');
  bg.className='scene-bg';
  bg.style.background=def.bg;
  sc.appendChild(bg);
  // Ground
  if(def.ground){
    const g=document.createElement('div');
    g.className='ground';
    g.style.height=def.ground.height||'80px';
    g.style.background=def.ground.bg;
    sc.appendChild(g);
  }
  // Stars
  if(def.stars){
    for(let i=0;i<def.stars;i++){
      const s=document.createElement('div');
      s.className='star';
      s.style.left=Math.random()*100+'%';
      s.style.top=Math.random()*50+'%';
      s.style.setProperty('--dur',(2+Math.random()*4)+'s');
      s.style.width=(1+Math.random()*2)+'px';
      s.style.height=s.style.width;
      sc.appendChild(s);
    }
  }
  // Rain
  if(def.rain){
    for(let i=0;i<60;i++){
      const r=document.createElement('div');
      r.className='rain';
      r.style.setProperty('--left',Math.random()*100+'%');
      r.style.setProperty('--dur',(0.5+Math.random()*0.5)+'s');
      r.style.animationDelay=Math.random()*2+'s';
      sc.appendChild(r);
    }
  }
  // Grass
  if(def.grassCount){
    for(let i=0;i<def.grassCount;i++){
      const g=document.createElement('div');
      g.className='grass';
      g.style.left=Math.random()*100+'%';
      g.style.height=(12+Math.random()*14)+'px';
      g.style.animationDelay=Math.random()*2+'s';
      if(def.grassColor)g.style.background=def.grassColor;
      sc.appendChild(g);
    }
  }
  // Decorations
  if(def.decorations){
    def.decorations.forEach(d=>{
      const el=document.createElement('div');
      el.className='scene-element';
      el.style.cssText=d.style;
      el.innerHTML=d.html||'';
      sc.appendChild(el);
    });
  }
  // NPCs
  if(def.npcs){
    def.npcs.forEach(npc=>{
      if(npc.condition && !npc.condition()) return;
      const el=document.createElement('div');
      el.className='character npc';
      el.dataset.id=npc.id;
      el.style.left=npc.x+'px';
      el.style.bottom=(def.ground?parseInt(def.ground.height)||80:80)+'px';
      el.innerHTML=`<div class="interact-hint">Space / ÌÅ¥Î¶≠</div><div class="npc-label">${npc.name}</div>${npc.sprite}`;
      el.style.cursor='pointer';
      el.style.pointerEvents='auto';
      el.addEventListener('click',()=>interactWithNPC(npc));
      sc.appendChild(el);
    });
  }
  // Items on ground
  if(def.groundItems){
    def.groundItems.forEach(gi=>{
      if(gi.condition && !gi.condition()) return;
      if(GS.items.find(it=>it.id===gi.id)) return;
      const el=document.createElement('div');
      el.className='scene-element';
      el.dataset.itemId=gi.id;
      el.style.position='absolute';
      el.style.left=gi.x+'px';
      el.style.bottom=(def.ground?parseInt(def.ground.height)||80:80)+'px';
      el.style.fontSize='24px';
      el.style.cursor='pointer';
      el.style.pointerEvents='auto';
      el.style.animation='blink 1.5s infinite';
      el.textContent=gi.icon;
      el.addEventListener('click',()=>pickupItem(gi));
      sc.appendChild(el);
    });
  }
  // Player
  createPlayer(sc, def);
  // Companion
  if(GS.companion==='chiku') createCompanion(sc, def, 'chiku');
  if(GS.babyPenguin) createCompanion(sc, def, 'baby');
  // Music
  if(def.music) startMusic(def.music);
}

function createPlayer(sc, def){
  const el=document.createElement('div');
  el.id='player';
  el.className='character';
  const groundH=def.ground?parseInt(def.ground.height)||80:80;
  el.style.bottom=groundH+'px';
  el.style.left=GS.px+'px';
  el.innerHTML=`<div class="noden-sprite">
    <div class="noden-tail"></div>
    <div class="noden-body"></div>
    <div class="noden-head"></div>
    <div class="noden-horn"></div>
    <div class="noden-ear"></div>
    <div class="noden-eye"></div>
    <div class="noden-leg fl"></div>
    <div class="noden-leg fr"></div>
    <div class="noden-leg bl"></div>
    <div class="noden-leg br"></div>
  </div>`;
  sc.appendChild(el);
}

function createCompanion(sc, def, type){
  const el=document.createElement('div');
  el.id='companion';
  el.className='character';
  const groundH=def.ground?parseInt(def.ground.height)||80:80;
  el.style.bottom=groundH+'px';
  el.style.left=(GS.px-50)+'px';
  if(type==='chiku'){
    const hasEgg=!GS.flags.chikuNoEgg;
    el.innerHTML=`<div class="chiku-sprite">
      <div class="chiku-body"></div>
      <div class="chiku-belly"></div>
      ${hasEgg?'<div class="chiku-egg"></div>':''}
      <div class="chiku-beak"></div>
      <div class="chiku-eye l"></div>
      <div class="chiku-eye r"></div>
      <div class="chiku-foot l"></div>
      <div class="chiku-foot r"></div>
    </div>`;
  } else {
    el.innerHTML=`<div class="baby-sprite">
      <div class="baby-body"></div>
      <div class="baby-belly"></div>
      <div class="baby-fluff"></div>
      <div class="baby-beak"></div>
      <div class="baby-eye l"></div>
      <div class="baby-eye r"></div>
      <div class="baby-foot l"></div>
      <div class="baby-foot r"></div>
    </div>`;
  }
  sc.appendChild(el);
}

// ===== MOVEMENT =====
const SPEED=3;
function gameLoop(){
  if(!GS.transitioning && !GS.dialogueActive && !GS.choiceActive){
    let dx=0;
    if(GS.moving.left) dx=-SPEED;
    if(GS.moving.right) dx=SPEED;
    if(dx!==0){
      const def=SCENES[GS.sceneKey];
      const minX=def?.bounds?.left??20;
      const maxX=def?.bounds?.right??(window.innerWidth-60);
      GS.px=Math.max(minX, Math.min(maxX, GS.px+dx));
      GS.facing=dx>0?'right':'left';
      const p=$('player');
      if(p){
        p.style.left=GS.px+'px';
        p.classList.add('walking');
        p.classList.toggle('face-left', GS.facing==='left');
      }
      // Companion follow
      const comp=$('companion');
      if(comp){
        const cx=parseFloat(comp.style.left)||0;
        const targetX=GS.px-(GS.facing==='right'?50:-50);
        const cdx=(targetX-cx)*0.05;
        comp.style.left=(cx+cdx)+'px';
        if(Math.abs(cdx)>0.5){
          comp.classList.add('walking');
          comp.classList.toggle('face-left',cdx<0);
        } else {
          comp.classList.remove('walking');
        }
      }
      // Check exit
      checkExit();
      // Check NPC proximity
      checkNPCProximity();
    } else {
      const p=$('player');
      if(p) p.classList.remove('walking');
      const comp=$('companion');
      if(comp) comp.classList.remove('walking');
    }
  }
  requestAnimationFrame(gameLoop);
}

function checkExit(){
  const def=SCENES[GS.sceneKey];
  if(!def||!def.exits||GS.transitioning)return;
  def.exits.forEach(ex=>{
    if(ex.condition && !ex.condition()) return;
    if(Math.abs(GS.px-ex.x)<30){
      if(ex.type==='scene') loadScene(ex.target, ex.playerX);
      else if(ex.type==='dialogue') startDialogue(ex.dialogue);
      else if(ex.type==='chapter') showChapter(ex.chapter, ex.target, ex.playerX);
    }
  });
}

function checkNPCProximity(){
  const npcs=document.querySelectorAll('.npc');
  npcs.forEach(n=>{
    const nx=parseFloat(n.style.left)||0;
    const hint=n.querySelector('.interact-hint');
    if(hint) hint.style.display=Math.abs(GS.px-nx)<60?'block':'none';
  });
}

// ===== DIALOGUE SYSTEM =====
let dialogueQueue=[], dlgIdx=0, typeTimer=null, fullText='';
function startDialogue(lines){
  if(GS.dialogueActive)return;
  dialogueQueue=typeof lines==='function'?lines():lines;
  dlgIdx=0;
  GS.dialogueActive=true;
  $('dialogue-box').style.display='block';
  showLine();
}
function showLine(){
  if(dlgIdx>=dialogueQueue.length){ endDialogue(); return; }
  const line=dialogueQueue[dlgIdx];
  // Check for special actions
  if(line.action){
    line.action();
    dlgIdx++;
    showLine();
    return;
  }
  if(line.choice){
    endDialogue();
    showChoices(line.choice);
    return;
  }
  $('dialogue-speaker').textContent=line.speaker||'';
  fullText=typeof line.text==='function'?line.text():line.text;
  $('dialogue-text').textContent='';
  $('dialogue-next').style.display='none';
  let ci=0;
  clearInterval(typeTimer);
  typeTimer=setInterval(()=>{
    if(ci<fullText.length){
      $('dialogue-text').textContent+=fullText[ci]; ci++;
    } else {
      clearInterval(typeTimer);
      $('dialogue-next').style.display='block';
    }
  },30);
}
function advanceDialogue(){
  if(!GS.dialogueActive)return;
  if($('dialogue-text').textContent.length<fullText.length){
    clearInterval(typeTimer);
    $('dialogue-text').textContent=fullText;
    $('dialogue-next').style.display='block';
  } else {
    dlgIdx++;
    showLine();
  }
}
function endDialogue(){
  GS.dialogueActive=false;
  $('dialogue-box').style.display='none';
  clearInterval(typeTimer);
}

// ===== CHOICES =====
function showChoices(choices){
  GS.choiceActive=true;
  const box=$('choices-box');
  box.innerHTML='';
  box.style.display='flex';
  choices.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='choice-btn';
    btn.textContent=c.text;
    btn.addEventListener('click',()=>{
      box.style.display='none';
      GS.choiceActive=false;
      if(c.action) c.action();
      if(c.flag) GS.flags[c.flag]=c.flagValue!==undefined?c.flagValue:true;
      if(c.hope) changeHope(c.hope);
      if(c.next) startDialogue(c.next);
      if(c.scene) loadScene(c.scene, c.playerX);
      if(c.chapter) showChapter(c.chapter, c.scene, c.playerX);
    });
    box.appendChild(btn);
  });
}

// ===== INVENTORY =====
function addItem(item){
  if(GS.items.find(i=>i.id===item.id))return;
  GS.items.push(item);
  playSfx('item');
  renderInventory();
  // Flash notification
  const notif=document.createElement('div');
  notif.style.cssText='position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--ui-panel);border:1px solid var(--text-accent);color:var(--text-accent);padding:8px 20px;border-radius:8px;font-size:13px;z-index:100;animation:fadeInOut 2s forwards;';
  notif.textContent=`${item.icon} ${item.name} ÌöçÎìù!`;
  document.body.appendChild(notif);
  setTimeout(()=>notif.remove(),2000);
}
function renderInventory(){
  const list=$('inv-list');
  if(GS.items.length===0){ list.innerHTML='<div id="inv-empty">ÏïÑÏßÅ ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏäµÎãàÎã§...</div>'; return; }
  list.innerHTML='';
  GS.items.forEach(it=>{
    const d=document.createElement('div');
    d.className='inv-item';
    d.innerHTML=`<div class="inv-icon">${it.icon}</div><div class="inv-info"><div class="inv-name">${it.name}</div><div class="inv-desc">${it.desc}</div></div>`;
    list.appendChild(d);
  });
}
function pickupItem(gi){
  addItem({id:gi.id, name:gi.name, icon:gi.icon, desc:gi.desc});
  const el=document.querySelector(`[data-item-id="${gi.id}"]`);
  if(el) el.remove();
  if(gi.dialogue) startDialogue(gi.dialogue);
}
function toggleInventory(){
  $('inventory-panel').classList.toggle('open');
}

// ===== HOPE =====
function changeHope(delta){
  GS.hope=Math.max(0,Math.min(100,GS.hope+delta));
  $('hope-bar').style.width=GS.hope+'%';
  $('hope-label').textContent=GS.hope;
  if(delta>0) playSfx('hope');
  if(delta<0) playSfx('sad');
}

// ===== SCENE TRANSITIONS =====
function loadScene(key, playerX){
  if(GS.transitioning)return;
  GS.transitioning=true;
  GS.moving={up:false,down:false,left:false,right:false};
  $('scene').style.opacity=0;
  setTimeout(()=>{
    if(playerX!==undefined) GS.px=playerX;
    buildScene(key);
    updateHUD();
    $('scene').style.opacity=1;
    setTimeout(()=>{GS.transitioning=false;},300);
  },500);
}
function showChapter(ch, target, playerX){
  if(GS.transitioning)return;
  GS.transitioning=true;
  GS.moving={up:false,down:false,left:false,right:false};
  GS.chapter=ch;
  const info=CHAPTER_INFO[ch];
  const ov=$('chapter-overlay');
  ov.querySelector('.ch-num').textContent=`Ï†ú ${ch}Ïû•`;
  ov.querySelector('.ch-title').textContent=info?.title||'';
  ov.querySelector('.ch-sub').textContent=info?.sub||'';
  ov.classList.add('show');
  setTimeout(()=>{
    ov.classList.remove('show');
    if(playerX!==undefined) GS.px=playerX;
    buildScene(target);
    updateHUD();
    $('scene').style.opacity=1;
    setTimeout(()=>{GS.transitioning=false;},500);
  },2500);
}
function showCutscene(lines, callback){
  GS.transitioning=true;
  const cs=$('cutscene');
  const ct=$('cutscene-text');
  cs.classList.add('show');
  $('vignette').classList.add('show');
  let idx=0;
  function showNext(){
    if(idx>=lines.length){
      cs.classList.remove('show');
      $('vignette').classList.remove('show');
      GS.transitioning=false;
      if(callback) callback();
      return;
    }
    ct.style.opacity=0;
    setTimeout(()=>{
      ct.textContent=lines[idx];
      ct.style.opacity=1;
      ct.style.transition='opacity 0.8s';
      idx++;
      setTimeout(showNext, 2500);
    },500);
  }
  showNext();
}
function updateHUD(){
  const info=CHAPTER_INFO[GS.chapter];
  $('chapter-label').textContent=info?`${info.title}`:'';
}

// ===== NPC INTERACT =====
function interactWithNPC(npc){
  if(Math.abs(GS.px-(npc.x||0))>80)return;
  if(npc.dialogue){
    const d=typeof npc.dialogue==='function'?npc.dialogue():npc.dialogue;
    startDialogue(d);
  }
}

// ===== SKINS =====
function applySkin(name){
  document.documentElement.dataset.skin=name||'';
  localStorage.setItem('ggg-skin',name||'');
  document.querySelectorAll('.skin-option').forEach(b=>{
    b.classList.toggle('active',b.dataset.skin===name);
  });
}

// ===== ENDING =====
function showEnding(type){
  stopMusic();
  GS.transitioning=true;
  const endings={
    hope:{
      title:'Ìù¨ÎßùÏùò Îπõ',
      text:'ÏÉàÎÅº Ìé≠Í∑ÑÏùÄ Ï≤òÏùåÏúºÎ°ú ÎÑìÏùÄ Î∞îÎã§Î•º Î≥¥ÏïòÏäµÎãàÎã§.\n\nÏûëÏùÄ ÎÇ†Í∞úÎ•º ÌéÑÎü≠Ïù¥Î©∞ ÌååÎèÑ ÏÜçÏúºÎ°ú Îì§Ïñ¥Í∞ÄÎäî Î™®ÏäµÏùÑ Î∞îÎùºÎ≥¥Î©∞,\nÎÖ∏Îì†ÏùÄ Ïò§Îûú ÏÑ∏Ïõî ÎèôÏïà Í∞ÄÏä¥Ïóê ÌíàÏñ¥ÏôîÎçò Î¨¥Í±∞Ïö¥ ÏßêÏù¥\nÏ°∞Í∏àÏî© ÎÇ¥Î†§ÎÜìÏïÑÏßÄÎäî Í≤ÉÏùÑ ÎäêÍºàÏäµÎãàÎã§.\n\nÍ∏¥Í∏¥Î∞§Ïù¥ ÎÅùÎÇòÍ≥†, ÎßàÏπ®ÎÇ¥ ÏïÑÏπ®Ïù¥ ÏôîÏäµÎãàÎã§.'
    },
    together:{
      title:'Ìï®ÍªòÌïòÎäî ÏïÑÏπ®',
      text:'ÎÖ∏Îì†Í≥º ÏûëÏùÄ Ìé≠Í∑ÑÏùÄ Î∞îÎã∑Í∞ÄÏóê ÎÇòÎûÄÌûà ÏÑ∞ÏäµÎãàÎã§.\n\nÌòºÏûêÏòÄÎçò ÏãúÍ∞Ñ, Ìï®ÍªòÌñàÎçò ÏãúÍ∞Ñ,\nÍ∑∏Î¶¨Í≥† ÏïûÏúºÎ°ú Ìï®ÍªòÌï† ÏãúÍ∞Ñ.\n\nÌååÎèÑ ÏÜåÎ¶¨Í∞Ä Îëê ÏπúÍµ¨Ïùò ÏÉàÎ°úÏö¥ ÏãúÏûëÏùÑ Ï∂ïÌïòÌïòÎìØ\nÎ∂ÄÎìúÎüΩÍ≤å Ïö∏Î†§ ÌçºÏ°åÏäµÎãàÎã§.\n\nÏù¥Ï†ú Í∏¥Í∏¥Î∞§ÏùÄ ÎÅùÎÇ¨Í≥†, Îî∞ÎúªÌïú ÏïÑÏπ®Ïù¥ ÏãúÏûëÎê©ÎãàÎã§.'
    },
    memory:{
      title:'Í∏∞ÏñµÏùò Î≥Ñ',
      text:'ÎÖ∏Îì†ÏùÄ Ìíà ÏïàÏùò Ï°∞ÏïΩÎèåÏùÑ ÎßåÏ†∏Î≥¥ÏïòÏäµÎãàÎã§.\nÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßàÏùò Îî∞ÎúªÌïú Î™©ÏÜåÎ¶¨,\nÌï®Íªò Îã¨Î†∏Îçò Ï¥àÏõêÏùò Î∞îÎûå,\nÏïôÍ∞ÄÎ∂ÄÍ∞Ä ÏßÄÏºúÏ§Ä Í∑∏ Î∞§,\nÏπòÏø†Ïùò ÏûëÏùÄ Ïà®ÏÜåÎ¶¨...\n\nÎ™®Îì† ÎßåÎÇ®Ïù¥ Î≥ÑÏù¥ ÎêòÏñ¥ Î∞§ÌïòÎäòÏùÑ Í∞ÄÎìù Ï±ÑÏõ†ÏäµÎãàÎã§.\nÍ∑∏Î¶¨Í≥† Í∑∏ Î≥ÑÎπõ ÏïÑÎûò, ÏûëÏùÄ Ìé≠Í∑ÑÏù¥ Ï≤´ ÌååÎèÑÎ•º ÎßåÎÇ¨ÏäµÎãàÎã§.\n\nÍ∏¥Í∏¥Î∞§Ïùò Î≥ÑÎì§ÏùÄ ÏòÅÏõêÌûà ÎπõÎÇòÍ≥† ÏûàÏóàÏäµÎãàÎã§.'
    }
  };
  const e=endings[type]||endings.hope;
  $('ending-title').textContent=e.title;
  $('ending-text').textContent=e.text;
  $('ending-items').textContent=GS.items.length>0?'ÏàòÏßëÌïú Í∏∞Ïñµ: '+GS.items.map(i=>i.icon+' '+i.name).join(', '):'';
  $('ending-screen').style.display='flex';
  // Ending music
  if(audioCtx){
    setTimeout(()=>{
      [329,392,523,659,784].forEach((f,i)=>setTimeout(()=>playNote(f,1.5,'sine',0.1,sfxGain),i*300));
    },500);
  }
}

function restartGame(){
  GS.chapter=0; GS.hope=60; GS.items=[]; GS.flags={};
  GS.px=200; GS.companion=null; GS.babyPenguin=false;
  GS.transitioning=false; GS.dialogueActive=false; GS.choiceActive=false;
  GS.facing='right'; GS.moving={up:false,down:false,left:false,right:false};
  $('ending-screen').style.display='none';
  $('dialogue-box').style.display='none';
  $('choices-box').style.display='none';
  $('vignette').classList.remove('show');
  $('cutscene').classList.remove('show');
  $('inventory-panel').classList.remove('open');
  $('hope-bar').style.width='60%';
  $('hope-label').textContent='60';
  renderInventory();
  stopMusic();
  showChapter(1,'ch1_orphanage',200);
}

// ===== CHAPTER INFO =====
const CHAPTER_INFO={
  1:{title:'ÏΩîÎÅºÎ¶¨ Í≥†ÏïÑÏõê',sub:'ÌòºÏûêÍ∞Ä Îêú ÏïÑÏù¥'},
  2:{title:'ÏÇ¨Î∞îÎÇòÏùò Í∞ÄÏ°±',sub:'ÎÑìÏùÄ Ï¥àÏõê ÏúÑÏùò Íøà'},
  3:{title:'ÎèôÎ¨ºÏõê',sub:'Ï≤†Ï∞Ω ÎÑàÎ®∏Ïùò ÌïòÎäò'},
  4:{title:'ÌÉàÏ∂ú',sub:'Î¨¥ÎÑàÏßÄÎäî Î≤Ω'},
  5:{title:'ÏπòÏø†ÏôÄÏùò ÌÉêÌóò',sub:'ÎπÑ Ïò§Îäî Î∞§Ïùò ÏûëÏùÄ Ïò®Í∏∞'},
  6:{title:'Í∏¥Í∏¥Î∞§Ïùò Ïó¨Ï†ï',sub:'Î≥ÑÎπõ ÏïÑÎûò Í±∑Îäî Í∏∏'},
  7:{title:'Ïù¥Î≥Ñ',sub:'Í∞ÄÏû• Ïñ¥ÎëêÏö¥ ÏÉàÎ≤Ω'},
  8:{title:'Î∞îÎã§Î°ú',sub:'Ï≤´ Î≤àÏß∏ ÏïÑÏπ®'}
};

// ===== SCENE DEFINITIONS =====
const SCENES={
  // --- CHAPTER 1: Orphanage ---
  ch1_orphanage:{
    bg:'linear-gradient(180deg,#0a0a18 0%,#1a1020 40%,#3a2810 70%,#5a4020 100%)',
    ground:{height:'90px',bg:'linear-gradient(180deg,#4a3020,#3a2418)'},
    stars:40,
    grassCount:20,
    grassColor:'linear-gradient(to top,#3a3020,#5a4a30)',
    music:'orphanage',
    bounds:{left:20,right:900},
    decorations:[
      {style:'left:100px;bottom:90px;width:80px;height:60px;background:linear-gradient(135deg,#4a3a28,#3a2a1a);border-radius:8px 8px 0 0;opacity:0.6;',html:'<div style="position:absolute;top:10px;left:15px;width:12px;height:15px;background:rgba(255,200,100,0.3);border-radius:2px;"></div>'},
      {style:'left:400px;bottom:90px;width:120px;height:50px;background:linear-gradient(135deg,#5a4a30,#4a3a20);border-radius:6px;opacity:0.5;'},
      {style:'left:600px;bottom:90px;font-size:40px;pointer-events:none;opacity:0.3;',html:'&#127795;'}
    ],
    npcs:[
      {id:'elephant',name:'ÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßà',x:350,
       sprite:'<div style="width:60px;height:50px;position:relative;pointer-events:none;"><div style="position:absolute;width:50px;height:35px;background:linear-gradient(135deg,#8a8a80,#6a6a60);border-radius:25px 20px 8px 8px;bottom:10px;left:5px;"></div><div style="position:absolute;width:18px;height:25px;background:#7a7a70;border-radius:0 0 8px 8px;bottom:10px;left:35px;transform:rotate(10deg);"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:10px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:22px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:32px;"></div><div style="position:absolute;width:6px;height:12px;background:#6a6a60;border-radius:0 0 3px 3px;bottom:0;left:42px;"></div><div style="position:absolute;width:3px;height:3px;background:#222;border-radius:50%;bottom:36px;left:44px;"></div></div>',
       dialogue:()=>[
         {speaker:'ÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßà',text:'ÎÖ∏Îì†ÏïÑ, ÏïÑÏßÅ Ïïà Ïû§Îãà? Î≥ÑÏù¥ Ï∞∏ Î∞ùÏùÄ Î∞§Ïù¥Íµ¨ÎÇò.'},
         {speaker:'ÎÖ∏Îì†',text:'ÏïÑÏ§åÎßà... ÎÇòÎäî Ïôú Îã§Î•∏ Ïï†Îì§Ïù¥Îûë Îã§Î•¥Í≤å ÏÉùÍ≤ºÏñ¥Ïöî?'},
         {speaker:'ÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßà',text:'Îã§Î•¥Îã§Í≥†? ÌïòÌïò, ÎÑ§Í∞Ä ÌäπÎ≥ÑÌïú Í±∞ÎûÄÎã§. ÎÑàÏùò ÏóÑÎßàÎèÑ ÏïÑÏ£º Î©ãÏßÑ ÏΩîÎøîÏÜåÏòÄÏñ¥.'},
         {speaker:'ÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßà',text:'ÎÑ§ ÏóÑÎßàÍ∞Ä ÎÇ®Í∏¥ Í≤å ÌïòÎÇò ÏûàÎã®Îã§. Ïù¥ ÏûëÏùÄ Ï°∞ÏïΩÎèå... Ìï≠ÏÉÅ Í∞ÄÏßÄÍ≥† Îã§ÎÖÄÎ†¥.'},
         {action:()=>addItem({id:'pebble',name:'ÏóÑÎßàÏùò Ï°∞ÏïΩÎèå',icon:'ü™®',desc:'ÏóÑÎßàÏùò Í∏∞ÏñµÏù¥ Îã¥Í∏¥ ÏûëÍ≥† Îß§ÎÅÑÎü¨Ïö¥ Ï°∞ÏïΩÎèå'})},
         {speaker:'ÏΩîÎÅºÎ¶¨ ÏïÑÏ§åÎßà',text:'ÏÑ∏ÏÉÅÏùÄ ÎÑìÍ≥†, ÎïåÎ°úÎäî Î¨¥ÏÑ≠Í∏∞ÎèÑ ÌïòÏßÄÎßå... ÎÑàÎùºÎ©¥ Í¥úÏ∞ÆÏùÑ Í±∞Ïïº.'},
         {speaker:'ÎÖ∏Îì†',text:'...Í≥†ÎßàÏõåÏöî, ÏïÑÏ§åÎßà.'},
         {action:()=>changeHope(5)}
       ]
      }
    ],
    exits:[
      {x:880,type:'dialogue',dialogue:[
        {speaker:'ÎÖ∏Îì†',text:'(Í≥†ÏïÑÏõêÏùò ÎÅùÏù¥Îã§. Ï†Ä ÎÑàÎ®∏ÏóêÎäî ÎÑìÏùÄ ÏÑ∏ÏÉÅÏù¥ ÏûàÍ≤†ÏßÄ...)'},
        {choice:[
          {text:'ÏÑ∏ÏÉÅÏùÑ Î≥¥Îü¨ Îñ†ÎÇòÎ≥ºÍπå',flag:'leftEarly',hope:5,chapter:2,scene:'ch2_savanna',playerX:80},
          {text:'Ï°∞Í∏à Îçî Ïó¨Í∏∞ ÏûàÏùÑÍπå',next:[
            {speaker:'ÎÖ∏Îì†',text:'(ÏïÑÏßÅÏùÄ... Ï°∞Í∏à Îçî Ïù¥Í≥≥Ïóê ÏûàÍ≥† Ïã∂Îã§.)'},
            {action:()=>{GS.px=700;GS.transitioning=false;const p=$('player');if(p)p.style.left='700px';}}
          ]}
        ]}
      ]}
    ]
  },

  // --- CHAPTER 2: Savanna ---
  ch2_savanna:{
    bg:'linear-gradient(180deg,#080818 0%,#0a0a20 30%,#1a1828 60%,#2a2820 100%)',
    ground:{height:'80px',bg:'linear-gradient(180deg,#3a4a20,#2a3a18)'},
    stars:60,
    grassCount:35,
    music:'savanna',
    bounds:{left:20,right:1000},
    decorations:[
      {style:'left:200px;bottom:80px;width:4px;height:100px;background:#4a3a20;',html:'<div style="position:absolute;top:-20px;left:-20px;width:44px;height:30px;background:radial-gradient(ellipse,#3a5a20,transparent);border-radius:50%;"></div>'},
      {style:'left:700px;bottom:80px;width:4px;height:80px;background:#4a3a20;',html:'<div style="position:absolute;top:-15px;left:-15px;width:34px;height:25px;background:radial-gradient(ellipse,#3a5a20,transparent);border-radius:50%;"></div>'}
    ],
    npcs:[
      {id:'rhino_family',name:'ÏΩîÎøîÏÜå Í∞ÄÏ°±',x:500,
       sprite:'<div style="width:80px;height:40px;position:relative;pointer-events:none;"><div style="position:absolute;width:40px;height:26px;background:linear-gradient(135deg,#7a7a7a,#5a5a5a);border-radius:18px 15px 6px 6px;bottom:8px;left:0;"></div><div style="position:absolute;width:35px;height:22px;background:linear-gradient(135deg,#8a8a8a,#6a6a6a);border-radius:15px 12px 5px 5px;bottom:8px;left:40px;"></div><div style="position:absolute;width:5px;height:10px;background:#c0b090;border-radius:3px;bottom:28px;left:60px;"></div></div>',
       dialogue:()=>{
         if(GS.flags.metFamily) return [
           {speaker:'ÏΩîÎøîÏÜå Í∞ÄÏ°±',text:'ÎÖ∏Îì†, Ìï®ÍªòÎùºÏÑú Ï¢ãÍµ¨ÎÇò. Ïò§Îäò Î∞§ Î≥ÑÏù¥ Ï∞∏ ÎßéÎã§.'},
           {speaker:'ÎÖ∏Îì†',text:'ÎÑ§... Í∞ÄÏ°±Ïù¥ ÏûàÎã§Îäî Í≤å Ïù¥Îü∞ Í±∞Íµ∞Ïöî.'}
         ];
         GS.flags.metFamily=true;
         return [
           {speaker:'???',text:'Ïñ¥Îùº? ÎÑà... ÌòπÏãú ÏΩîÎøîÏÜåÎãà?'},
           {speaker:'ÎÖ∏Îì†',text:'ÎÑ§! Ï†Ä... ÏΩîÎøîÏÜåÏòàÏöî. Ï≤òÏùå ÎßåÎÇòÏöî, Í∞ôÏùÄ ÏΩîÎøîÏÜåÎ•º.'},
           {speaker:'ÏΩîÎøîÏÜå',text:'ÏÑ∏ÏÉÅÏóê, Ïù¥Î†áÍ≤å Ïñ¥Î¶∞ ÏΩîÎøîÏÜåÍ∞Ä ÌòºÏûê ÎèåÏïÑÎã§ÎãàÎã§Îãà. Ïö∞Î¶¨ Í∞ÄÏ°±Í≥º Ìï®ÍªòÌïòÏßÄ ÏïäÏùÑÎûò?'},
           {speaker:'ÎÖ∏Îì†',text:'Ï†ïÎßêÏöî? Ï†ïÎßê... Í∞ôÏù¥ ÏûàÏñ¥ÎèÑ ÎèºÏöî?'},
           {speaker:'ÏΩîÎøîÏÜå',text:'Î¨ºÎ°†Ïù¥ÏßÄ. Ïó¨Í∏∞Í∞Ä ÎÑ§ ÏûêÎ¶¨Ïïº, ÎÖ∏Îì†.'},
           {action:()=>changeHope(15)},
           {speaker:'',text:'(ÎÖ∏Îì†ÏùÄ ÏÉùÏ†Ñ Ï≤òÏùåÏúºÎ°ú Í∞ÄÏ°±Ïù¥ÎùºÎäî Í±∏ ÏïåÍ≤å ÎêòÏóàÎã§.)'}
         ];
       }
      }
    ],
    groundItems:[
      {id:'horn_piece',name:'Í∞ÄÏ°±Ïùò ÎøîÏ°∞Í∞Å',icon:'ü¶è',desc:'Î∂ÄÏÑúÏßÑ ÎøîÏùò ÏûëÏùÄ Ï°∞Í∞Å. Í∞ÄÏ°±Ïùò Í∏∞Ïñµ.',x:620,
       condition:()=>GS.flags.poachersAppeared,
       dialogue:[{speaker:'ÎÖ∏Îì†',text:'(Ïù¥Í±¥... Ïù¥Í±¥ Í∞ÄÏ°±Ïùò...)'},
         {action:()=>changeHope(-10)}]
      }
    ],
    exits:[
      {x:950,type:'dialogue',
       condition:()=>GS.flags.metFamily,
       dialogue:[
         {speaker:'',text:'(ÌñâÎ≥µÌïú ÏãúÍ∞ÑÏù¥ ÌùêÎ•¥Í≥† ÏûàÏóàÎã§. Í∑∏Îü¨ÎÇò...)'},
         {action:()=>{
           GS.flags.poachersAppeared=true;
           $('vignette').classList.add('show');
           playSfx('sad');
         }},
         {speaker:'',text:'Ïñ¥Îë† ÏÜçÏóêÏÑú ÎÇ†Ïπ¥Î°úÏö¥ ÏÜåÎ¶¨Í∞Ä Îì§Î†∏Îã§.'},
         {speaker:'',text:'Î∞ÄÎ†µÍæºÎì§Ïù¥ÏóàÎã§.'},
         {speaker:'',text:'ÎÖ∏Îì†ÏùÄ ÎèÑÎßùÏ≥§Îã§. Îí§Î•º ÎèåÏïÑÎ≥º Ïàò ÏóÜÏóàÎã§.'},
         {speaker:'',text:'...'},
         {speaker:'',text:'Í∞ÄÏ°±ÏùÄ, Îçî Ïù¥ÏÉÅ ÏóÜÏóàÎã§.'},
         {action:()=>{
           changeHope(-20);
           $('vignette').classList.remove('show');
         }},
         {speaker:'ÎÖ∏Îì†',text:'(Ïôú... Ïôú ÎÇòÎßå ÏÇ¥ÏïÑÎÇ®ÏùÄ Í±∏Íπå...)'},
         {choice:[
           {text:'ÏïûÏúºÎ°ú ÎÇòÏïÑÍ∞ÑÎã§',chapter:3,scene:'ch3_zoo',playerX:100},
           {text:'(ÎßêÏóÜÏù¥ Í±∑ÎäîÎã§)',hope:-5,chapter:3,scene:'ch3_zoo',playerX:100}
         ]}
       ]
      }
    ]
  },

  // --- CHAPTER 3: Zoo ---
  ch3_zoo:{
    bg:'linear-gradient(180deg,#0a0a10 0%,#10101a 50%,#1a1a24 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#3a3a3a,#2a2a2a)'},
    music:'zoo',
    bounds:{left:30,right:850},
    decorations:[
      // Cage bars
      ...[0,1,2,3,4,5,6,7,8,9,10,11,12].map(i=>({
        style:`left:${60+i*70}px;bottom:70px;width:4px;height:200px;background:linear-gradient(180deg,#5a5a5a,#3a3a3a);border-radius:2px;opacity:0.5;`
      })),
      {style:'left:0;bottom:260px;width:100%;height:4px;background:#4a4a4a;opacity:0.5;'},
      {style:'left:50%;bottom:280px;font-size:12px;color:#5a5a5a;transform:translateX(-50%);white-space:nowrap;',html:'[ ÏãúÎ¶ΩÎèôÎ¨ºÏõê - Ìù∞Î∞îÏúÑÏΩîÎøîÏÜå ]'}
    ],
    npcs:[
      {id:'angabu',name:'ÏïôÍ∞ÄÎ∂Ä',x:550,
       sprite:'<div style="width:40px;height:35px;position:relative;pointer-events:none;"><div style="position:absolute;width:32px;height:24px;background:linear-gradient(135deg,#c08040,#a06830);border-radius:12px;bottom:8px;left:4px;"></div><div style="position:absolute;width:14px;height:12px;background:#b07030;border-radius:7px;bottom:24px;left:20px;"></div><div style="position:absolute;width:3px;height:3px;background:#222;border-radius:50%;bottom:28px;left:28px;"></div><div style="position:absolute;width:6px;height:8px;background:#a06830;border-radius:0 0 3px 3px;bottom:0;left:10px;"></div><div style="position:absolute;width:6px;height:8px;background:#a06830;border-radius:0 0 3px 3px;bottom:0;left:22px;"></div></div>',
       dialogue:()=>{
         if(GS.flags.metAngabu) return [
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'ÎÖ∏Îì†, Ïò§ÎäòÎèÑ ÌïòÎäòÏùÑ Î¥§Ïñ¥? Ï†Ä Ìãà ÏÇ¨Ïù¥Î°ú Î≥¥Ïù¥Îäî Î≥Ñ ÎßêÏù¥Ïïº.'},
           {speaker:'ÎÖ∏Îì†',text:'Ïùë... ÏûëÏùÄ Î≥ÑÏù∏Îç∞, Î≥º ÎïåÎßàÎã§ Ï°∞Í∏à ÏúÑÏïàÏù¥ Îèº.'},
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'Ïö∞Î¶¨ÎèÑ Ïñ∏Ï††Í∞Ä Ï†Ä Î≥Ñ ÏïÑÎûò ÏÑúÍ≤å Îê† Í±∞Ïïº. ÎØøÏñ¥.'}
         ];
         GS.flags.metAngabu=true;
         return [
           {speaker:'???',text:'Ïù¥Î¥ê, ÏÉàÎ°ú Ïò® Í±∞Ïïº? ÎÇòÎäî ÏïôÍ∞ÄÎ∂Ä. Ïó¨Í∏∞ ÏÇ∞ ÏßÄ Ï¢Ä ÎêêÏßÄ.'},
           {speaker:'ÎÖ∏Îì†',text:'...ÎÇòÎäî ÎÖ∏Îì†Ïù¥Ïïº.'},
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'Í∑∏Î†áÍ≤å Ïä¨Ìîà ÎààÏùÑ ÌïòÍ≥† ÏûàÍµ¨ÎÇò. Î¨¥Ïä® ÏùºÏù¥ ÏûàÏóàÏñ¥?'},
           {speaker:'ÎÖ∏Îì†',text:'Í∞ÄÏ°±ÏùÑ... ÏûÉÏóàÏñ¥.'},
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'...ÎÇòÎèÑ Í∑∏Îûò. Ïó¨Í∏∞ ÏûàÎäî Í±¥ Îã§ Í∑∏Îü∞ ÏÇ¨Ïó∞Ïù¥ ÏûàÏñ¥.'},
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'ÌïòÏßÄÎßå ÎßêÏù¥Ïïº, ÎÇòÎäî Ìè¨Í∏∞ÌïòÏßÄ ÏïäÏïÑ. Ïñ∏Ï††Í∞Ä Ïó¨Í∏∞ÏÑú ÎÇòÍ∞à Í±∞Ïïº.'},
           {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'Ïù¥Í±∞ Î∞õÏïÑ. ÎÇ¥Í∞Ä ÏïÑÎÅºÎäî Í±¥Îç∞... ÎÑàÌïúÌÖå Ï§ÑÍ≤å.'},
           {action:()=>addItem({id:'angabu_gift',name:'ÏïôÍ∞ÄÎ∂ÄÏùò ÏÑ†Î¨º',icon:'üå∞',desc:'ÏïôÍ∞ÄÎ∂ÄÍ∞Ä ÏÜåÏ§ëÌûà Í∞ÑÏßÅÌïòÎçò ÏûëÏùÄ ÎèÑÌÜ†Î¶¨'})},
           {speaker:'ÎÖ∏Îì†',text:'...Í≥†ÎßàÏõå, ÏïôÍ∞ÄÎ∂Ä.'},
           {action:()=>changeHope(10)}
         ];
       }
      }
    ],
    exits:[
      {x:830,type:'dialogue',
       condition:()=>GS.flags.metAngabu&&!GS.flags.angabuDied,
       dialogue:[
         {speaker:'',text:'(Ïñ¥Îäê ÎÇ† Î∞§, ÎèôÎ¨ºÏõêÏóê ÎÇØÏÑ† ÏÇ¨ÎûåÎì§Ïù¥ Îì§Ïñ¥ÏôîÎã§.)'},
         {speaker:'',text:'(Í∑∏Îì§Ïùò ÎààÏùÄ Ïñ¥Îë† ÏÜçÏóêÏÑúÎèÑ Ï∞®Í∞ëÍ≤å ÎπõÎÇ¨Îã§. ÎøîÏùÑ ÎÖ∏Î¶¨Îäî ÏÇ¨ÎÉ•ÍæºÎì§Ïù¥ÏóàÎã§.)'},
         {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'ÎÖ∏Îì†, Ïà®Ïñ¥! Ï†Ä ÏÇ¨ÎûåÎì§ÏùÄ ÏúÑÌóòÌï¥!'},
         {speaker:'ÎÖ∏Îì†',text:'ÏïôÍ∞ÄÎ∂Ä, ÎÑàÎèÑ Îπ®Î¶¨!'},
         {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'ÎÇòÎäî Í¥úÏ∞ÆÏïÑ. ÎÇòÎäî ÎøîÏù¥ ÏóÜÏúºÎãàÍπå. Îπ®Î¶¨ Ïà®Ïñ¥, ÎÖ∏Îì†!'},
         {speaker:'',text:'(ÏïôÍ∞ÄÎ∂ÄÎäî ÎÖ∏Îì†ÏùÑ Í∞êÏ∂îÎ†§Í≥† ÏÇ¨ÎÉ•ÍæºÎì§ ÏïûÏùÑ Í∞ÄÎ°úÎßâÏïòÎã§.)'},
         {speaker:'',text:'(Ï¥ùÏÜåÎ¶¨Í∞Ä Î∞§ÏùÑ Ï∞¢ÏóàÎã§.)'},
         {action:()=>{playSfx('sad');setSadVignette(true);}},
         {speaker:'ÎÖ∏Îì†',text:'ÏïôÍ∞ÄÎ∂Ä...!! Ïïà Îèº!!'},
         {speaker:'',text:'(ÏïôÍ∞ÄÎ∂ÄÎäî Ïì∞Îü¨ÏßÄÎ©¥ÏÑúÎèÑ ÎÖ∏Îì†ÏùÑ Ìñ•Ìï¥ Í≥†Í∞úÎ•º ÎèåÎ†∏Îã§.)'},
         {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'...ÎèÑÎßùÍ∞Ä, ÎÖ∏Îì†. ÏÇ¥ÏïÑÏïº Ìï¥.'},
         {speaker:'ÏïôÍ∞ÄÎ∂Ä',text:'Ï†Ä Î≥Ñ... Í∏∞ÏñµÌïòÏßÄ? Í±∞Í∏∞ÏÑú... Î≥ºÍ≤å.'},
         {speaker:'',text:'(ÏïôÍ∞ÄÎ∂ÄÏùò ÎààÏù¥ Ï≤úÏ≤úÌûà Í∞êÍ≤ºÎã§.)'},
         {action:()=>{GS.flags.angabuDied=true;changeHope(-20);}},
         {speaker:'ÎÖ∏Îì†',text:'ÏïôÍ∞ÄÎ∂Ä... ÏïôÍ∞ÄÎ∂Ä...!'},
         {speaker:'',text:'(ÎÖ∏Îì†ÏùÄ Ïù¥Î•º ÏïÖÎ¨ºÏóàÎã§. Îòê ÏûÉÏóàÎã§. Îòê.)'},
         {speaker:'',text:'(ÌïòÏßÄÎßå ÏïôÍ∞ÄÎ∂ÄÏùò ÎßàÏßÄÎßâ ÎßêÏù¥ Í∑ìÍ∞ÄÏóê Îß¥ÎèåÏïòÎã§. "ÏÇ¥ÏïÑÏïº Ìï¥.")'},
         {speaker:'ÎÖ∏Îì†',text:'...ÏÇ¥ÏïÑÏïº Ìï¥. ÏÇ¥ Í±∞Ïïº.'},
         {action:()=>setSadVignette(false)}
       ]
      },
      {x:830,type:'chapter',chapter:4,target:'ch4_escape',playerX:80,
       condition:()=>GS.flags.angabuDied}
    ]
  },

  // --- CHAPTER 4: Escape ---
  ch4_escape:{
    bg:'linear-gradient(180deg,#1a0808 0%,#2a1010 40%,#3a1808 70%,#4a2010 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#3a2a20,#2a1a10)'},
    music:'escape',
    bounds:{left:20,right:900},
    decorations:[
      // Fire/smoke effects
      ...[0,1,2,3,4].map(i=>({
        style:`left:${100+i*180}px;bottom:70px;width:40px;height:60px;background:radial-gradient(ellipse at bottom,rgba(200,80,20,0.4),transparent);border-radius:50%;animation:sway ${1+Math.random()}s infinite alternate;`
      })),
      // Broken bars
      ...[0,1,2].map(i=>({
        style:`left:${200+i*120}px;bottom:70px;width:4px;height:80px;background:#4a4a4a;transform:rotate(${-15+i*12}deg);opacity:0.4;`
      })),
      {style:'left:50%;top:30px;font-size:14px;color:#c04030;transform:translateX(-50%);white-space:nowrap;animation:blink 0.5s infinite;',html:'Ìè≠Î∞úÏùåÍ≥º ÎπÑÎ™ÖÏù¥ Ïö∏Î†§ ÌçºÏßÑÎã§'}
    ],
    npcs:[
      {id:'chiku_escape',name:'ÏπòÏø†',x:500,
       condition:()=>!GS.flags.metChiku,
       sprite:'<div style="width:18px;height:22px;position:relative;pointer-events:none;"><div style="position:absolute;bottom:0;left:3px;width:12px;height:16px;background:radial-gradient(ellipse,#1a1a2a,#0a0a15);border-radius:40% 40% 35% 35%;"></div><div style="position:absolute;bottom:1px;left:5px;width:8px;height:10px;background:radial-gradient(ellipse,#f0f0e8,#d8d8d0);border-radius:40% 40% 35% 35%;"></div><div style="position:absolute;top:0;left:3px;width:10px;height:10px;background:radial-gradient(ellipse,#1a1a2a,#0a0a15);border-radius:50%;"></div><div style="position:absolute;top:3px;right:4px;width:2px;height:2px;background:#fff;border-radius:50%;"></div><div style="position:absolute;top:5px;right:1px;width:4px;height:2px;background:#d4a040;clip-path:polygon(0 0,100% 50%,0 100%);"></div><div style="position:absolute;bottom:2px;left:-6px;width:8px;height:10px;background:radial-gradient(ellipse,#f5f0e0,#e0d8c0);border-radius:45% 45% 50% 50%;box-shadow:0 0 4px rgba(255,250,220,.2);"></div></div>',
       dialogue:()=>[
         {speaker:'',text:'(Ïó∞Í∏∞ÏôÄ ÎπÑÎ™Ö ÏÜçÏóêÏÑú, ÏûëÏùÄ Í∑∏Î¶ºÏûêÍ∞Ä Îñ®Í≥† ÏûàÏóàÎã§.)'},
         {speaker:'',text:'(Ïïå ÌïòÎÇòÎ•º Íº≠ ÏïàÏùÄ Ï±Ñ, Í∞à Í≥≥ÏùÑ ÏûÉÏùÄ ÏûëÏùÄ Ìé≠Í∑Ñ.)'},
         {speaker:'ÎÖ∏Îì†',text:'...Í±∞Í∏∞ Í¥úÏ∞ÆÏïÑ? ÏúÑÌóòÌï¥, Îπ®Î¶¨ ÎÇòÍ∞ÄÏïº Ìï¥!'},
         {speaker:'???',text:'...ÏïåÏù¥... ÏïåÏùÑ ÏßÄÏºúÏïº Ìï¥... Ïù¥ ÏïÑÏù¥Î•º...'},
         {speaker:'ÎÖ∏Îì†',text:'Ïïå? ÎÑ§ ÏïÑÏù¥Ïïº?'},
         {speaker:'???',text:'ÎÇòÎäî ÏπòÏø†... Ïù¥Í±¥ ÎÇ¥ ÏïÑÏù¥Ïùò ÏïåÏù¥Ïïº. Ï†úÎ∞ú... ÎèÑÏôÄÏ§ò.'},
         {choice:[
           {text:'ÏπòÏø†ÏôÄ ÏïåÏùÑ ÏßÄÌÇ§Î©∞ Ìï®Íªò Îã¨Î¶∞Îã§',flag:'metChiku',hope:10,next:[
             {speaker:'ÎÖ∏Îì†',text:'ÎÇ¥ Îí§Ïóê Î∂ôÏñ¥. ÎÇ¥Í∞Ä Í∏∏ÏùÑ Ïó¥Í≤å.'},
             {speaker:'ÏπòÏø†',text:'...Í≥†ÎßàÏõå.'},
             {speaker:'',text:'(ÎÖ∏Îì†ÏùÄ Ïª§Îã§ÎûÄ Î™∏ÏúºÎ°ú Ïó∞Í∏∞ÏôÄ Î∂àÏùÑ Ìó§ÏπòÎ©∞ Îã¨Î†∏Îã§.\nÏûëÏùÄ ÏπòÏø†Îäî ÏïåÏùÑ ÏïàÍ≥† ÎÖ∏Îì†Ïùò Í∑∏Î¶ºÏûê ÏÜçÏóêÏÑú Îî∞ÎùºÏôîÎã§.)'},
             {speaker:'ÏπòÏø†',text:'Ïù¥Ï™ΩÏóê ÎπõÏù¥ Î≥¥Ïó¨! Ï∂úÍµ¨Ïïº!'},
             {action:()=>{activateCompanion();playSfx('hope');}},
             {speaker:'',text:'(ÏπòÏø†Í∞Ä ÎèôÎ∞òÏûêÎ°ú Ìï®ÍªòÌïòÍ≤å ÎêòÏóàÎã§.)'}
           ]},
           {text:'ÏïåÏùÑ ÎåÄÏã† Îì§Ïñ¥Ï§ÄÎã§',flag:'metChiku',hope:15,next:[
             {speaker:'ÎÖ∏Îì†',text:'ÎÇ¥Í∞Ä ÏïåÏùÑ Îì§Í≤å. ÎÑå ÎÇ¥ Îí§ÏóêÏÑú Îî∞ÎùºÏôÄ.'},
             {speaker:'ÏπòÏø†',text:'...Ï†ïÎßê? Ï°∞Ïã¨Ìï¥ÏÑú... Îî∞ÎúªÌïòÍ≤å Ìï¥Ï§òÏïº Ìï¥.'},
             {speaker:'',text:'(ÎÖ∏Îì†ÏùÄ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å ÏïåÏùÑ Îøî ÏÇ¨Ïù¥Ïóê Ïò¨Î†§ÎÜìÏïòÎã§.)'},
             {speaker:'ÏπòÏø†',text:'...Ïª§Îã§ÎûÄ ÏΩîÎøîÏÜåÍ∞Ä Ìé≠Í∑Ñ ÏïåÏùÑ ÌíàÎã§Îãà. Ïù¥ÏÉÅÌïú Î∞§Ïù¥Ïïº.'},
             {speaker:'ÎÖ∏Îì†',text:'ÏßÄÍ∏àÏùÄ Ïù¥ÏÉÅÌïú Í≤å ÎãπÏó∞Ìïú Î∞§Ïù¥ÎãàÍπå.'},
             {action:()=>{activateCompanion();playSfx('hope');}},
             {speaker:'',text:'(ÏπòÏø†Í∞Ä ÎèôÎ∞òÏûêÎ°ú Ìï®ÍªòÌïòÍ≤å ÎêòÏóàÎã§.)'}
           ]}
         ]}
       ]
      }
    ],
    exits:[
      {x:880,type:'chapter',chapter:5,target:'ch5_forest',playerX:80,
       condition:()=>GS.flags.metChiku}
    ]
  },

  // --- CHAPTER 5: Forest - Resting with Chiku ---
  ch5_forest:{
    bg:'linear-gradient(180deg,#080810 0%,#101018 40%,#181820 70%,#1a1a22 100%)',
    ground:{height:'80px',bg:'linear-gradient(180deg,#1a2a18,#142014)'},
    rain:true,
    grassCount:25,
    grassColor:'linear-gradient(to top,#1a2a18,#2a3a22)',
    music:'forest',
    bounds:{left:20,right:900},
    decorations:[
      // Dark trees
      ...[0,1,2,3].map(i=>({
        style:`left:${80+i*220}px;bottom:80px;width:8px;height:140px;background:#1a1a14;`,
        html:`<div style="position:absolute;top:-30px;left:-30px;width:68px;height:50px;background:radial-gradient(ellipse,#1a2a14,transparent);border-radius:50%;"></div>`
      }))
    ],
    npcs:[
      {id:'chiku_rest',name:'ÏπòÏø†',x:450,
       condition:()=>!GS.flags.forestTalk,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'',text:'(ÎπÑÍ∞Ä ÎÇ¥Î¶¨Îäî Ïà≤ÏóêÏÑú ÎëòÏùÄ Ïû†Ïãú Ïâ¨Í∏∞Î°ú ÌñàÎã§.)'},
         {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†... ÏïÑÍπåÎäî Ï†ïÎßê Î¨¥ÏÑúÏõ†Ïñ¥. Í≥†ÎßàÏõå, ÏßÄÏºúÏ§òÏÑú.'},
         {speaker:'ÎÖ∏Îì†',text:'...ÎÇòÎèÑ Î¨¥ÏÑúÏõ†Ïñ¥. ÌïòÏßÄÎßå ÌòºÏûêÍ∞Ä ÏïÑÎãàÏñ¥ÏÑú Îã¨Î¶¥ Ïàò ÏûàÏóàÏñ¥.'},
         {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†ÏùÄ Ïôú Í∑∏Í≥≥Ïóê ÏûàÏóàÏñ¥? ÎèôÎ¨ºÏõêÏóê.'},
         {speaker:'ÎÖ∏Îì†',text:'Í∞ÄÏ°±ÏùÑ ÏûÉÍ≥†... Ïû°ÌòÄÏôîÏñ¥. Í±∞Í∏∞ÏÑú ÏïôÍ∞ÄÎ∂ÄÎùºÎäî ÏπúÍµ¨Î•º ÎßåÎÇ¨ÎäîÎç∞...'},
         {speaker:'ÎÖ∏Îì†',text:'Í∑∏ ÏπúÍµ¨ÎèÑ... ÎÇòÎ•º ÏßÄÌÇ§Î†§Îã§ ÏÇ¨ÎÉ•ÍæºÏóêÍ≤å...'},
         {speaker:'ÏπòÏø†',text:'...'},
         {speaker:'ÎÖ∏Îì†',text:'ÏûêÍæ∏ ÏûÉÍ∏∞Îßå Ìï¥. ÏÜåÏ§ëÌïú Í≤ÉÎì§ÏùÑ.'},
         {speaker:'ÏπòÏø†',text:'ÎÇòÎèÑ Í∑∏Îûò. Ïù¥ ÏïåÏùò ÏïÑÎπ†ÎèÑ... Ïù¥ÎØ∏ ÏóÜÏñ¥.'},
         {speaker:'ÏπòÏø†',text:'ÌïòÏßÄÎßå Ïù¥ ÏïÑÏù¥ÎßåÏùÄ ÏßÄÌÇ§Í≥† Ïã∂Ïñ¥. Î∞îÎã§ÏóêÏÑú ÌÇ§ÏõåÏïº Ìï¥. Ìé≠Í∑ÑÏùÄ Î∞îÎã§ÏóêÏÑú ÏÇ¥ÏïÑÏïº ÌïòÎãàÍπå.'},
         {speaker:'ÎÖ∏Îì†',text:'Î∞îÎã§... ÎÇòÎèÑ Î∞îÎã§Î•º Î≥¥Í≥† Ïã∂Ïñ¥. Ìïú Î≤àÎèÑ Î≥∏ Ï†Å ÏóÜÍ±∞Îì†.'},
         {speaker:'ÏπòÏø†',text:'Í∑∏Îüº... Í∞ôÏù¥ Í∞ÄÏûê, Î∞îÎã§ÍπåÏßÄ.'},
         {speaker:'ÎÖ∏Îì†',text:'...Í∑∏Îûò. Í∞ôÏù¥ Í∞ÄÏûê, ÏπòÏø†.'},
         {action:()=>{GS.flags.forestTalk=true;changeHope(10);}}
       ]
      },
      {id:'chiku_after2',name:'ÏπòÏø†',x:450,
       condition:()=>GS.flags.forestTalk,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ÏπòÏø†',text:'ÎπÑÍ∞Ä Ï¢Ä ÏïΩÌï¥ÏßÑ Í≤É Í∞ôÏïÑ. Ïä¨Ïä¨ Í∞àÍπå?'},
         {speaker:'ÎÖ∏Îì†',text:'Ïùë. ÎèôÏ™ΩÏúºÎ°ú Í∞ÄÎ©¥ Î∞îÎã§Í∞Ä ÏûàÏùÑ Í±∞Ïïº.'},
         {speaker:'ÏπòÏø†',text:'ÏïåÎèÑ Îî∞ÎúªÌï¥. Ïù¥ ÏïÑÏù¥ÎèÑ Ï§ÄÎπÑÎêú Í≤É Í∞ôÏïÑ.'},
         {action:()=>changeHope(5)}
       ]
      }
    ],
    exits:[
      {x:880,type:'chapter',chapter:6,target:'ch6_journey',playerX:80,
       condition:()=>GS.flags.forestTalk}
    ]
  },

  // --- CHAPTER 6: Journey ---
  ch6_journey:{
    bg:'linear-gradient(180deg,#060610 0%,#08081a 50%,#0a0a1e 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#2a2828,#1a1818)'},
    stars:80,
    grassCount:15,
    music:'journey',
    bounds:{left:20,right:1200},
    decorations:[
      {style:'left:50%;top:20%;width:60px;height:60px;background:radial-gradient(circle,rgba(255,255,200,0.15),transparent);border-radius:50%;'},
    ],
    npcs:[
      {id:'owl',name:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',x:450,
       sprite:'<div style="width:28px;height:32px;position:relative;pointer-events:none;"><div style="position:absolute;width:24px;height:22px;background:linear-gradient(135deg,#5a4a30,#4a3a20);border-radius:12px;bottom:6px;left:2px;"></div><div style="position:absolute;width:16px;height:10px;background:#6a5a38;border-radius:50% 50% 0 0;bottom:22px;left:6px;"></div><div style="position:absolute;width:5px;height:5px;background:#ff0;border-radius:50%;bottom:22px;left:8px;"></div><div style="position:absolute;width:5px;height:5px;background:#ff0;border-radius:50%;bottom:22px;left:16px;"></div><div style="position:absolute;width:4px;height:3px;background:#c08020;border-radius:0 0 2px 2px;bottom:20px;left:12px;"></div></div>',
       dialogue:()=>[
         {speaker:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',text:'Ìò∏Ïò§... Ïù¥ Î∞§Ïóê Ïó¨ÌñâÏûêÎùºÎãà. Ïñ¥ÎîîÎ°ú Í∞ÄÎäî Í≤åÎÉê?'},
         {speaker:'ÎÖ∏Îì†',text:'Î∞îÎã§Î•º Ï∞æÍ≥† ÏûàÏñ¥Ïöî.'},
         {speaker:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',text:'Î∞îÎã§Îùº... Ïó¨Í∏∞ÏÑú ÍΩ§ Î©ÄÏßÄ. Îëê Í∞àÎûò Í∏∏Ïù¥ ÏûàÎã®Îã§.'},
         {speaker:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',text:'ÏÇ∞Í∏∏ÏùÄ ÌóòÌïòÏßÄÎßå Í∞ÄÍπåÏõå. Í∞ïÎ≥ÄÍ∏∏ÏùÄ Ìé∏ÌïòÏßÄÎßå ÎèåÏïÑÍ∞ÄÏïº ÌïòÏßÄ.'},
         {choice:[
           {text:'ÏÇ∞Í∏∏Î°ú Í∞ÑÎã§',flag:'mountainPath',hope:5,next:[
             {speaker:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',text:'Ïö©Í∞êÌïú ÏÑ†ÌÉùÏù¥Íµ¨ÎÇò. ÏÇ∞ÏóêÏÑúÎäî Î≥ÑÏù¥ Îçî Í∞ÄÍπåÏù¥ Î≥¥Ïù∏Îã®Îã§.'},
             {action:()=>addItem({id:'star_piece',name:'Ìù¨ÎßùÏùò Î≥Ñ Ï°∞Í∞Å',icon:'‚≠ê',desc:'Î∂ÄÏóâÏù¥Í∞Ä ÏïåÎ†§Ï§Ä ÏÇ∞ Ï†ïÏÉÅÏóêÏÑú Ï£ºÏö¥ ÎπõÎÇòÎäî Îèå'})}
           ]},
           {text:'Í∞ïÎ≥ÄÍ∏∏Î°ú Í∞ÑÎã§',flag:'riverPath',hope:0,next:[
             {speaker:'ÎäôÏùÄ Î∂ÄÏóâÏù¥',text:'ÌòÑÎ™ÖÌïú ÏÑ†ÌÉùÏù¥Ïïº. Í∞ïÎ¨º ÏÜåÎ¶¨Í∞Ä Ï¢ãÏùÄ ÏπúÍµ¨Í∞Ä ÎêòÏñ¥Ï§Ñ Í≤åÎã§.'},
             {action:()=>addItem({id:'star_piece',name:'Ìù¨ÎßùÏùò Î≥Ñ Ï°∞Í∞Å',icon:'‚≠ê',desc:'Í∞ïÎ¨ºÏóê ÎπÑÏπú Î≥ÑÎπõÏù¥ Íµ≥Ïñ¥ÏßÑ ÏïÑÎ¶ÑÎã§Ïö¥ Îèå'})}
           ]}
         ]}
       ]
      },
      {id:'chiku_journey',name:'ÏπòÏø†',x:200,
       condition:()=>GS.flags.mountainPath||GS.flags.riverPath,
       sprite:'<div class="chiku-sprite"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†, Î≥ÑÏù¥ Ï†ïÎßê ÎßéÎã§...'},
         {speaker:'ÎÖ∏Îì†',text:'Ïùë. Ïù¥Î†áÍ≤å ÎßéÏùÄ Î≥ÑÏùÄ Ï≤òÏùå Î¥ê.'},
         {speaker:'ÏπòÏø†',text:'Ïö∞Î¶¨Í∞Ä Í±∏Ïñ¥Ïò® Í∏∏ÎßåÌÅº Î≥ÑÏù¥ ÏûàÎäî Í≤É Í∞ôÏïÑ.'},
         {speaker:'ÎÖ∏Îì†',text:'...ÏπòÏø†, ÏïåÏùÄ Í¥úÏ∞ÆÏïÑ?'},
         {speaker:'ÏπòÏø†',text:'Ïùë, Îî∞ÎúªÌï¥. Ïù¥ ÏïÑÏù¥ÎèÑ Î≥ÑÏùÑ Î≥¥Í≥† ÏûàÏùÑÍπå?'},
         {speaker:'ÎÖ∏Îì†',text:'Î∂ÑÎ™Ö Î≥¥Í≥† ÏûàÏùÑ Í±∞Ïïº.'},
         {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†... Í≥†ÎßàÏõå. ÌòºÏûêÏòÄÏúºÎ©¥ Ïó¨Í∏∞ÍπåÏßÄ Î™ª ÏôîÏùÑ Í±∞Ïïº.'},
         {speaker:'ÎÖ∏Îì†',text:'ÎÇòÎèÑ Í∑∏Îûò, ÏπòÏø†.'},
         {action:()=>changeHope(10)}
       ]
      }
    ],
    exits:[
      {x:1150,type:'chapter',chapter:7,target:'ch7_farewell',playerX:80,
       condition:()=>GS.flags.mountainPath||GS.flags.riverPath}
    ]
  },

  // --- CHAPTER 7: Farewell ---
  ch7_farewell:{
    bg:'linear-gradient(180deg,#050508 0%,#080810 40%,#0a0a14 70%,#141420 100%)',
    ground:{height:'70px',bg:'linear-gradient(180deg,#2a2828,#1a1818)'},
    stars:50,
    music:'farewell',
    bounds:{left:20,right:800},
    decorations:[
      // Faint dawn on horizon
      {style:'left:0;bottom:70px;width:100%;height:40px;background:linear-gradient(180deg,transparent,rgba(60,40,60,0.15));pointer-events:none;'}
    ],
    npcs:[
      {id:'chiku_weak',name:'ÏπòÏø†',x:400,
       sprite:'<div class="chiku-sprite" style="opacity:0.85;"><div class="chiku-body"></div><div class="chiku-belly"></div><div class="chiku-egg"></div><div class="chiku-beak"></div><div class="chiku-eye l"></div><div class="chiku-eye r"></div><div class="chiku-foot l"></div><div class="chiku-foot r"></div></div>',
       dialogue:()=>{
         if(GS.flags.chikuFarewell) return [
           {speaker:'',text:'(ÏπòÏø†Îäî Ï°∞Ïö©Ìûà Ïû†Îì§Ïñ¥ ÏûàÎã§. ÏïåÏù¥ Ï°∞Í∏àÏî© ÏõÄÏßÅÏù¥Í≥† ÏûàÎã§.)'}
         ];
         GS.flags.chikuFarewell=true;
         return [
           {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†... Ïû†Íπê Ïâ¨Ïñ¥ÎèÑ Îê†Íπå. Ï¢Ä... ÌûòÎì§Ïñ¥.'},
           {speaker:'ÎÖ∏Îì†',text:'ÏπòÏø†? Í¥úÏ∞ÆÏïÑ? Ïñ¥Îîî ÏïÑÌåå?'},
           {speaker:'ÏπòÏø†',text:'ÏïÑÎãàÏïº... Í∑∏ÎÉ• Ï¢Ä ÌîºÍ≥§Ìïú Í≤ÉÎøêÏù¥Ïïº.'},
           {speaker:'',text:'(ÏπòÏø†Ïùò Ïà®ÏÜåÎ¶¨Í∞Ä Ï†êÏ†ê Í∞ÄÎäòÏñ¥Ï°åÎã§.)'},
           {action:()=>{$('vignette').classList.add('show');playSfx('sad');}},
           {speaker:'ÏπòÏø†',text:'ÎÖ∏Îì†, ÎÇ¥ Î∂ÄÌÉÅ ÌïòÎÇòÎßå Îì§Ïñ¥Ï§ÑÎûò?'},
           {speaker:'ÎÖ∏Îì†',text:'Î≠êÎì†ÏßÄ. Î≠êÎì†ÏßÄ Îì§Ïñ¥Ï§ÑÍ≤å.'},
           {speaker:'ÏπòÏø†',text:'Ïù¥ ÏïÑÏù¥Î•º... Î∞îÎã§Ïóê Îç∞Î†§Îã§Ï§ò. Ìé≠Í∑ÑÏùÄ Î∞îÎã§ÏóêÏÑú ÏÇ¥ÏïÑÏïº ÌïòÎãàÍπå.'},
           {speaker:'ÎÖ∏Îì†',text:'Î¨¥Ïä® ÏÜåÎ¶¨Ïïº! Í∞ôÏù¥ Í∞ÄÏûêÍ≥† ÌñàÏûñÏïÑ! Í∞ôÏù¥!'},
           {speaker:'ÏπòÏø†',text:'...ÎÇòÎäî Ï∂©Î∂ÑÌûà ÌñâÎ≥µÌñàÏñ¥, ÎÖ∏Îì†. Ï†ïÎßêÏù¥Ïïº.'},
           {speaker:'ÏπòÏø†',text:'ÌòºÏûêÏòÄÎçò Î∞§Îì§Ïù¥ ÎÑàÎ•º ÎßåÎÇòÍ≥† ÎÇòÏÑú... Îî∞ÎúªÌñàÏñ¥.'},
           {speaker:'ÏπòÏø†',text:'Ïù¥ ÏïÑÏù¥ÏóêÍ≤å... Î∞îÎã§Î•º Î≥¥Ïó¨Ï§ò.'},
           {speaker:'ÎÖ∏Îì†',text:'ÏπòÏø†... ÏπòÏø†...!'},
           {speaker:'',text:'(ÏπòÏø†Îäî ÎØ∏ÏÜåÎ•º ÏßÄÏúºÎ©∞ Ï°∞Ïö©Ìûà ÎààÏùÑ Í∞êÏïòÎã§.)'},
           {action:()=>{changeHope(-15);}},
           {speaker:'',text:'...'},
           {speaker:'',text:'Í∑∏Î¶¨Í≥†, ÏïåÏù¥ ÏõÄÏßÅÏù¥Í∏∞ ÏãúÏûëÌñàÎã§.'},
           {speaker:'',text:'ÌÜ°. ÌÜ°ÌÜ°.'},
           {speaker:'',text:'ÏûëÍ≥† Î≥¥ÏÜ°Î≥¥ÏÜ°Ìïú ÏÉàÎÅº Ìé≠Í∑ÑÏù¥ ÏÑ∏ÏÉÅÏóê ÎÇòÏôîÎã§.'},
           {action:()=>{
             GS.companion=null;
             GS.babyPenguin=true;
             GS.flags.chikuNoEgg=true;
             changeHope(20);
             playSfx('hope');
             $('vignette').classList.remove('show');
             buildScene('ch7_farewell');
           }},
           {speaker:'',text:'(ÏÉàÎÅº Ìé≠Í∑ÑÏù¥ ÎÖ∏Îì†ÏùÑ Ïò¨Î†§Îã§Î≥¥Î©∞ ÏÜåÎ¶¨Î•º ÎÉàÎã§.)'},
           {speaker:'ÏÉàÎÅº Ìé≠Í∑Ñ',text:'ÏÇêÏïΩ...'},
           {speaker:'ÎÖ∏Îì†',text:'...ÏïàÎÖï. ÏïàÎÖï, ÏûëÏùÄ ÏïÑÏù¥. ÎÇ¥Í∞Ä ÎÑê Î∞îÎã§Î°ú Îç∞Î†§Í∞àÍ≤å. ÏïΩÏÜçÌï†Í≤å.'}
         ];
       }
      }
    ],
    exits:[
      {x:780,type:'chapter',chapter:8,target:'ch8_sea',playerX:80,
       condition:()=>GS.flags.chikuFarewell}
    ]
  },

  // --- CHAPTER 8: To the Sea ---
  ch8_sea:{
    bg:'linear-gradient(180deg,#1a2040 0%,#2a3060 20%,#4a5080 40%,#8090b0 60%,#c0b0a0 80%,#e0c890 100%)',
    ground:{height:'60px',bg:'linear-gradient(180deg,#c0b090,#a09070)'},
    music:'sea',
    bounds:{left:20,right:900},
    decorations:[
      // Sun
      {style:'right:100px;top:60px;width:80px;height:80px;background:radial-gradient(circle,rgba(255,220,150,0.8),rgba(255,180,100,0.3),transparent);border-radius:50%;'},
      // Waves
      ...[0,1,2,3,4,5].map(i=>({
        style:`left:${i*180}px;bottom:55px;width:160px;height:12px;background:rgba(80,120,180,0.3);border-radius:50%;animation:sway ${2+i*0.3}s infinite alternate;`
      })),
      // Sea
      {style:'left:0;bottom:0;width:100%;height:58px;background:linear-gradient(180deg,rgba(60,100,160,0.5),rgba(40,80,140,0.6));'}
    ],
    npcs:[
      {id:'baby_sea',name:'ÏÉàÎÅº Ìé≠Í∑Ñ',x:500,
       condition:()=>!GS.flags.finalChoice,
       sprite:'<div class="baby-sprite"><div class="baby-body"></div><div class="baby-belly"></div><div class="baby-fluff"></div><div class="baby-beak"></div><div class="baby-eye l"></div><div class="baby-eye r"></div><div class="baby-foot l"></div><div class="baby-foot r"></div></div>',
       dialogue:()=>[
         {speaker:'ÏÉàÎÅº Ìé≠Í∑Ñ',text:'ÏÇêÏïΩÏÇêÏïΩ!'},
         {speaker:'',text:'(ÏÉàÎÅº Ìé≠Í∑ÑÏù¥ Ï≤òÏùåÏúºÎ°ú Î∞îÎã§Î•º Î≥¥ÏïòÎã§. ÏûëÏùÄ ÎÇ†Í∞úÎ•º ÌååÎã•Í±∞Î†∏Îã§.)'},
         {speaker:'ÎÖ∏Îì†',text:'Î¥ê... Ïù¥Í≤å Î∞îÎã§Ïïº. ÏπòÏø†Í∞Ä ÎÑàÏóêÍ≤å Î≥¥Ïó¨Ï£ºÍ≥† Ïã∂ÏóàÎçò Í≤É.'},
         {speaker:'ÏÉàÎÅº Ìé≠Í∑Ñ',text:'ÏÇêÏïΩ...?'},
         {speaker:'ÎÖ∏Îì†',text:'ÎÑàÏùò ÏóÑÎßàÎäî ÏïÑÏ£º Ïö©Í∞êÌïú Ìé≠Í∑ÑÏù¥ÏóàÏñ¥. ÎÑàÎ•º Ï†ïÎßê ÏÇ¨ÎûëÌñàÏñ¥.'},
         {speaker:'',text:'(Î∞îÎã§ ÏúÑÎ°ú ÏïÑÏπ® Ìï¥Í∞Ä Îñ†Ïò§Î•¥Í≥† ÏûàÏóàÎã§.)'},
         {speaker:'ÎÖ∏Îì†',text: ()=>{
           const itemCount=GS.items.length;
           if(itemCount>=4) return '(Ìíà ÏïàÏùò Ï°∞ÏïΩÎèåÏùÑ ÎßåÏ†∏Î≥∏Îã§. Î™®Îì† ÎßåÎÇ®Ïù¥ Îñ†Ïò§Î•∏Îã§...)';
           return '(Í∏¥Í∏¥Î∞§Ïù¥ ÎÅùÎÇòÍ≥† ÏûàÎã§. Ïù¥Ï†ú Ïñ¥ÎñªÍ≤å Ìï¥Ïïº Ìï†Íπå.)';
         }},
         {choice:[
           {text:'ÏûëÏùÄ Ìé≠Í∑ÑÏùÑ Î∞îÎã§Î°ú Î≥¥ÎÇ¥Ï§ÄÎã§',flag:'finalChoice',flagValue:'release',action:()=>{
             GS.flags.finalChoice='release';
             const endType=GS.items.length>=4?'memory':'hope';
             showCutscene([
               'ÏûëÏùÄ Ìé≠Í∑ÑÏù¥ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å ÌååÎèÑÏóê Î∞úÏùÑ Îã¥Í∞îÎã§.',
               'Ï≤òÏùåÏóêÎäî Î¨¥ÏÑúÏõ†ÏßÄÎßå, Í≥ß Î¨ºÏÇ¥ÏùÑ ÌÉÄÍ∏∞ ÏãúÏûëÌñàÎã§.',
               'ÎèåÏïÑÎ≥¥Îäî ÏûëÏùÄ ÎààÎèôÏûêÏóê Î∞îÎã§Í∞Ä Í∞ÄÎìù Îã¥Í≤® ÏûàÏóàÎã§.',
               'ÎÖ∏Îì†ÏùÄ ÏõÉÏóàÎã§. Ïò§ÎûúÎßåÏóê, ÏßÑÏã¨ÏúºÎ°ú.',
               'Í∏¥Í∏¥Î∞§Ïù¥ ÎÅùÎÇòÍ≥† ÏïÑÏπ®Ïù¥ ÏôîÎã§.'
             ],()=>showEnding(endType));
           }},
           {text:'Ìï®Íªò Î∞îÎã∑Í∞ÄÏóê ÎÇ®ÎäîÎã§',flag:'finalChoice',flagValue:'stay',action:()=>{
             GS.flags.finalChoice='stay';
             showCutscene([
               'ÎÖ∏Îì†ÏùÄ Î∞îÎã∑Í∞ÄÏóê ÏûêÎ¶¨Î•º Ïû°ÏïòÎã§.',
               'ÏûëÏùÄ Ìé≠Í∑ÑÏùÄ Îß§Ïùº Î∞îÎã§ÏóêÏÑú ÎÜÄÎã§Í∞Ä ÎÖ∏Îì†ÏóêÍ≤å ÎèåÏïÑÏôîÎã§.',
               'ÌòºÏûêÍ∞Ä ÏïÑÎãå ÏïÑÏπ®ÏùÄ Ïù¥Î†áÍ≤åÎÇò Îî∞ÎúªÌñàÎã§.',
               'ÌååÎèÑ ÏÜåÎ¶¨Í∞Ä Îëê ÏπúÍµ¨Ïùò ÎÖ∏ÎûòÍ∞Ä ÎêòÏóàÎã§.',
               'Í∏¥Í∏¥Î∞§Ïù¥ ÎÅùÎÇòÍ≥†, Îî∞ÎúªÌïú ÏïÑÏπ®Ïù¥ ÏãúÏûëÎêòÏóàÎã§.'
             ],()=>showEnding('together'));
           }}
         ]}
       ]
      }
    ],
    exits:[]
  }
};

// ===== INPUT =====
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') GS.moving.left=true;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') GS.moving.right=true;
  if(e.key===' '||e.key==='Enter'){
    e.preventDefault();
    if(GS.dialogueActive) advanceDialogue();
    else {
      // Try interact with nearest NPC
      const npcs=document.querySelectorAll('.npc');
      let closest=null, minDist=80;
      npcs.forEach(n=>{
        const d=Math.abs(GS.px-parseFloat(n.style.left));
        if(d<minDist){minDist=d;closest=n;}
      });
      if(closest) closest.click();
    }
  }
  if(e.key==='i'||e.key==='I') toggleInventory();
});
document.addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') GS.moving.left=false;
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') GS.moving.right=false;
});

// Dialogue box click
$('dialogue-box').addEventListener('click',e=>{
  e.stopPropagation();
  if(GS.dialogueActive) advanceDialogue();
});

// Mobile controls
document.querySelectorAll('.dpad-btn').forEach(btn=>{
  const dir=btn.dataset.dir;
  btn.addEventListener('touchstart',e=>{e.preventDefault();GS.moving[dir]=true;});
  btn.addEventListener('touchend',e=>{e.preventDefault();GS.moving[dir]=false;});
  btn.addEventListener('mousedown',()=>GS.moving[dir]=true);
  btn.addEventListener('mouseup',()=>GS.moving[dir]=false);
});
$('m-interact').addEventListener('click',()=>{
  if(GS.dialogueActive){ advanceDialogue(); return; }
  const npcs=document.querySelectorAll('.npc');
  let closest=null, minDist=80;
  npcs.forEach(n=>{
    const d=Math.abs(GS.px-parseFloat(n.style.left));
    if(d<minDist){minDist=d;closest=n;}
  });
  if(closest) closest.click();
});
$('m-inv').addEventListener('click',toggleInventory);

// HUD buttons
$('music-btn').addEventListener('click',()=>{initAudio();toggleMusic();});
$('inv-btn').addEventListener('click',toggleInventory);
$('skin-btn').addEventListener('click',()=>{
  const p=$('skin-panel');
  p.style.display=p.style.display==='block'?'none':'block';
});
document.querySelectorAll('.skin-option').forEach(b=>{
  b.addEventListener('click',()=>applySkin(b.dataset.skin));
});
$('restart-btn').addEventListener('click',restartGame);

// Start
$('start-btn').addEventListener('click',()=>{
  initAudio();
  $('title-screen').style.display='none';
  $('hud').style.display='flex';
  showChapter(1,'ch1_orphanage',200);
  gameLoop();
});

// Load saved skin
const savedSkin=localStorage.getItem('ggg-skin');
if(savedSkin) applySkin(savedSkin);

// Fade in/out animation for notifications
const style=document.createElement('style');
style.textContent='@keyframes fadeInOut{0%{opacity:0;transform:translateX(-50%) translateY(-10px);}15%{opacity:1;transform:translateX(-50%) translateY(0);}85%{opacity:1;}100%{opacity:0;}}';
document.head.appendChild(style);
</script>
</body>
</html>
